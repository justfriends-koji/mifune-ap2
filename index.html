<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ä¸‰èˆ¹ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ POS & ãƒ¢ãƒã‚¤ãƒ«ã‚ªãƒ¼ãƒ€ãƒ¼</title>
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<script src="StarWebPrintBuilder.js"></script>
<script src="StarWebPrintTrader.js"></script>
<style>
:root { --primary: #f39c12; --secondary: #fbb03b; --bg: #f8f8f8; --text: #333; --accent: #2ecc71; --gray: #999; --danger: #e74c3c; --info: #3498db; --dark: #444; }
* { touch-action: manipulation; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
body { font-family: sans-serif; margin: 0; background: var(--bg); color: var(--text); -webkit-user-select: none; overflow: hidden; height: 100vh; height: 100dvh; }
header { background: #fff; padding: 0 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; font-weight: bold; height: 55px; flex-shrink: 0; }
.header-left { display: flex; align-items: center; gap: 10px; }
.back-btn { text-decoration: none; color: var(--text); font-size: 26px; cursor: pointer; padding: 10px 5px; }
.reload-btn { font-size: 28px; cursor: pointer; padding: 10px; color: var(--primary); font-weight: bold; }
.admin-btn { font-size: 13px; cursor: pointer; padding: 8px 15px; border: 1px solid var(--primary); border-radius: 25px; color: var(--primary); background: #fff; white-space: nowrap; }
.view { display: none; height: 100vh; height: 100dvh; width: 100vw; flex-direction: column; position: absolute; top: 0; left: 0; background: var(--bg); }
.view.active { display: flex; }
.grid-tables { display: grid; grid-template-columns: repeat(3, 1fr); grid-auto-rows: min-content; gap: 10px; padding: 15px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
.table-btn { background: #fff; border: 2px solid var(--accent); padding: 15px 5px; text-align: center; border-radius: 12px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.05); min-height: 95px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
.table-btn.occupied { background: #e8f5e9; border-color: #27ae60; }
.price-badge { display: block; font-size: 11px; color: #e67e22; margin-top: 5px; font-weight: bold; }
.login-container { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 25px; background: #fff; }
.login-title { font-size: 24px; font-weight: bold; margin-bottom: 40px; color: var(--dark); }
.login-input { width: 100%; max-width: 450px; padding: 25px; margin-bottom: 25px; border: 3px solid #ddd; border-radius: 18px; font-size: 28px; background: #fafafa; -webkit-appearance: none; }
.guest-input-container { text-align: center; padding: 20px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; justify-content: center; }
.guest-num-display { font-size: 60px; font-weight: bold; margin-bottom: 20px; color: var(--primary); background: #eee; border-radius: 15px; padding: 15px; width: 100%; max-width: 400px; margin-left: auto; margin-right: auto; }
.keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; max-width: 450px; margin: 0 auto; }
.key-btn { background: #fff; border: 1px solid #ddd; padding: 25px 0; font-size: 32px; font-weight: bold; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; }
.menu-container { display: flex; flex: 1; overflow: hidden; }
.sidebar { width: 105px; background: #f0f0f0; overflow-y: auto; border-right: 1px solid #ddd; flex-shrink: 0; box-sizing: border-box; padding-bottom: 150px !important; }
.cat { padding: 20px 8px; font-size: 13px; text-align: center; border-bottom: 1px solid #ddd; cursor: pointer; color: #555; line-height: 1.4; }
.cat.active { background: #fff; color: var(--primary); font-weight: bold; border-left: 6px solid var(--primary); }
.item-grid { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; align-content: start; background: #fff; padding-bottom: 150px !important; }
.item-card { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 12px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 2px 8px rgba(0,0,0,0.06); min-height: 170px; }
.item-name { font-weight: bold; font-size: 14px; height: 2.8em; overflow: hidden; line-height: 1.4; margin-bottom: 5px; }
.item-price { color: #e67e22; font-weight: bold; font-size: 15px; margin-bottom: 8px; }
.qty-ctrl { display: flex; align-items: center; justify-content: space-between; border-top: 1px solid #f0f0f0; padding-top: 10px; }
.btn-circle { width: 38px; height: 38px; border-radius: 50%; border: 1px solid #ccc; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; }
.btn-add { background: var(--primary); color: #fff; border: none; padding: 12px 0; border-radius: 25px; font-size: 15px; font-weight: bold; flex: 1; margin-left: 10px; box-shadow: 0 3px 6px rgba(243,156,18,0.3); }
footer { width: 100%; display: flex; flex-direction: column; z-index: 100; box-shadow: 0 -3px 10px rgba(0,0,0,0.1); flex-shrink: 0; }
.footer-history { background: var(--dark); color: #fff; padding: 10px 15px; display: flex; justify-content: space-between; font-size: 14px; cursor: pointer; }
.footer-cart { background: var(--secondary); color: #fff; padding: 18px 15px; display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; cursor: pointer; }
.list-container { flex: 1; overflow-y: auto; background: #fff; -webkit-overflow-scrolling: touch; padding-bottom: 100px; }
.list-row { display: flex; justify-content: space-between; padding: 18px; border-bottom: 1px solid #eee; align-items: center; }
.summary-area { padding: 15px 25px; text-align: right; background: #fff; border-top: 2px solid #eee; flex-shrink: 0; line-height: 1.6; font-size: 15px; }
.btn-large { width: 90%; display: block; margin: 10px auto; padding: 20px; border: none; border-radius: 40px; font-size: 20px; font-weight: bold; cursor: pointer; text-align: center; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

/* ç®¡ç†ç”»é¢ã‚¹ã‚¿ã‚¤ãƒ« */
.admin-nav { display: flex; background: #fff; border-bottom: 1px solid #ddd; flex-shrink: 0; }
.admin-nav-btn { flex: 1; padding: 15px; text-align: center; font-size: 14px; font-weight: bold; color: #888; cursor: pointer; border-bottom: 3px solid transparent; }
.admin-nav-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
.sale-card { background: #fff; margin: 12px; padding: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative; border-left: 10px solid var(--info); }
.sale-time-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
.sale-time { font-size: 18px; font-weight: bold; color: var(--dark); }
.sale-table-badge { background: #eee; padding: 4px 10px; border-radius: 8px; font-size: 14px; font-weight: bold; }
.sale-detail-info { font-size: 14px; color: #666; margin-bottom: 10px; }
.sale-total-line { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
.sale-price-big { font-size: 24px; font-weight: bold; color: var(--primary); }
.btn-del-sale { background: var(--danger); color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; }
.report-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 15px; background: #fff; border-bottom: 1px solid #ddd; flex-shrink: 0; }
.btn-report { background: var(--info); color: #fff; border: none; padding: 22px 0; border-radius: 12px; font-weight: bold; font-size: 17px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; }
.overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; justify-content: center; align-items: center; padding: 20px 0; }
.modal { background: #fff; width: 90%; max-width: 340px; border-radius: 20px; padding: 20px; text-align: center; position: relative; max-height: 90dvh; overflow-y: auto; }
.receipt-sample { background: #fff; padding: 15px; color: #000; font-family: monospace; text-align: left; font-size: 11px; border: 1px dashed #ccc; width: 100%; }
.receipt-hr { border-top: 1px dashed #000; margin: 5px 0; }
</style>
</head>
<body>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, addDoc, query, orderBy, getDocs, where, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyDscuD0S3D66lcamtG4T26WLfZH8rjOy28",
    authDomain: "mifune-ap2.firebaseapp.com",
    projectId: "mifune-ap2",
    storageBucket: "mifune-ap2.firebasestorage.app",
    messagingSenderId: "25505732783",
    appId: "1:25505732783:web:47278f159ad7a26f279c5a",
    measurementId: "G-7F8BM4SBGR"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

window.currentUser = null;
window.isEditing = false;

onAuthStateChanged(auth, (user) => {
    window.currentUser = user;
    const btnLabel = document.getElementById('admin-btn-label');
    if(user) {
        btnLabel.innerText = "å£²ä¸Šç®¡ç†(åº—ä¸»)";
        btnLabel.style.background = "#e8f5e9";
    } else {
        btnLabel.innerText = "å£²ä¸Šç®¡ç†";
        btnLabel.style.background = "#fff";
    }
});

// --- Firebase ç›£è¦–ãƒ­ã‚¸ãƒƒã‚¯ (è‡ªå‹•å°åˆ·æ©Ÿèƒ½ä»˜ã) ---
onSnapshot(collection(db, "tables"), async (snapshot) => {
    if(window.isEditing) return;
    const tablesList = ['C-a', 'C-b', 'C-c', '01', '02', '03', '04', '05', '06', '07', 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ', 'ç„¡äºº'];
    
    // ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã®ç¢ºèª
    for (const change of snapshot.docChanges()) {
        const tId = change.doc.id;
        const data = change.doc.data();
        
        if (change.type === "added" || change.type === "modified") {
            const history = data.history || [];
            
            // æœªå°åˆ·(printed: false)ã®æ³¨æ–‡ã‚’æŠ½å‡º
            const unprintedItems = history.filter(item => item.printed === false);

            if (unprintedItems.length > 0) {
                // å°åˆ·å®Ÿè¡Œ (åº—å†…ãƒ¡ã‚¤ãƒ³ç«¯æœ«ã®ã¿æœ‰åŠ¹)
                const success = await executeAutoPrint(tId, unprintedItems);

                if (success) {
                    // å°åˆ·æˆåŠŸã—ãŸã‚‰Firebaseå´ã®ãƒ•ãƒ©ã‚°ã‚’æ›´æ–°
                    const updatedHistory = history.map(item => ({ ...item, printed: true }));
                    await setDoc(doc(db, "tables", tId), { history: updatedHistory }, { merge: true });
                }
            }

            // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
            localStorage.setItem('history_'+tId, JSON.stringify(history));
            localStorage.setItem('guests_'+tId, data.guests || 0);
            localStorage.setItem('checkin_'+tId, data.checkin || "--:--");
        }
        
        if (change.type === "removed") {
            localStorage.removeItem('history_'+tId); 
            localStorage.removeItem('guests_'+tId); 
            localStorage.removeItem('checkin_'+tId);
        }
    }
    renderIndex(); updateFooter();
});

// --- ã‚¯ãƒ©ã‚¦ãƒ‰é€ä¿¡ (ãƒ¢ãƒã‚¤ãƒ«ã‚ªãƒ¼ãƒ€ãƒ¼å¯¾å¿œ) ---
window.sendToKitchen = async () => {
    if(currentCart.length === 0) return;

    // ã‚«ãƒ¼ãƒˆå†…ã‚¢ã‚¤ãƒ†ãƒ ã«ã€Œæœªå°åˆ·ãƒ•ãƒ©ã‚°ã€ã‚’ä»˜ä¸
    const newOrders = currentCart.map(item => ({
        ...item,
        printed: false,
        orderedAt: new Date().toISOString()
    }));

    try {
        const tableRef = doc(db, "tables", currentTable);
        const currentHist = JSON.parse(localStorage.getItem('history_' + currentTable) || '[]');
        const updatedHist = currentHist.concat(newOrders);

        // Firebaseæ›´æ–° (ã“ã‚ŒãŒåº—å†…ã®è¦ªæ©Ÿã«é€šçŸ¥ã•ã‚Œã‚‹)
        await setDoc(tableRef, {
            history: updatedHist,
            guests: parseInt(localStorage.getItem('guests_' + currentTable)) || 0,
            checkin: localStorage.getItem('checkin_' + currentTable) || "--:--",
            updatedAt: Timestamp.now()
        }, { merge: true });

        // ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
        localStorage.setItem('history_' + currentTable, JSON.stringify(updatedHist));
        localStorage.removeItem('cart_' + currentTable);
        currentCart = [];
        
        hideAll();
        document.getElementById('view-success').style.display = 'flex';
        updateFooter();
    } catch (e) {
        alert("é€ä¿¡å¤±æ•—ã€‚é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        console.error(e);
    }
};

// --- ãã®ä»– Firebase ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
window.loginOwner = async (email, pass) => {
    try { await signInWithEmailAndPassword(auth, email, pass); alert("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ"); showAdmin('day'); } 
    catch(e) { alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—"); }
};
window.logoutOwner = () => { signOut(auth); alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ"); showIndex(); };
window.cloudSync = async (tableId) => {
    await setDoc(doc(db, "tables", tableId), {
        history: JSON.parse(localStorage.getItem('history_' + tableId) || '[]'),
        guests: parseInt(localStorage.getItem('guests_' + tableId)) || 0,
        checkin: localStorage.getItem('checkin_' + tableId) || "--:--",
        updatedAt: Timestamp.now()
    }, { merge: true });
};
window.saveSaleToCloud = async (tableId) => {
    const hist = JSON.parse(localStorage.getItem('history_' + tableId) || '[]');
    if(hist.length === 0) return;
    const guests = parseInt(localStorage.getItem('guests_' + tableId)) || 0;
    const checkin = localStorage.getItem('checkin_' + tableId) || "--:--";
    let subtotal = 0, tax = 0;
    hist.forEach(i => { subtotal += i.price * i.qty; tax += Math.floor(i.price * i.qty * i.rate); });
    try {
        await addDoc(collection(db, "sales"), {
            tableId, guests, checkin,
            checkout: new Date().getHours().toString().padStart(2, '0') + ":" + new Date().getMinutes().toString().padStart(2, '0'),
            items: hist, subtotal, tax, total: subtotal + tax, timestamp: Timestamp.now()
        });
        await deleteDoc(doc(db, "tables", tableId));
    } catch (e) { console.error("Save error", e); }
};
window.getSalesData = async (mode) => {
    const snap = await getDocs(collection(db, "sales"));
    let res = [];
    snap.forEach(d => { let data = d.data(); data.id = d.id; res.push(data); });
    return res.sort((a,b) => b.timestamp - a.timestamp);
};
</script>

<div id="view-index" class="view active"><header><div class="admin-btn" id="admin-btn-label" onclick="checkAdminAuth()">å£²ä¸Šç®¡ç†</div><span>ä¸‰èˆ¹ å¸­é¸æŠ</span><div class="reload-btn" onclick="location.reload()">â†»</div></header><div class="grid-tables" id="table-grid"></div></div>

<div id="view-login" class="view">
<header><div class="header-left"><span class="back-btn" onclick="showIndex()">ï¼œ</span><span>èªè¨¼</span></div></header>
<div class="login-container"><div style="font-weight:bold; margin-bottom:20px;">ã‚ªãƒ¼ãƒŠãƒ¼ãƒ­ã‚°ã‚¤ãƒ³</div><input type="email" id="login-email" class="login-input" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"><input type="password" id="login-pass" class="login-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"><button class="btn-large" style="background:var(--primary); color:white; margin-top:20px;" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦è¡¨ç¤º</button></div>
</div>

<div id="view-admin" class="view">
<header><div class="header-left"><span class="back-btn" onclick="showIndex()">ï¼œ</span><span>å£²ä¸Šç®¡ç†</span></div><div style="font-size:12px; color:var(--danger);" onclick="logoutOwner()">çµ‚äº†</div></header>
<div class="admin-nav"><div id="nav-day" class="admin-nav-btn active" onclick="showAdmin('day')">æœ¬æ—¥</div><div id="nav-dates" class="admin-nav-btn" onclick="showAdmin('dates')">æ—¥åˆ¥</div><div id="nav-dow" class="admin-nav-btn" onclick="showAdmin('dow')">æ›œæ—¥åˆ¥</div><div id="nav-month" class="admin-nav-btn" onclick="showAdmin('month')">æœˆåˆ¥</div></div>
<div id="month-selector-area" style="display:none; align-items:center; gap:10px; background:#fff; padding:10px 15px; border-bottom:1px solid #ddd;">
  <span style="font-size:13px; color:#666;">è¡¨ç¤ºæœˆï¼š</span>
  <select id="month-selector" onchange="showAdmin('month')" style="padding:8px 12px; border:1px solid #ddd; border-radius:8px; font-size:15px; flex:1;"></select>
</div>
<div id="admin-summary-area" style="padding:15px; background:var(--dark); color:#fff; display:flex; justify-content:space-around; text-align:center; font-size:13px;"><div>ä»¶æ•°<br><span id="sum-count" style="font-size:20px; font-weight:bold;">0</span></div><div>å®¢æ•°<br><span id="sum-guests" style="font-size:20px; font-weight:bold;">0</span></div><div>åˆè¨ˆ<br>Â¥<span id="sum-total" style="font-size:20px; font-weight:bold;">0</span></div></div>
<div class="report-btns"><button class="btn-report" onclick="printReport('day')">æ—¥è¨ˆå°åˆ·</button><button class="btn-report" onclick="printReport('month')" style="background:var(--accent);">æœˆè¨ˆå°åˆ·</button></div>
<div class="list-container" id="sales-list" style="background:#f4f4f4; padding:5px 0;"></div>
</div>

<div id="view-guest" class="view"><header><span class="back-btn" onclick="showIndex()">ï¼œ</span>å®¢æ•°å…¥åŠ›</header><div class="guest-input-container"><h2 id="guest-table-name"></h2><div class="guest-num-display"><span id="guest-count-val">0</span> å</div><div class="keypad" id="guest-keypad"></div></div></div>
<div id="view-menu" class="view">
<header><span class="back-btn" onclick="showIndex()">Ã—</span><span id="display-table-id"></span>ç•ªå¸­ (<span id="display-guest-count"></span>å)<span style="margin-left:auto; font-size:11px; color:#666;">å…¥åº—: <span id="display-checkin-time"></span></span></header>
<div class="menu-container"><div class="sidebar" id="side-cats"></div><div class="item-grid" id="display-items"></div></div>
<footer><div class="footer-history" onclick="showOrderHistory()"><span>æ³¨æ–‡æ¸ˆåˆè¨ˆ</span><span id="display-current-total">Â¥0</span></div><div class="footer-cart" onclick="showCart()"><div>ğŸ›’ <span id="cart-count">0</span>ç‚¹</div><div>æ³¨æ–‡ã‚’ç¢ºèª ï¼</div></div></footer>
</div>
<div id="view-cart" class="view"><header><span class="back-btn" onclick="exitEditing()">ï¼œ</span>ã‚«ãƒ¼ãƒˆç¢ºèª</header><div class="list-container" id="cart-items-list"></div><div style="background:#fff; border-top:1px solid #eee; padding-bottom:10px;"><button class="btn-large" style="background:var(--info); color:white;" onclick="testSend()">é€ä¿¡(åŒæœŸã®ã¿)</button><button class="btn-large" style="background:var(--primary);color:white;" onclick="sendToKitchen()">æœ¬ç•ªé€ä¿¡</button></div></div>
<div id="view-history" class="view"><header><span class="back-btn" onclick="exitEditing()">ï¼œ</span>ä¿®æ­£</header><div class="list-container" id="history-items-list"></div><div class="summary-area" id="history-summary"></div><div style="background:#fff; border-top:1px solid #ddd; padding-bottom:10px;"><button class="btn-large" style="background:var(--accent); color:white;" onclick="confirmHistoryChange()">ä¿å­˜ã—ã¦åŒæœŸ</button><button class="btn-large" style="background:var(--secondary); color:white;" onclick="showCheckout()">ãŠä¼šè¨ˆç¢ºå®šã¸</button></div></div>
<div id="view-checkout" class="view"><header><span class="back-btn" onclick="showOrderHistory()">ï¼œ</span>ä¼šè¨ˆç¢ºå®š</header><div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;"><div style="padding:30px 20px; background:#fff; border-radius:15px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.1); width:85%;"><div id="checkout-final-total" style="font-size:40px; font-weight:bold; color:var(--primary);">Â¥0</div><div id="checkout-final-info" style="color:#666; font-size:12px;"></div></div></div><button class="btn-large" style="background:var(--info); color:white;" onclick="testPay()">ã€ãƒ†ã‚¹ãƒˆã€‘ä¼šè¨ˆå®Œäº†</button><button class="btn-large" style="background:var(--accent);color:white;" onclick="openReceiptChoice()">æœ¬ç•ªä¼šè¨ˆ</button><button class="btn-large" style="background:#8e44ad; color:white;" onclick="openRyoshuusho()">ğŸ“„ é ˜åæ›¸ç™ºè¡Œ</button></div>

<div id="overlay-receipt" class="overlay"><div class="modal"><div id="receipt-preview-area" style="display:none;"><div class="modal-title">å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div><div id="sample-receipt-content" class="receipt-sample"></div></div><div class="modal-title">å°åˆ·ã—ã¾ã™ã‹ï¼Ÿ</div><button class="btn-large" style="background:var(--primary); color:white;" onclick="pay(true)">å°åˆ·ã—ã¦å®Œäº†</button><button class="btn-large" style="background:var(--gray); color:white;" onclick="pay(false)">å°åˆ·ã›ãšã«å®Œäº†</button><div style="margin-top:15px; color:var(--info); font-size:12px; cursor:pointer;" onclick="closeReceiptChoice()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div></div></div>
<div id="view-success" class="view" style="text-align:center; justify-content:center;"><h2>é€ä¿¡å®Œäº†</h2><button class="btn-large" style="background:var(--primary);color:white;" onclick="showMenu()">æˆ»ã‚‹</button></div>

<div id="overlay-ryoshuusho" class="overlay">
  <div class="modal">
    <div style="font-weight:bold; font-size:18px; margin-bottom:15px;">ğŸ“„ é ˜åæ›¸ç™ºè¡Œ</div>
    <input type="text" id="ryoshuusho-atena" placeholder="å®›åï¼ˆç©ºç™½ã§ä¸Šæ§˜ï¼‰" class="login-input" style="font-size:18px; padding:15px;">
    <input type="text" id="ryoshuusho-tadashi" placeholder="ä½†ã—æ›¸ãï¼ˆãŠé£Ÿäº‹ä»£ã¨ã—ã¦ï¼‰" class="login-input" style="font-size:18px; padding:15px;">
    <div id="ryoshuusho-preview" class="receipt-sample" style="margin-bottom:15px;"></div>
    <button class="btn-large" style="background:var(--primary); color:white;" onclick="printRyoshuusho()">å°åˆ·ã™ã‚‹</button>
    <button class="btn-large" style="background:var(--gray); color:white;" onclick="closeRyoshuusho()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
// å•†å“ãƒ‡ãƒ¼ã‚¿ (æ—¢å­˜ãƒªã‚¹ãƒˆ)
const rawData = [
    ["ãŠé€šã—", "ãŠé€šã—", 300], ["ã‚‚ã¤ä¸²", "ç¾å”„ç„¼é³¥", 150], ["é³¥ç²¾è‚‰", "ç¾å”„ç„¼é³¥", 170], ["é£²ã¿æ”¾é¡Œç”·æ€§90åˆ†", "é£²ã¿æ”¾é¡Œ", 2280], ["é£²ã¿æ”¾é¡Œå¥³æ€§90åˆ†", "é£²ã¿æ”¾é¡Œ", 1980], ["é£²ã¿æ”¾é¡Œå»¶é•·", "é£²ã¿æ”¾é¡Œ", 800], ["æ‰‹ç¾½ç„¼ãï¼ˆ2æœ¬ï¼‰", "ç„¼ãç‰©", 400], ["å›½ç”£è±šã®ãƒ­ãƒ¼ã‚¹ç¶²ç„¼ãã‚¹ãƒ†ãƒ¼ã‚­", "ç„¼ãç‰©", 600], ["ãƒãƒ¼ãƒ•è±šã®ç¶²ç„¼ãã‚¹ãƒ†ãƒ¼ã‚­ï¼ˆ1æšï¼‰", "ç„¼ãç‰©", 700], ["ãƒãƒ¼ãƒ•è±šã®ç‚™ã‚Šãƒãƒ£ãƒ¼ã‚·ãƒ¥ãƒ¼", "ç„¼ãç‰©", 600], ["è‡ªå®¶è£½ã¤ãã­ã®ã‚³ãƒ­ã‚³ãƒ­ç„¼ãï¼ˆ4ç‰ï¼‰", "ç„¼ãç‰©", 400], ["ã•ã•ã¿ä¸²ç„¼ãï¼ˆæ•°é‡é™å®š 1ä¸²ï¼‰", "ç„¼ãç‰©", 250], ["é´¨è‚‰ã®ç¶²ç„¼ã", "ç„¼ãç‰©", 600], ["ãƒ”ãƒªè¾›ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸ï¼ˆ2æœ¬ï¼‰", "ç„¼ãç‰©", 400], ["ãƒ©ãƒ ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸ï¼ˆ2æœ¬ï¼‰", "ç„¼ãç‰©", 500], ["ã†ãšã‚‰ã®ç‰å­ï¼ˆ1ä¸²ï¼‰", "ç„¼ãç‰©", 150], ["è‚‰åšã—ã„ãŸã‘ï¼ˆ2å€‹ï¼‰", "ç„¼ãç‰©", 300], ["ãƒ—ãƒãƒˆãƒãƒˆï¼ˆ1ä¸²ï¼‰", "ç„¼ãç‰©", 150], ["ã‚ºãƒƒã‚­ãƒ¼ãƒ‹ï¼ˆ1ä¸²ï¼‰", "ç„¼ãç‰©", 150], ["é•·ãªã™ä¸²ç„¼ãï¼ˆ1ä¸²ï¼‰", "ç„¼ãç‰©", 300], ["è»Ÿç™½ã­ãï¼ˆ1ä¸²ï¼‰", "ç„¼ãç‰©", 300], ["ã—ã—ã¨ã†ï¼ˆ2ä¸²ï¼‰", "ç„¼ãç‰©", 300], ["ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«ã«ã‚“ã«ãã‚«ãƒƒãƒ—ç„¼ã", "ç„¼ãç‰©", 500], ["ç„¼ãã˜ã‚ƒãŒãƒã‚¿ãƒ¼ï¼ˆ2å€‹ï¼‰", "ç„¼ãç‰©", 500], ["ç„¼ãã˜ã‚ƒãŒãƒã‚¿ãƒ¼ï¼ˆå¡©è¾›ä»˜ãï¼‰ï¼ˆ2å€‹ï¼‰", "ç„¼ãç‰©", 600], ["ã„ã‚‚ã‚‚ã¡ãƒã‚¿ãƒ¼ï¼ˆ4å€‹ï¼‰", "ç„¼ãç‰©", 400], ["ã•ã•ã¿ä¸²ï¼ˆè‡ªå®¶è£½å¡©ã“ã†ã˜æ¼¬ã‘ï¼‰", "ç„¼ãç‰©", 300], ["ãƒ­ãƒ¼ã‚¹ç¶²ç„¼ãã‚¹ãƒ†ãƒ¼ã‚­ï¼ˆè‡ªå®¶è£½å¡©ã“ã†ã˜æ¼¬ã‘ï¼‰", "ç„¼ãç‰©", 750], ["é³¥ã‚‚ã¤ç…®è¾¼ã¿", "ä¸€å“æ–™ç†", 400], ["ç‰¹è£½ä¸€å£ã‚¶ãƒ³ã‚®", "ä¸€å“æ–™ç†", 550], ["æ‰‹ç¾½ã‚¶ãƒ³ã‚®(3æœ¬)", "ä¸€å“æ–™ç†", 550], ["è‹¥é¶ã®çš®ç«œç”°æšã’(ãŠã‚ã—ãƒãƒ³é…¢ä»˜ã)", "ä¸€å“æ–™ç†", 550], ["ã‚µã‚µãƒŸã‚«ãƒ„(2æš)", "ä¸€å“æ–™ç†", 600], ["å›½ç”£è±šã®ãƒ­ãƒ¼ã‚¹ã‚«ãƒ„", "ä¸€å“æ–™ç†", 700], ["ã‚³ãƒ¼ãƒ³ãƒã‚¿ãƒ¼ãƒ»ãƒãƒ¼ã‚ºã‚«ãƒƒãƒ—", "ä¸€å“æ–™ç†", 500], ["ç”Ÿãƒãƒ ã®è»Ÿç™½ã­ãåŒ…ã¿(å²©å¡©ä»˜ã)", "ä¸€å“æ–™ç†", 650], ["å¡©ã‚­ãƒ£ãƒ™ã‚­ãƒ¥", "ä¸€å“æ–™ç†", 350], ["æ¼¬ç‰©", "ä¸€å“æ–™ç†", 350], ["æè±†", "ä¸€å“æ–™ç†", 350], ["å†·å¥´", "ä¸€å“æ–™ç†", 400], ["å±±ã‚ã•ã³å†·å¥´", "ä¸€å“æ–™ç†", 400], ["ãªã‚ã“ãŠã‚ã—", "ä¸€å“æ–™ç†", 400], ["ã‚«ãƒ‹ã¿ãã¨ã†ãµ", "ä¸€å“æ–™ç†", 400], ["ãƒãƒ£ãƒ³ã‚¸ãƒ£", "ä¸€å“æ–™ç†", 400], ["ã‚¤ã‚«ã®å¡©è¾›", "ä¸€å“æ–™ç†", 400], ["ãŸã“ã‚ã•ã³", "ä¸€å“æ–™ç†", 400], ["ã»ãŸã¦ã‚ã•ã³", "ä¸€å“æ–™ç†", 400], ["æ•°ã®å­å…¥ã‚Šæ¾å‰æ¼¬ã‘", "ä¸€å“æ–™ç†", 400], ["ã‚¯ã‚¸ãƒ©ã®ãƒ™ãƒ¼ã‚³ãƒ³ ã­ãæ­£æ²¹ã‚ãˆ", "ä¸€å“æ–™ç†", 700], ["è‡ªå®¶è£½ãƒ‘ãƒ³ãƒã‚§ãƒƒã‚¿ã¨ãƒ¡ãƒ¼ã‚¯ã‚¤ãƒ³ã®ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«ãƒ»ãƒãƒ¼ã‚ºç†±æ¹¯é¢¨å‘‚", "ã‚ªãƒªã‚¸ãƒŠãƒ«", 700], ["è‡ªå®¶è£½ãƒ‘ãƒ³ãƒã‚§ãƒƒã‚¿ã¨ã‚³ãƒ¼ãƒ³ã®ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«ãƒ»ãƒãƒ¼ã‚ºç†±æ¹¯é¢¨å‘‚", "ã‚ªãƒªã‚¸ãƒŠãƒ«", 700], ["ãƒãƒ£ãƒ³ã‚¸ãƒ£ã¨ã‚¯ãƒªãƒ¼ãƒ ãƒãƒ¼ã‚ºã®ã‚¿ãƒ‘ã‚¹(ãŠã¤ã¾ã¿æ–™ç†)", "ã‚ªãƒªã‚¸ãƒŠãƒ«", 700], ["ãƒãƒ¼ãƒ–è±šãƒãƒ£ãƒ¼ã‚·ãƒ¥ãƒ¼ã¨ãƒãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ ã®ã‚¢ãƒ’ãƒ¼ã‚¸ãƒ§", "ã‚ªãƒªã‚¸ãƒŠãƒ«", 700], ["ç ‚è‚ã¨ãƒãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ ã®ã‚¢ãƒ’ãƒ¼ã‚¸ãƒ§", "ã‚ªãƒªã‚¸ãƒŠãƒ«", 700], ["ã‚¿ã‚³ã¨ãƒãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ ã®ã‚¢ãƒ’ãƒ¼ã‚¸ãƒ§", "ã‚ªãƒªã‚¸ãƒŠãƒ«", 700], ["ãƒ”ãƒªè¾›ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸ã¨ãƒãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ ã®ã‚¢ãƒ’ãƒ¼ã‚¸ãƒ§", "ã‚ªãƒªã‚¸ãƒŠãƒ«", 700], ["ãƒãƒ³ã‚º", "ã‚ªãƒªã‚¸ãƒŠãƒ«", 100], ["ã¾ãã‚åˆºã—(æ•°é‡é™å®š)", "åˆºèº«", 700], ["ã¨ã‚ã—ã‚ã•ã°", "åˆºèº«", 600], ["ãŸã“é ­åˆºã—", "åˆºèº«", 600], ["é¦¬åˆºã—(èµ¤èº«)", "åˆºèº«", 800], ["é¦¬è‚‰ãƒ¦ãƒƒã‚±", "åˆºèº«", 850], ["ã‚¨ã‚¤ãƒ’ãƒ¬", "å¹²ç‰©", 400], ["ã“ã¾ã„ä¸€å¤œå¹²ã—", "å¹²ç‰©", 600], ["ã—ã—ã‚ƒã‚‚", "å¹²ç‰©", 500], ["é®­ã¨ã°", "å¹²ç‰©", 500], ["ã™ã‚‹ã‚ã„ã‹", "å¹²ç‰©", 450], ["ãŸã‚‰ã“ç„¼ã", "å¹²ç‰©", 450], ["é³¥ã‚‚ã¤é‹(ä¸€äººå‰)", "é‹ç‰©", 1400], ["è¾›é³¥ã‚‚ã¤é‹(ä¸€äººå‰)", "é‹ç‰©", 1500], ["é´¨é‹(ä¸€äººå‰)", "é‹ç‰©", 1300], ["æ¹¯ã©ã†ãµ(ä¸€äººå‰)", "é‹ç‰©", 800], ["ã€è¿½åŠ ã€‘å˜å“é‡èœ", "é‹ç‰©", 500], ["ã€è¿½åŠ ã€‘å˜å“ã‚‚ã¤é¡", "é‹ç‰©", 800], ["ã€è¿½åŠ ã€‘é›‘ç‚Šã‚»ãƒƒãƒˆ", "é‹ç‰©", 350], ["ã€è¿½åŠ ã€‘å˜å“ãã°", "é‹ç‰©", 300], ["å†·ã—ãƒˆãƒãƒˆ", "ã‚µãƒ©ãƒ€", 400], ["ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚µãƒ©ãƒ€", "ã‚µãƒ©ãƒ€", 600], ["ãƒ„ãƒŠã‚µãƒ©ãƒ€", "ã‚µãƒ©ãƒ€", 700], ["ç”Ÿãƒãƒ ã‚µãƒ©ãƒ€", "ã‚µãƒ©ãƒ€", 800], ["ã‚‚ãšãé…¢", "é…¢ã®ç‰©", 350], ["ãƒ”ã‚¯ãƒ«ã‚¹ã®ç››ã‚Šåˆã‚ã›", "é…¢ã®ç‰©", 550], ["ç¾å”„åç‰©ã¨ã‚Šã‚ã—", "ã”é£¯ç‰©", 400], ["ã‚„ãã¨ã‚Šä¸¼ã¶ã‚Š", "ã”é£¯ç‰©", 650], ["ã‚‚ã¤ç…®è¾¼ã¿ä¸¼ã¶ã‚Š", "ã”é£¯ç‰©", 650], ["ç‚™ã‚Šãƒãƒ£ãƒ¼ã‚·ãƒ¥ãƒ¼ä¸¼ã¶ã‚Š", "ã”é£¯ç‰©", 700], ["ä¸‰èˆ¹ç‰¹è£½ã‚ªãƒ ãƒ©ã‚¤ã‚¹", "ã”é£¯ç‰©", 700], ["å±±ã‚ã•ã³ä¸¼ã¶ã‚Š", "ã”é£¯ç‰©", 400], ["ãƒ©ã‚¤ã‚¹(å°)", "ã”é£¯ç‰©", 200], ["ãƒ©ã‚¤ã‚¹(å¤§)", "ã”é£¯ç‰©", 300], ["ä¸‰èˆ¹åç‰©é³¥ãŒã‚‰ãã°", "éººé¡", 450], ["ä¸‰èˆ¹ç‰¹è£½ãƒ©ãƒ¼ãƒ¡ãƒ³(æ­£æ²¹å‘³ã®ã¿)", "éººé¡", 750], ["ä¸‰èˆ¹ç‰¹è£½ãƒãƒ£ãƒ¼ã‚·ãƒ¥ãƒ¼ãƒ¡ãƒ³", "éººé¡", 900], ["ãƒã‚¿ãƒ¼ã‚³ãƒ¼ãƒ³ãƒ©ãƒ¼ãƒ¡ãƒ³", "éººé¡", 900], ["ã‚‚ã¤ãã°(æ¸©)", "éººé¡", 600], ["ã‚‚ã¤ã›ã„ã‚ãã°(å†·)", "éººé¡", 600], ["é³¥ã›ã„ã‚ãã°(å†·)", "éººé¡", 600], ["ã‹ã—ã‚ãã°(æ¸©)", "éººé¡", 600], ["å†·ã‚€ã(å¤æœŸ)", "éººé¡", 500], ["ã‚¹ãƒ¼ãƒ—(ç‰å­)", "ã‚¹ãƒ¼ãƒ—", 300], ["ã‚¹ãƒ¼ãƒ—(ã‚ã‹ã‚)", "ã‚¹ãƒ¼ãƒ—", 300], ["ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ‰ãƒ©ã‚¤ ã€ˆå°ã€‰", "ãƒ“ãƒ¼ãƒ«", 500], ["ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ‰ãƒ©ã‚¤ ã€ˆä¸­ã€‰", "ãƒ“ãƒ¼ãƒ«", 600], ["ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ‰ãƒ©ã‚¤ ã€ˆå¤§ã€‰", "ãƒ“ãƒ¼ãƒ«", 700], ["ã‚¢ã‚µãƒ’ ãƒãƒ«ã‚¨ãƒ• ã€ˆä¸­ç“¶ã€‰", "ãƒ“ãƒ¼ãƒ«", 700], ["ãƒ©ã‚¬ãƒ¼ ã€ˆä¸­ç“¶ã€‰", "ãƒ“ãƒ¼ãƒ«", 700], ["ãƒ›ãƒƒãƒ”ãƒ¼ ã‚»ãƒƒãƒˆã€ˆç™½ãƒ»é»’ã€‰", "ãƒ“ãƒ¼ãƒ«", 600], ["ãƒ›ãƒƒãƒ”ãƒ¼ã®ç„¼é…ã®ã¿", "ãƒ“ãƒ¼ãƒ«", 300], ["ã‚¢ã‚µãƒ’ãƒ‰ãƒ©ã‚¤ã‚¼ãƒ­ ã€ˆä¸­ç“¶ã€‰", "ãƒ“ãƒ¼ãƒ«", 500], ["ã‚½ãƒ©ãƒã‚¨ãƒ¼ã‚¹", "ãƒ“ãƒ¼ãƒ«", 800], ["ãƒã‚¤ãƒœãƒ¼ãƒ«", "ãƒã‚¤ãƒœãƒ¼ãƒ«", 500], ["ã‚³ãƒ¼ãƒ©ãƒã‚¤ãƒœãƒ¼ãƒ«", "ãƒã‚¤ãƒœãƒ¼ãƒ«", 550], ["ã‚¸ãƒ³ã‚¸ãƒ£ãƒ¼ãƒã‚¤ãƒœãƒ¼ãƒ«", "ãƒã‚¤ãƒœãƒ¼ãƒ«", 550], ["æ¢…é…’ãƒ­ãƒƒã‚¯", "æ¢…é…’", 500], ["æ¢…é…’ã‚½ãƒ¼ãƒ€", "æ¢…é…’", 500], ["ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500], ["ãƒ¬ãƒ¢ãƒ³ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500], ["ãƒ©ã‚¤ãƒ ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500], ["ã‚«ã‚·ã‚¹ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500], ["æ¢…ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500], ["ã‚°ãƒ¬ãƒ¼ãƒ—ãƒ•ãƒ«ãƒ¼ãƒ„ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500], ["ã¶ã©ã†ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500], ["é’ã‚Šã‚“ã”ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500], ["ã‚«ãƒ«ãƒ”ã‚¹ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500], ["ã‚·ãƒ¼ã‚¯ã‚¡ãƒ¼ã‚µãƒ¼ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500], ["ã‚¦ãƒ¼ãƒ­ãƒ³ãƒã‚¤", "ã‚µãƒ¯ãƒ¼", 500], ["ç·‘èŒ¶ãƒã‚¤", "ã‚µãƒ¯ãƒ¼", 500], ["ã‚³ãƒ¼ãƒ’ãƒ¼é…ãƒã‚¤", "ã‚µãƒ¯ãƒ¼", 500], ["ç”Ÿæ¾ã‚Šãƒ¬ãƒ¢ãƒ³ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 600], ["ç”Ÿæ¾ã‚Šã‚°ãƒ¬ãƒ¼ãƒ—ãƒ•ãƒ«ãƒ¼ãƒ„ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 600], ["ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³ï¼ˆèµ¤ï¼‰", "ãƒ¯ã‚¤ãƒ³", 500], ["ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³ï¼ˆç™½ï¼‰", "ãƒ¯ã‚¤ãƒ³", 500], ["ç„¼é…ç”²é¡ï¼ˆãƒ­ãƒƒã‚¯ãƒ»æ°´å‰²ã‚Šï¼‰", "ç„¼é…", 500], ["ã‚å…­ï¼ˆãã‚ãï¼‰ ã€ˆå®®å´ãƒ»èŠ‹ã€‰", "ç„¼é…", 700], ["å±±ã­ã“ ã€ˆå®®å´ãƒ»èŠ‹ã€‰", "ç„¼é…", 700], ["å±±ã›ã¿ ã€ˆå®®å´ãƒ»ç±³ã€‰", "ç„¼é…", 700], ["å±±çŒ¿ ã€ˆå®®å´ãƒ»éº¦ã€‰", "ç„¼é…", 700], ["ä¸­ã€… ã€ˆå®®å´ãƒ»éº¦ã€‰", "ç„¼é…", 700], ["é»’éœ§å³¶ ã€ˆå®®å´ãƒ»èŠ‹ã€‰", "ç„¼é…", 700], ["æµ· ã€ˆé¹¿å…å³¶ãƒ»èŠ‹ã€‰", "ç„¼é…", 700], ["ãã˜ã‚‰ ã€ˆé¹¿å…å³¶ãƒ»èŠ‹ã€‰", "ç„¼é…", 700], ["ã‚ˆã‚ã—ãåƒè¬ã‚ã‚‹ã¹ã— ã€ˆæ–°æ½Ÿãƒ»ç±³ã€‰", "ç„¼é…", 700], ["ãƒ‹ãƒƒã‚«ãƒ»ã‚¶ãƒ»éº¦ç„¼é… ã€ˆç¦å²¡ãƒ»éº¦ã€‰", "ç„¼é…", 700], ["é‡‘é»’ ã€ˆç¦å²¡ãƒ»èŠ‹ã€‰", "ç„¼é…", 700], ["ã‚«ã‚·ã‚¹ã‚½ãƒ¼ãƒ€", "ã‚«ã‚¯ãƒ†ãƒ«", 550], ["ã‚«ã‚·ã‚¹ã‚¦ãƒ¼ãƒ­ãƒ³", "ã‚«ã‚¯ãƒ†ãƒ«", 550], ["ã‚«ã‚·ã‚¹ã‚ªãƒ¬ãƒ³ã‚¸", "ã‚«ã‚¯ãƒ†ãƒ«", 550], ["ã‚«ã‚·ã‚¹ã‚°ãƒ¬ãƒ¼ãƒ—ãƒ•ãƒ«ãƒ¼ãƒ„", "ã‚«ã‚¯ãƒ†ãƒ«", 550], ["ã‚«ãƒ³ãƒ‘ãƒªã‚ªãƒ¬ãƒ³ã‚¸", "ã‚«ã‚¯ãƒ†ãƒ«", 550], ["ã‚«ãƒ³ãƒ‘ãƒªã‚½ãƒ¼ãƒ€", "ã‚«ã‚¯ãƒ†ãƒ«", 550], ["ã‚«ãƒ³ãƒ‘ãƒªãƒˆãƒ‹ãƒƒã‚¯", "ã‚«ã‚¯ãƒ†ãƒ«", 550], ["ã‚¸ãƒ³ãƒˆãƒ‹ãƒƒã‚¯", "ã‚«ã‚¯ãƒ†ãƒ«", 550], ["ã‚¸ãƒ³ãƒ©ã‚¤ãƒ ", "ã‚«ã‚¯ãƒ†ãƒ«", 550], ["ãƒ©ãƒ ã‚³ãƒ¼ã‚¯", "ã‚«ã‚¯ãƒ†ãƒ«", 550], ["ãƒ¯ã‚¤ãƒ³ã‚¯ãƒ¼ãƒ©ãƒ¼", "ã‚«ã‚¯ãƒ†ãƒ«", 550], ["ã‚¯ãƒ¼ãƒ‹ãƒ£ãƒ³", "ã‚«ã‚¯ãƒ†ãƒ«", 550], ["ãƒ•ã‚¡ã‚¸ãƒ¼ãƒãƒ¼ãƒ–ãƒ«", "ã‚«ã‚¯ãƒ†ãƒ«", 550], ["ã‚·ãƒ£ãƒ³ãƒ‡ã‚£ã‚¬ãƒ•", "ã‚«ã‚¯ãƒ†ãƒ«", 550], ["ãƒ¬ãƒƒãƒ‰ã‚¢ã‚¤", "ã‚«ã‚¯ãƒ†ãƒ«", 550], ["ãƒ–ãƒ©ãƒƒãƒ‡ã‚£ãƒ¡ã‚¢ãƒªãƒ¼", "ã‚«ã‚¯ãƒ†ãƒ«", 550], ["ã‚¹ã‚¯ãƒªãƒ¥ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒãƒ¼", "ã‚«ã‚¯ãƒ†ãƒ«", 550], ["ãƒ–ãƒ«ãƒ‰ãƒƒã‚¯", "ã‚«ã‚¯ãƒ†ãƒ«", 550], ["ãƒ¢ã‚¹ã‚³ãƒŸãƒ¥ãƒ¼ãƒ«", "ã‚«ã‚¯ãƒ†ãƒ«", 550], ["ã‚¦ãƒ¼ãƒ­ãƒ³èŒ¶", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350], ["ã»ã†ã˜èŒ¶", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350], ["ã‚³ãƒ¼ãƒ©", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350], ["ã‚ªãƒ¬ãƒ³ã‚¸ã‚¸ãƒ¥ãƒ¼ã‚¹", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350], ["ã‚°ãƒ¬ãƒ¼ãƒ—ãƒ•ãƒ«ãƒ¼ãƒ„ã‚¸ãƒ¥ãƒ¼ã‚¹", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350], ["ã‚«ãƒ«ãƒ”ã‚¹", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350], ["ã‚«ãƒ«ãƒ”ã‚¹ã‚½ãƒ¼ãƒ€", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350], ["ãƒˆãƒãƒˆã‚¸ãƒ¥ãƒ¼ã‚¹", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350], ["ã‚¢ã‚¤ã‚¹ã‚³ãƒ¼ãƒ’ãƒ¼", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350], ["ç·‘èŒ¶", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350], ["ã‚¸ãƒ³ã‚¸ãƒ£ãƒ¼ã‚¨ãƒ¼ãƒ«", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350], ["ã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ ï¼ˆãƒãƒ‹ãƒ©ï¼‰", "ãƒ‡ã‚¶ãƒ¼ãƒˆ", 350], ["ã‚³ãƒ¼ãƒ©ãƒ•ãƒ­ãƒ¼ãƒˆ", "ãƒ‡ã‚¶ãƒ¼ãƒˆ", 600], ["ã‚³ãƒ¼ãƒ’ãƒ¼ãƒ•ãƒ­ãƒ¼ãƒˆ", "ãƒ‡ã‚¶ãƒ¼ãƒˆ", 600], ["æ²¢ã®é¶´ 1åˆ", "æ—¥æœ¬é…’", 400], ["æ²¢ã®é¶´ 2åˆ", "æ—¥æœ¬é…’", 600], ["äºŒä¸–å¤ï¼ˆç‰¹åˆ¥ç´”ç±³æ–°é…’ã—ã¼ã‚Šï¼‰", "æ—¥æœ¬é…’", 850], ["ç¹æ¡ï¼ˆç‰¹åˆ¥ç´”ç±³ç”Ÿã€…ï¼‰", "æ—¥æœ¬é…’", 900], ["ç¦å¸ï¼ˆç´”ç±³é…’ï¼‰", "æ—¥æœ¬é…’", 850], ["ã¾ã‚‹ç”°ï¼ˆç‰¹åˆ¥ç´”ç±³ï¼‰", "æ—¥æœ¬é…’", 900], ["ç”·å±±ï¼ˆç´”ç±³ç”Ÿé…’ï¼‰", "æ—¥æœ¬é…’", 900], ["çºç¥­ï¼ˆç´”ç±³å¤§åŸé†¸ï¼‰", "æ—¥æœ¬é…’", 900], ["åä¸€å·ï¼ˆåŸé†¸ã—ã¼ã‚ŠãŸã¦ï¼‰", "æ—¥æœ¬é…’", 900], ["ä¹…ä¿ç”°ï¼ˆæ¸…é…’ï¼‰", "æ—¥æœ¬é…’", 850], ["ä¸€ãƒè”µï¼ˆæœ¬é†¸é€ è¾›å£ï¼‰", "æ—¥æœ¬é…’", 800], ["ã°ãã‚Œã‚“ï¼ˆåŸé†¸è¶…è¾›å£ï¼‰", "æ—¥æœ¬é…’", 800], ["ãã©ãä¸Šæ‰‹ï¼ˆç´”ç±³åŸé†¸è¾›å£ï¼‰", "æ—¥æœ¬é…’", 900], ["åŒ—ã®å‹ï¼ˆæ¸…é…’ï¼‰", "æ—¥æœ¬é…’", 800], ["è¶Šå¾Œã§å€™ï¼ˆã—ã¼ã‚ŠãŸã¦ç”ŸåŸé…’ï¼‰", "æ—¥æœ¬é…’", 900], ["æç™½ï¼ˆç‰¹åˆ¥ç´”ç±³é…’ï¼‰", "æ—¥æœ¬é…’", 850], ["å¸¸å±±ï¼ˆã¨ã³ã£ãã‚Šè¾›å£ï¼‰", "æ—¥æœ¬é…’", 900], ["é–‹é‹ï¼ˆç„¡æ¿¾éç´”ç±³é…’ï¼‰", "æ—¥æœ¬é…’", 900], ["å¤§å’Œã—ãšãï¼ˆç´”ç±³åŸé†¸ï¼‰", "æ—¥æœ¬é…’", 900], ["è¶Šä¹ƒå¯’æ¢…ï¼ˆæ¸…é…’ï¼‰", "æ—¥æœ¬é…’", 800], ["å…«æµ·å±±ï¼ˆæ¸…é…’ï¼‰", "æ—¥æœ¬é…’", 800], ["ã‚‚ã¤ä¸² ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ", "ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ", 150], ["ç²¾è‚‰ ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ", "ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ", 170], ["ã‚‚ã¤ç…®è¾¼ã¿ ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ", "ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ", 300], ["ã‚‚ã¤ä¸²10æœ¬", "ç„¡äºº", 1000], ["é³¥ç²¾è‚‰10æœ¬", "ç„¡äºº", 1000], ["ã‚‚ã¤ã€ç²¾è‚‰ MIX 10æœ¬", "ç„¡äºº", 1000], ["å¼å½“A", "ç„¡äºº", 1000], ["å¼å½“B", "ç„¡äºº", 1000]
];

const menuData = []; const allCat = { cat: "å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼", items: [] }; rawData.forEach(r => { allCat.items.push({n: r[0], p: r[2], c: r[1]}); let c = menuData.find(x => x.cat === r[1]); if(!c) { c = {cat: r[1], items: []}; menuData.push(c); } c.items.push({n: r[0], p: r[2]}); }); menuData.unshift(allCat);

let currentTable = "", currentCart = [], tempGuestCount = "0";
const PRINTER_URL = 'http://192.168.1.XX/StarWebPRNT/SendMessage'; // ãƒ—ãƒªãƒ³ã‚¿ãƒ¼IPã«åˆã‚ã›ã¦ä¿®æ­£
const isTestMode = true;

function hideAll() { document.querySelectorAll('.view').forEach(v => v.style.display = 'none'); }
function renderIndex() { const g = document.getElementById('table-grid'); if(!g) return; const tablesL = ['C-a', 'C-b', 'C-c', '01', '02', '03', '04', '05', '06', '07', 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ', 'ç„¡äºº']; g.innerHTML = tablesL.map(t => { const h = JSON.parse(localStorage.getItem('history_'+t) || '[]'); const total = h.reduce((s, i) => s + Math.floor(i.price*i.qty*(1+i.rate)), 0); return `<div class="table-btn ${total>0?'occupied':''}" onclick="onTableClick('${t}')"><b>${t}</b><span class="price-badge">${total>0?'Â¥'+total.toLocaleString():'ç©ºå¸­'}</span></div>`; }).join(''); }
function showIndex() { window.isEditing = false; hideAll(); document.getElementById('view-index').style.display = 'flex'; renderIndex(); }
function checkAdminAuth() { if(window.currentUser) showAdmin('day'); else { hideAll(); document.getElementById('view-login').style.display = 'flex'; } }
function handleLogin() { window.loginOwner(document.getElementById('login-email').value, document.getElementById('login-pass').value); }
function onTableClick(tId) { currentTable = tId; if(localStorage.getItem('history_' + tId)) showMenu(); else showGuestInput(); }

// --- å£²ä¸Šç®¡ç†ç”»é¢ãƒ­ã‚¸ãƒƒã‚¯ ---
async function showAdmin(mode) {
    hideAll(); document.getElementById('view-admin').style.display = 'flex';
    document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));
    const navId = mode==='month'?'month':mode==='dow'?'dow':mode==='dates'?'dates':'day';
    document.getElementById('nav-' + navId)?.classList.add('active');
    
    const sales = await window.getSalesData();
    const list = document.getElementById('sales-list');
    let total = 0, guests = 0;
    
    list.innerHTML = sales.map(s => {
        total += s.total; guests += s.guests;
        return `<div class="sale-card"><div class="sale-time-row"><span class="sale-time">${s.checkout}</span><span class="sale-table-badge">${s.tableId}</span></div><div class="sale-price-big">Â¥${s.total.toLocaleString()}</div></div>`;
    }).join('');
    
    document.getElementById('sum-total').innerText = total.toLocaleString();
    document.getElementById('sum-guests').innerText = guests;
    document.getElementById('sum-count').innerText = sales.length;
}

// --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»æ³¨æ–‡ UI ãƒ­ã‚¸ãƒƒã‚¯ ---
function showGuestInput() { hideAll(); tempGuestCount = "0"; document.getElementById('guest-table-name').innerText = currentTable + "ç•ªå¸­"; document.getElementById('guest-count-val').innerText = tempGuestCount; document.getElementById('view-guest').style.display = 'flex'; const k = document.getElementById('guest-keypad'); k.innerHTML = [1,2,3,4,5,6,7,8,9,'C',0,'æ±ºå®š'].map(num => `<button class="key-btn" onclick="${num === 'æ±ºå®š' ? 'confirmGuestCount()' : (num === 'C' ? 'clearGuestNum()' : `inputGuestNum(${num})`)}">${num}</button>`).join(''); }
function inputGuestNum(n) { if(tempGuestCount === "0") tempGuestCount = n.toString(); else if(tempGuestCount.length < 2) tempGuestCount += n.toString(); document.getElementById('guest-count-val').innerText = tempGuestCount; }
function clearGuestNum() { tempGuestCount = "0"; document.getElementById('guest-count-val').innerText = tempGuestCount; }
async function confirmGuestCount() { localStorage.setItem('guests_' + currentTable, tempGuestCount); const now = new Date(); localStorage.setItem('checkin_' + currentTable, now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0')); await window.cloudSync(currentTable); showMenu(); }

function showMenu() { 
    currentCart = JSON.parse(localStorage.getItem('cart_'+currentTable) || '[]'); 
    hideAll(); document.getElementById('view-menu').style.display = 'flex'; 
    document.getElementById('display-table-id').innerText = currentTable; 
    document.getElementById('display-guest-count').innerText = localStorage.getItem('guests_' + currentTable) || "0"; 
    document.getElementById('display-checkin-time').innerText = localStorage.getItem('checkin_' + currentTable) || "--:--"; 
    renderSidebar(); renderItems(menuData[0]); updateFooter(); 
}

function renderSidebar() { const side = document.getElementById('side-cats'); side.innerHTML = menuData.map((d, idx) => `<div class="cat" onclick="changeCat(this, ${idx})">${d.cat}</div>`).join(''); side.children[0].classList.add('active'); }
function changeCat(el, idx) { document.querySelectorAll('.cat').forEach(c => c.classList.remove('active')); el.classList.add('active'); renderItems(menuData[idx]); }
function renderItems(category) { const container = document.getElementById('display-items'); container.innerHTML = category.items.map((item, idx) => { const rate = (category.cat.includes("ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ") || category.cat.includes("ç„¡äºº")) ? 0.08 : 0.10; return `<div class="item-card"><div class="item-name">${item.n}</div><div class="item-price">Â¥${item.p.toLocaleString()}</div><div class="qty-ctrl"><div class="btn-circle" onclick="changeQty('q${idx}', -1)">-</div><span id="q${idx}">1</span><div class="btn-circle" onclick="changeQty('q${idx}', 1)">+</div><button class="btn-add" onclick="addToCart('${item.n}', ${item.p}, 'q${idx}', ${rate})">è¿½åŠ </button></div></div>`; }).join(''); }
function changeQty(id, d) { const el = document.getElementById(id); let v = parseInt(el.innerText) + d; if(v >= 1) el.innerText = v; }
function addToCart(name, price, qId, rate) { const qty = parseInt(document.getElementById(qId).innerText); const exist = currentCart.find(i => i.name === name); if(exist) exist.qty += qty; else currentCart.push({name, price, qty, rate}); localStorage.setItem('cart_'+currentTable, JSON.stringify(currentCart)); updateFooter(); document.getElementById(qId).innerText = 1; alert("ã‚«ãƒ¼ãƒˆã«å…¥ã‚Œã¾ã—ãŸ"); }

function showCart() { window.isEditing = true; hideAll(); document.getElementById('view-cart').style.display = 'flex'; renderCartUI(); }
function renderCartUI() { document.getElementById('cart-items-list').innerHTML = currentCart.map((i, idx) => `<div class="list-row"><div><b>${i.name}</b><br>Â¥${i.price} x ${i.qty}</div><button onclick="removeFromCart(${idx})" style="color:red; background:none; border:none;">å‰Šé™¤</button></div>`).join('') || '<p style="text-align:center;padding:50px;">ç©ºã§ã™</p>'; }
function removeFromCart(idx) { currentCart.splice(idx, 1); localStorage.setItem('cart_'+currentTable, JSON.stringify(currentCart)); renderCartUI(); updateFooter(); }
function updateFooter() { document.getElementById('cart-count').innerText = currentCart.reduce((s, i) => s + i.qty, 0); const hist = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]'); const total = hist.reduce((s, i) => s + Math.floor(i.price*i.qty*(1+i.rate)), 0); document.getElementById('display-current-total').innerText = "ç¨è¾¼è¨ˆ: Â¥" + total.toLocaleString(); }
function exitEditing() { window.isEditing = false; showMenu(); }

// --- å±¥æ­´è¡¨ç¤º & ä¼šè¨ˆç¢ºå®š ---
function showOrderHistory() { window.isEditing = true; hideAll(); document.getElementById('view-history').style.display = 'flex'; renderHistoryUI(); }
function renderHistoryUI() {
    const hist = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]');
    let sub = 0, tax = 0;
    document.getElementById('history-items-list').innerHTML = hist.map(i => {
        const lp = i.price * i.qty; const lt = Math.floor(lp * i.rate); sub += lp; tax += lt;
        return `<div class="list-row"><div><b>${i.name}</b> x ${i.qty}</div><div>Â¥${(lp+lt).toLocaleString()}</div></div>`;
    }).join('') || 'ãªã—';
    document.getElementById('history-summary').innerHTML = `ç¨è¾¼è¨ˆ: <b style="font-size:24px;">Â¥${(sub+tax).toLocaleString()}</b>`;
}
async function confirmHistoryChange() { await window.cloudSync(currentTable); alert("åŒæœŸã—ã¾ã—ãŸ"); }
function showCheckout() {
    const hist = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]');
    const total = hist.reduce((s, i) => s + Math.floor(i.price*i.qty*(1+i.rate)), 0);
    document.getElementById('checkout-final-total').innerText = "Â¥" + total.toLocaleString();
    hideAll(); document.getElementById('view-checkout').style.display = 'flex';
}
async function testPay() { await window.saveSaleToCloud(currentTable); showIndex(); }

// --- é ˜åæ›¸é–¢é€£ ---
function openRyoshuusho() { document.getElementById('overlay-ryoshuusho').style.display = 'flex'; }
function closeRyoshuusho() { document.getElementById('overlay-ryoshuusho').style.display = 'none'; }
function printRyoshuusho() { alert("é ˜åæ›¸ã‚’å°åˆ·ã—ã¾ã—ãŸï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰"); closeRyoshuusho(); }

// --- ä¼šè¨ˆé¸æŠ ---
function openReceiptChoice() { document.getElementById('overlay-receipt').style.display = 'flex'; }
function closeReceiptChoice() { document.getElementById('overlay-receipt').style.display = 'none'; }
async function pay(doPrint) { 
    closeReceiptChoice(); 
    if(doPrint) alert("ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å°åˆ·ã—ã¾ã—ãŸï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰");
    await window.saveSaleToCloud(currentTable); 
    showIndex(); 
}

// --- è‡ªå‹•å°åˆ·ãƒ˜ãƒ«ãƒ‘ãƒ¼ (åº—å†…ãƒ¡ã‚¤ãƒ³ç«¯æœ«ç”¨) ---
async function executeAutoPrint(tableId, items) {
    const b = new StarWebPrintBuilder();
    let r = "";
    items.forEach(item => {
        r += b.createInitializationElement();
        r += b.createAlignmentElement({position: 'left'});
        r += b.createTextElement({ data: `[${tableId}] ${item.name} ${item.qty}\n`, width: 2, height: 2 });
        r += b.createTextElement({ data: `--------------------------\næ³¨æ–‡: ${new Date().toLocaleTimeString()}\n` });
        r += b.createCutPaperElement({type: 'partial'});
    });

    return new Promise((resolve) => {
        const t = new StarWebPrintTrader({url: PRINTER_URL});
        t.onReceive = () => resolve(true);
        t.onError = () => { console.error("Printer offline"); resolve(false); };
        t.sendMessage({request: r});
    });
}

// --- åˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯ (URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã‚‹è‡ªå‹•å¸­è¨­å®š) ---
window.onload = () => {
    const params = new URLSearchParams(window.location.search);
    const tableParam = params.get('table');
    
    if (tableParam) {
        currentTable = tableParam;
        // ã™ã§ã«å…¥åº—æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        if(localStorage.getItem('history_' + currentTable) || localStorage.getItem('guests_' + currentTable)) {
            showMenu();
        } else {
            showGuestInput();
        }
    } else {
        showIndex();
    }
};
</script>
</body>
</html>
