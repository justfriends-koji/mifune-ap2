<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ä¸‰èˆ¹ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ POS</title>
<script src="StarWebPrintBuilder.js"></script>
<script src="StarWebPrintTrader.js"></script>
<style>
:root { --primary: #f39c12; --secondary: #fbb03b; --bg: #f8f8f8; --text: #333; --accent: #2ecc71; --gray: #999; --danger: #e74c3c; --info: #3498db; --dark: #444; }
* { touch-action: manipulation; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
body { font-family: sans-serif; margin: 0; background: var(--bg); color: var(--text); -webkit-user-select: none; overflow: hidden; height: 100vh; height: 100dvh; }
header { background: #fff; padding: 0 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; font-weight: bold; height: 55px; flex-shrink: 0; }
.header-left { display: flex; align-items: center; gap: 10px; }
.back-btn { text-decoration: none; color: var(--text); font-size: 26px; cursor: pointer; padding: 10px 5px; }
.reload-btn { font-size: 28px; cursor: pointer; padding: 10px; color: var(--primary); font-weight: bold; }
.admin-btn { font-size: 13px; cursor: pointer; padding: 8px 15px; border: 1px solid var(--primary); border-radius: 25px; color: var(--primary); background: #fff; white-space: nowrap; }
.view { display: none; height: 100vh; height: 100dvh; width: 100vw; flex-direction: column; position: absolute; top: 0; left: 0; background: var(--bg); }
.view.active { display: flex; }
.grid-tables { display: grid; grid-template-columns: repeat(3, 1fr); grid-auto-rows: min-content; gap: 10px; padding: 15px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
.table-btn { background: #fff; border: 2px solid var(--accent); padding: 15px 5px; text-align: center; border-radius: 12px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.05); min-height: 95px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
.table-btn.occupied { background: #e8f5e9; border-color: #27ae60; }
.price-badge { display: block; font-size: 11px; color: #e67e22; margin-top: 5px; font-weight: bold; }
.login-container { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 25px; background: #fff; }
.login-input { width: 100%; max-width: 450px; padding: 25px; margin-bottom: 25px; border: 3px solid #ddd; border-radius: 18px; font-size: 28px; background: #fafafa; -webkit-appearance: none; }
.admin-nav { display: flex; background: #fff; border-bottom: 1px solid #ddd; flex-shrink: 0; }
.admin-nav-btn { flex: 1; padding: 15px; text-align: center; font-size: 14px; font-weight: bold; color: #888; cursor: pointer; border-bottom: 3px solid transparent; }
.admin-nav-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
.sale-card { background: #fff; margin: 12px; padding: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative; border-left: 10px solid var(--info); }
.sale-time-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
.sale-time { font-size: 18px; font-weight: bold; color: var(--dark); }
.sale-table-badge { background: #eee; padding: 4px 10px; border-radius: 8px; font-size: 14px; font-weight: bold; }
.sale-detail-info { font-size: 14px; color: #666; margin-bottom: 10px; }
.sale-total-line { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
.sale-price-big { font-size: 24px; font-weight: bold; color: var(--primary); }
.btn-del-sale { background: var(--danger); color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; }
.report-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 15px; background: #fff; border-bottom: 1px solid #ddd; flex-shrink: 0; }
.btn-report { background: var(--info); color: #fff; border: none; padding: 22px 0; border-radius: 12px; font-weight: bold; font-size: 17px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; }
.list-container { flex: 1; overflow-y: auto; background: #fff; -webkit-overflow-scrolling: touch; padding-bottom: 100px; }
.sidebar { width: 105px; background: #f0f0f0; overflow-y: auto; border-right: 1px solid #ddd; flex-shrink: 0; box-sizing: border-box; padding-bottom: 150px !important; }
.cat { padding: 20px 8px; font-size: 13px; text-align: center; border-bottom: 1px solid #ddd; cursor: pointer; color: #555; line-height: 1.4; }
.cat.active { background: #fff; color: var(--primary); font-weight: bold; border-left: 6px solid var(--primary); }
.item-grid { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; align-content: start; background: #fff; padding-bottom: 150px !important; }
.item-card { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 12px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 2px 8px rgba(0,0,0,0.06); min-height: 170px; }
.item-name { font-weight: bold; font-size: 14px; height: 2.8em; overflow: hidden; line-height: 1.4; margin-bottom: 5px; }
.item-price { color: #e67e22; font-weight: bold; font-size: 15px; margin-bottom: 8px; }
.qty-ctrl { display: flex; align-items: center; justify-content: space-between; border-top: 1px solid #f0f0f0; padding-top: 10px; }
.btn-circle { width: 38px; height: 38px; border-radius: 50%; border: 1px solid #ccc; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; }
.btn-add { background: var(--primary); color: #fff; border: none; padding: 12px 0; border-radius: 25px; font-size: 15px; font-weight: bold; flex: 1; margin-left: 10px; box-shadow: 0 3px 6px rgba(243,156,18,0.3); }
footer { width: 100%; display: flex; flex-direction: column; z-index: 100; box-shadow: 0 -3px 10px rgba(0,0,0,0.1); flex-shrink: 0; }
.footer-history { background: var(--dark); color: #fff; padding: 10px 15px; display: flex; justify-content: space-between; font-size: 14px; cursor: pointer; }
.footer-cart { background: var(--secondary); color: #fff; padding: 18px 15px; display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; cursor: pointer; }
.overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; justify-content: center; align-items: center; padding: 20px 0; }
.modal { background: #fff; width: 90%; max-width: 340px; border-radius: 20px; padding: 20px; text-align: center; position: relative; max-height: 90dvh; overflow-y: auto; }
</style>
</head>
<body>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, addDoc, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyDscuD0S3D66lcamtG4T26WLfZH8rjOy28",
    authDomain: "mifune-ap2.firebaseapp.com",
    projectId: "mifune-ap2",
    storageBucket: "mifune-ap2.firebasestorage.app",
    messagingSenderId: "25505732783",
    appId: "1:25505732783:web:47278f159ad7a26f279c5a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

window.currentUser = null;

onAuthStateChanged(auth, (user) => {
    window.currentUser = user;
    const btnLabel = document.getElementById('admin-btn-label');
    if(user) {
        btnLabel.innerText = "å£²ä¸Šç®¡ç†(åº—ä¸»)";
        btnLabel.style.background = "#e8f5e9";
    } else {
        btnLabel.innerText = "å£²ä¸Šç®¡ç†";
        btnLabel.style.background = "#fff";
    }
});

window.loginOwner = async (email, pass) => {
    try {
        await signInWithEmailAndPassword(auth, email, pass);
        alert("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ");
        showAdmin('day');
    } catch(e) { alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—"); }
};

window.logoutOwner = () => { signOut(auth); alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†"); showIndex(); };

onSnapshot(collection(db, "tables"), (snapshot) => {
    if(window.isEditing) return;
    const tablesList = ['C-a', 'C-b', 'C-c', '01', '02', '03', '04', '05', '06', '07', 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ', 'ç„¡äºº'];
    const cloudIds = snapshot.docs.map(d => d.id);
    tablesList.forEach(tId => {
        if(!cloudIds.includes(tId)) {
            localStorage.removeItem('history_'+tId); localStorage.removeItem('guests_'+tId); localStorage.removeItem('checkin_'+tId);
        }
    });
    snapshot.forEach((doc) => {
        const tId = doc.id; const data = doc.data();
        localStorage.setItem('history_'+tId, JSON.stringify(data.history || []));
        localStorage.setItem('guests_'+tId, data.guests || 0);
        localStorage.setItem('checkin_'+tId, data.checkin || "--:--");
    });
    renderIndex(); updateFooter();
});

window.cloudSync = async (tableId) => {
    await setDoc(doc(db, "tables", tableId), {
        history: JSON.parse(localStorage.getItem('history_' + tableId) || '[]'),
        guests: parseInt(localStorage.getItem('guests_' + tableId)) || 0,
        checkin: localStorage.getItem('checkin_' + tableId) || "--:--",
        updatedAt: Timestamp.now()
    });
};

window.saveSaleToCloud = async (tableId) => {
    const hist = JSON.parse(localStorage.getItem('history_' + tableId) || '[]');
    if(hist.length === 0) return;
    const guests = parseInt(localStorage.getItem('guests_' + tableId)) || 0;
    const checkin = localStorage.getItem('checkin_' + tableId) || "--:--";
    let subtotal = 0, tax = 0;
    hist.forEach(i => { subtotal += i.price * i.qty; tax += Math.floor(i.price * i.qty * i.rate); });
    try {
        await addDoc(collection(db, "sales"), {
            tableId: tableId, guests: guests, checkin: checkin,
            checkout: new Date().getHours().toString().padStart(2, '0') + ":" + new Date().getMinutes().toString().padStart(2, '0'),
            total: subtotal + tax, timestamp: Timestamp.now()
        });
    } catch (e) { console.error("Save Error", e); }
    await deleteDoc(doc(db, "tables", tableId));
};

// ã€ä¿®æ­£æ¸ˆã€‘å£²ä¸Šãƒ‡ãƒ¼ã‚¿å–å¾—
window.getSalesData = async (mode) => {
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth();
    const todayStr = now.toDateString();
    const snap = await getDocs(collection(db, "sales"));
    let res = [];
    snap.forEach(d => {
        let data = d.data();
        data.id = d.id;
        const date = data.timestamp.toDate();
        if (mode === 'day') {
            if (date.toDateString() === todayStr) res.push(data);
        } else if (mode === 'month') {
            if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) res.push(data);
        } else if (mode === 'dow') {
            res.push(data);
        }
    });
    return res.sort((a,b) => b.timestamp - a.timestamp);
};

window.deleteSaleDoc = async (id) => { if(confirm("æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { await deleteDoc(doc(db, "sales", id)); showAdmin('day'); } };
</script>

<div id="view-index" class="view active"><header><div class="admin-btn" id="admin-btn-label" onclick="checkAdminAuth()">å£²ä¸Šç®¡ç†</div><span>ä¸‰èˆ¹ å¸­é¸æŠ</span><div class="reload-btn" onclick="location.reload()">â†»</div></header><div class="grid-tables" id="table-grid"></div></div>

<div id="view-login" class="view">
<header><div class="header-left"><span class="back-btn" onclick="showIndex()">ï¼œ</span><span>èªè¨¼</span></div></header>
<div class="login-container"><div style="font-weight:bold; margin-bottom:20px;">ã‚ªãƒ¼ãƒŠãƒ¼ãƒ­ã‚°ã‚¤ãƒ³</div><input type="email" id="login-email" class="login-input" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"><input type="password" id="login-pass" class="login-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"><button class="btn-large" style="background:var(--primary); color:white; margin-top:20px;" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button></div>
</div>

<div id="view-admin" class="view">
<header><div class="header-left"><span class="back-btn" onclick="showIndex()">ï¼œ</span><span>å£²ä¸Šç®¡ç†</span></div><div style="font-size:12px; color:var(--danger);" onclick="logoutOwner()">çµ‚äº†</div></header>
<div class="admin-nav"><div id="nav-day" class="admin-nav-btn active" onclick="showAdmin('day')">æœ¬æ—¥</div><div id="nav-dow" class="admin-nav-btn" onclick="showAdmin('dow')">æ›œæ—¥åˆ¥</div><div id="nav-month" class="admin-nav-btn" onclick="showAdmin('month')">ä»Šæœˆç´¯è¨ˆ</div></div>
<div id="admin-summary-area" style="padding:15px; background:var(--dark); color:#fff; display:flex; justify-content:space-around; text-align:center; font-size:13px;"><div>ä»¶æ•°<br><span id="sum-count" style="font-size:20px; font-weight:bold;">0</span></div><div>å®¢æ•°<br><span id="sum-guests" style="font-size:20px; font-weight:bold;">0</span></div><div>åˆè¨ˆ<br>Â¥<span id="sum-total" style="font-size:20px; font-weight:bold;">0</span></div></div>
<div class="report-btns"><button class="btn-report" onclick="printReport('day')">æ—¥è¨ˆå°åˆ·</button><button class="btn-report" onclick="printReport('month')" style="background:var(--accent);">æœˆè¨ˆå°åˆ·</button></div>
<div class="list-container" id="sales-list" style="background:#f4f4f4; padding:5px 0;"></div>
</div>

<div id="view-guest" class="view"><header><span class="back-btn" onclick="showIndex()">ï¼œ</span>å®¢æ•°å…¥åŠ›</header><div class="guest-input-container"><h2 id="guest-table-name"></h2><div class="guest-num-display"><span id="guest-count-val">0</span> å</div><div class="keypad" id="guest-keypad"></div></div></div>
<div id="view-menu" class="view">
<header><span class="back-btn" onclick="showIndex()">Ã—</span><span id="display-table-id"></span>ç•ªå¸­ (<span id="display-guest-count"></span>å)</header>
<div class="menu-container"><div class="sidebar" id="side-cats"></div><div class="item-grid" id="display-items"></div></div>
<footer><div class="footer-history" onclick="showOrderHistory()"><span>æ³¨æ–‡æ¸ˆåˆè¨ˆ</span><span id="display-current-total">Â¥0</span></div><div class="footer-cart" onclick="showCart()"><div>ğŸ›’ <span id="cart-count">0</span>ç‚¹</div><div>æ³¨æ–‡ã‚’ç¢ºèª ï¼</div></div></footer>
</div>
<div id="view-cart" class="view"><header><span class="back-btn" onclick="exitEditing()">ï¼œ</span>ã‚«ãƒ¼ãƒˆç¢ºèª</header><div class="list-container" id="cart-items-list"></div><button class="btn-large" style="background:var(--primary);color:white;" onclick="testSend()">é€ä¿¡ã—ã¦åŒæœŸ</button></div>
<div id="view-history" class="view"><header><span class="back-btn" onclick="exitEditing()">ï¼œ</span>æ³¨æ–‡å±¥æ­´</header><div class="list-container" id="history-items-list"></div><div class="summary-area" id="history-summary"></div><button class="btn-large" style="background:var(--secondary); color:white;" onclick="showCheckout()">ä¼šè¨ˆã¸</button></div>
<div id="view-checkout" class="view"><header><span class="back-btn" onclick="showOrderHistory()">ï¼œ</span>ä¼šè¨ˆç¢ºå®š</header><div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;"><div style="padding:40px; background:#fff; border-radius:15px; text-align:center;"><div id="checkout-final-total" style="font-size:40px; font-weight:bold; color:var(--primary);">Â¥0</div></div></div><button class="btn-large" style="background:var(--accent);color:white;" onclick="testPay()">ä¼šè¨ˆã‚’å®Œäº†ã™ã‚‹</button></div>

<script>
// --- å•†å“ãƒ‡ãƒ¼ã‚¿ãƒ»åŸºæœ¬é–¢æ•° ---
const rawData = [["ãŠé€šã—", "å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼", 300], ["ã‚‚ã¤ä¸²", "ç¾å”„ç„¼é³¥", 150], ["é³¥ç²¾è‚‰", "ç¾å”„ç„¼é³¥", 170], ["æ‰‹ç¾½ç„¼ãï¼ˆ2æœ¬ï¼‰", "ç„¼ãç‰©", 400], ["ã‚‚ã¤ä¸²æŒå¸°", "ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ", 150], ["ç²¾è‚‰æŒå¸°", "ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ", 170], ["é£²ã¿æ”¾é¡Œç”·", "é£²ã¿æ”¾é¡Œ", 2280], ["é£²ã¿æ”¾é¡Œå¥³", "é£²ã¿æ”¾é¡Œ", 1980]];
const menuData = []; const allCat = { cat: "å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼", items: [] }; rawData.forEach(r => { allCat.items.push({n: r[0], p: r[2], c: r[1]}); let c = menuData.find(x => x.cat === r[1]); if(!c) { c = {cat: r[1], items: []}; menuData.push(c); } c.items.push({n: r[0], p: r[2]}); }); menuData.unshift(allCat);
const tablesL = ['C-a', 'C-b', 'C-c', '01', '02', '03', '04', '05', '06', '07', 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ', 'ç„¡äºº'];
let currentTable = "", currentCart = [], tempGuestCount = "0";

function hideAll() { document.querySelectorAll('.view').forEach(v => v.style.display = 'none'); }
function renderIndex() { const g = document.getElementById('table-grid'); if(!g) return; g.innerHTML = tablesL.map(t => { const h = JSON.parse(localStorage.getItem('history_'+t) || '[]'); const total = h.reduce((s, i) => s + Math.floor(i.price*i.qty*(1+i.rate)), 0); return `<div class="table-btn ${total>0?'occupied':''}" onclick="onTableClick('${t}')"><b>${t}</b><span class="price-badge">${total>0?'Â¥'+total.toLocaleString():'ç©ºå¸­'}</span></div>`; }).join(''); }
function showIndex() { window.isEditing = false; hideAll(); document.getElementById('view-index').style.display = 'flex'; renderIndex(); }
function checkAdminAuth() { if(window.currentUser) showAdmin('day'); else { hideAll(); document.getElementById('view-login').style.display = 'flex'; } }
function handleLogin() { window.loginOwner(document.getElementById('login-email').value, document.getElementById('login-pass').value); }
function onTableClick(tId) { currentTable = tId; if(localStorage.getItem('history_' + tId)) showMenu(); else showGuestInput(); }

// ã€ä¿®æ­£æ¸ˆã€‘å£²ä¸Šç®¡ç†è¡¨ç¤º
async function showAdmin(mode) {
    hideAll(); document.getElementById('view-admin').style.display = 'flex';
    document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));
    if(document.getElementById('nav-'+mode)) document.getElementById('nav-'+mode).classList.add('active');
    const list = document.getElementById('sales-list'); list.innerHTML = 'é›†è¨ˆä¸­...';
    try {
        const sales = await window.getSalesData(mode);
        let total = 0, guests = 0;
        if (mode === 'day' || mode === 'month') {
            list.innerHTML = sales.map(s => {
                total += s.total; guests += s.guests;
                const d = s.timestamp.toDate();
                return `<div class="sale-card"><div class="sale-time-row"><span class="sale-time">${(mode==='month'?(d.getMonth()+1)+'/'+d.getDate()+' ':'')+s.checkout}</span><span class="sale-table-badge">${s.tableId}</span></div><div class="sale-detail-info">å®¢æ•°: ${s.guests}å</div><div class="sale-total-line"><span class="sale-price-big">Â¥${s.total.toLocaleString()}</span><button class="btn-del-sale" onclick="deleteSaleDoc('${s.id}')">å‰Šé™¤</button></div></div>`;
            }).join('') || 'ãƒ‡ãƒ¼ã‚¿ãªã—';
        } else if (mode === 'dow') {
            const labels = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
            let stats = [0,1,2,3,4,5,6].map(i=>({l:labels[i], t:0, c:0, g:0}));
            sales.forEach(s => { const dow = s.timestamp.toDate().getDay(); stats[dow].t += s.total; stats[dow].c++; stats[dow].g += s.guests; total += s.total; guests += s.guests; });
            list.innerHTML = stats.map(s => `<div class="sale-card"><div class="sale-time-row"><b>${s.l}æ›œæ—¥</b></div><div>ç´¯è¨ˆ: Â¥${s.t.toLocaleString()} (${s.c}ä»¶)</div></div>`).join('');
        }
        document.getElementById('sum-total').innerText = total.toLocaleString();
        document.getElementById('sum-guests').innerText = guests;
        document.getElementById('sum-count').innerText = sales.length;
    } catch(e) { list.innerHTML = "ã‚¨ãƒ©ãƒ¼"; }
}

// ä»–ã€æ³¨æ–‡ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–¢é€£
function showGuestInput() { hideAll(); tempGuestCount = "0"; document.getElementById('guest-count-val').innerText = "0"; document.getElementById('view-guest').style.display = 'flex'; const k = document.getElementById('guest-keypad'); k.innerHTML = [1,2,3,4,5,6,7,8,9,'C',0,'æ±ºå®š'].map(num => `<button class="key-btn" onclick="${num==='æ±ºå®š'?'confirmGuestCount()':num==='C'?'clearGuestNum()':`inputGuestNum(${num})`}">${num}</button>`).join(''); }
function inputGuestNum(n) { if(tempGuestCount === "0") tempGuestCount = n.toString(); else tempGuestCount += n.toString(); document.getElementById('guest-count-val').innerText = tempGuestCount; }
function clearGuestNum() { tempGuestCount = "0"; document.getElementById('guest-count-val').innerText = "0"; }
async function confirmGuestCount() { localStorage.setItem('guests_'+currentTable, tempGuestCount); localStorage.setItem('checkin_'+currentTable, new Date().getHours()+":"+new Date().getMinutes()); if(window.cloudSync) await window.cloudSync(currentTable); showMenu(); }
function showMenu() { currentCart = []; hideAll(); document.getElementById('view-menu').style.display = 'flex'; document.getElementById('display-table-id').innerText = currentTable; document.getElementById('display-guest-count').innerText = localStorage.getItem('guests_'+currentTable); renderSidebar(); renderItems(menuData[0]); updateFooter(); }
function renderSidebar() { const side = document.getElementById('side-cats'); side.innerHTML = menuData.map((d, i) => `<div class="cat" onclick="renderItems(menuData[${i}])">${d.cat}</div>`).join(''); }
function renderItems(cat) { const g = document.getElementById('display-items'); g.innerHTML = cat.items.map((item, i) => `<div class="item-card"><b>${item.n}</b><br>Â¥${item.p}<button class="btn-add" onclick="addToCart('${item.n}',${item.p},0.1)">è¿½åŠ </button></div>`).join(''); }
function addToCart(n, p, r) { currentCart.push({name:n, price:p, qty:1, rate:r}); updateFooter(); }
function updateFooter() { document.getElementById('cart-count').innerText = currentCart.length; const h = JSON.parse(localStorage.getItem('history_'+currentTable)||'[]'); const total = h.reduce((s,i)=>s+Math.floor(i.price*i.qty*(1+i.rate)), 0); document.getElementById('display-current-total').innerText = "ç¨è¾¼åˆè¨ˆ: Â¥"+total.toLocaleString(); }
async function testSend() { const h = JSON.parse(localStorage.getItem('history_'+currentTable)||'[]'); localStorage.setItem('history_'+currentTable, JSON.stringify(h.concat(currentCart))); if(window.cloudSync) await window.cloudSync(currentTable); showMenu(); }
function showOrderHistory() { window.isEditing=true; hideAll(); document.getElementById('view-history').style.display = 'flex'; renderHistoryUI(); }
function renderHistoryUI() { const h = JSON.parse(localStorage.getItem('history_'+currentTable)||'[]'); document.getElementById('history-items-list').innerHTML = h.map(i=>`<div>${i.name} x ${i.qty}</div>`).join(''); }
function showCheckout() { const h = JSON.parse(localStorage.getItem('history_'+currentTable)||'[]'); const total = h.reduce((s,i)=>s+Math.floor(i.price*i.qty*(1+i.rate)), 0); document.getElementById('checkout-final-total').innerText = "Â¥"+total.toLocaleString(); hideAll(); document.getElementById('view-checkout').style.display = 'flex'; }
async function testPay() { if(window.saveSaleToCloud) await window.saveSaleToCloud(currentTable); showIndex(); }

window.onload = () => renderIndex();
</script>
</body>
</html>
