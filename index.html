<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¸‰èˆ¹ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ POS</title>
    <!-- ã‚¹ã‚¿ãƒ¼ç²¾å¯† SDK -->
    <script src="StarWebPrintBuilder.js"></script>
    <script src="StarWebPrintTrader.js"></script>
    <style>
        :root { --primary: #f39c12; --secondary: #fbb03b; --bg: #f8f8f8; --text: #333; --accent: #2ecc71; --gray: #999; --danger: #e74c3c; --info: #3498db; --dark: #444; }
        
        /* iPhone ã‚ºãƒ¼ãƒ ç¦æ­¢ & åå¿œé€Ÿåº¦å‘ä¸Š */
        * { touch-action: manipulation; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); color: var(--text); -webkit-user-select: none; overflow: hidden; height: 100vh; height: 100dvh; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header { background: #fff; padding: 0 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; font-weight: bold; height: 50px; flex-shrink: 0; }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .back-btn { text-decoration: none; color: var(--text); font-size: 24px; cursor: pointer; padding: 10px 5px; }
        .reload-btn { font-size: 26px; cursor: pointer; padding: 10px; color: var(--primary); font-weight: bold; }
        .admin-btn { font-size: 13px; cursor: pointer; padding: 6px 12px; border: 1px solid var(--primary); border-radius: 20px; color: var(--primary); background: #fff; }

        .view { display: none; height: 100vh; height: 100dvh; width: 100vw; flex-direction: column; position: absolute; top: 0; left: 0; background: var(--bg); }
        .view.active { display: flex; }

        /* 1. å¸­é¸æŠ */
        .grid-tables { display: grid; grid-template-columns: repeat(3, 1fr); grid-auto-rows: min-content; gap: 10px; padding: 15px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
        .table-btn { background: #fff; border: 2px solid var(--accent); padding: 15px 5px; text-align: center; border-radius: 12px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.05); min-height: 85px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .table-btn.occupied { background: #e8f5e9; border-color: #27ae60; }
        .price-badge { display: block; font-size: 11px; color: #e67e22; margin-top: 5px; font-weight: bold; }

        /* 2. å®¢æ•°å…¥åŠ›ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ (3x4) */
        .guest-input-container { text-align: center; padding: 20px; flex: 1; overflow-y: auto; }
        .guest-num-display { font-size: 45px; font-weight: bold; margin: 10px 0; color: var(--primary); background: #eee; border-radius: 10px; padding: 10px; }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; max-width: 300px; margin: auto; }
        .key-btn { background: #fff; border: 1px solid #ddd; padding: 20px; font-size: 24px; font-weight: bold; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }

        /* 3. ãƒ¡ãƒ‹ãƒ¥ãƒ¼ (ã‚¿ã‚¤ãƒ«å‹) */
        .menu-container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 105px; background: #f0f0f0; overflow-y: auto; border-right: 1px solid #ddd; flex-shrink: 0; box-sizing: border-box; padding-bottom: 150px !important; }
        .cat { padding: 18px 8px; font-size: 11px; text-align: center; border-bottom: 1px solid #ddd; cursor: pointer; color: #555; line-height: 1.3; }
        .cat.active { background: #fff; color: var(--primary); font-weight: bold; border-left: 5px solid var(--primary); }
        .item-grid { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(145px, 1fr)); gap: 10px; align-content: start; background: #fff; padding-bottom: 150px !important; }
        .item-card { background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 10px; display: flex; flex-direction: column; justify-content: space-between; min-height: 145px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .item-name { font-weight: bold; font-size: 12px; height: 3.2em; overflow: hidden; line-height: 1.3; margin-bottom: 4px; }
        .item-price { color: #e67e22; font-weight: bold; font-size: 13px; }
        .qty-ctrl { display: flex; align-items: center; justify-content: space-between; border-top: 1px solid #f9f9f9; padding-top: 5px; }
        .btn-circle { width: 32px; height: 32px; border-radius: 50%; border: 1px solid #ccc; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }
        .btn-add { background: var(--primary); color: #fff; border: none; padding: 10px 0; border-radius: 18px; font-size: 13px; font-weight: bold; flex: 1; margin-left: 8px; }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ */
        footer { width: 100%; display: flex; flex-direction: column; z-index: 100; box-shadow: 0 -3px 10px rgba(0,0,0,0.1); flex-shrink: 0; }
        .footer-history { background: var(--dark); color: #fff; padding: 10px 15px; display: flex; justify-content: space-between; font-size: 12px; cursor: pointer; }
        .footer-cart { background: var(--secondary); color: #fff; padding: 15px 15px; display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; cursor: pointer; }

        /* ãƒªã‚¹ãƒˆãƒ»å£²ä¸Šè¡¨ç¤º */
        .list-container { flex: 1; overflow-y: auto; background: #fff; -webkit-overflow-scrolling: touch; }
        .list-row { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #eee; align-items: center; }
        .summary-area { padding: 15px 25px; text-align: right; background: #fff; border-top: 2px solid #eee; flex-shrink: 0; line-height: 1.5; font-size: 14px; }
        .btn-large { width: 90%; display: block; margin: 8px auto; padding: 16px; border: none; border-radius: 40px; font-size: 18px; font-weight: bold; cursor: pointer; text-align: center; flex-shrink: 0; }
        .btn-del { background: var(--danger); color: white; border: none; padding: 8px 10px; border-radius: 5px; font-size: 12px; }

        /* ãƒ­ã‚°ã‚¤ãƒ³ãƒ»å£²ä¸Šå°‚ç”¨ */
        .login-container { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; }
        .login-input { width: 100%; max-width: 300px; padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; }
        .sale-card { background: #fff; margin: 8px; padding: 12px; border-radius: 10px; border: 1px solid #eee; font-size: 12px; }
        .report-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px 15px; background: #fff; border-bottom: 1px solid #ddd; }
        .btn-report { background: var(--info); color: #fff; border: none; padding: 12px; border-radius: 8px; font-weight: bold; font-size: 13px; }
        
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; justify-content: center; align-items: center; padding: 20px 0; }
        .modal { background: #fff; width: 90%; max-width: 340px; border-radius: 20px; padding: 20px; text-align: center; position: relative; max-height: 90dvh; overflow-y: auto; }
        .receipt-sample { background: #fff; padding: 15px; color: #000; font-family: monospace; text-align: left; font-size: 11px; border: 1px dashed #ccc; width: 100%; }
        .receipt-hr { border-top: 1px dashed #000; margin: 5px 0; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-bold { font-weight: bold; }
    </style>
</head>
<body>

<!-- Firebase ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸè¨­å®š -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, addDoc, query, orderBy, getDocs, where, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDcud0S3D66lcamtG4T26WlfZH8rjOy28",
        authDomain: "mifune-ap2.firebaseapp.com",
        projectId: "mifune-ap2",
        storageBucket: "mifune-ap2.firebasestorage.app",
        messagingSenderId: "25505732783",
        appId: "1:25505732783:web:47278f159ad7a26f279c5a",
        measurementId: "G-7F8BM4SBGR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    window.currentUser = null;
    window.isEditing = false;

    // èªè¨¼ç›£è¦–
    onAuthStateChanged(auth, (user) => {
        window.currentUser = user;
        const btn = document.getElementById('admin-btn-label');
        if(user) { btn.innerText = "å£²ä¸Šç®¡ç†(åº—ä¸»)"; btn.style.background = "#e8f5e9"; }
        else { btn.innerText = "å£²ä¸Šç®¡ç†"; btn.style.background = "#fff"; }
    });

    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆè©³ç´°ã‚¨ãƒ©ãƒ¼ä»˜ãï¼‰
    window.loginOwner = async (email, pass) => {
        try {
            await signInWithEmailAndPassword(auth, email, pass);
            alert("èªè¨¼ã«æˆåŠŸã—ã¾ã—ãŸã€‚");
            showAdmin();
        } catch(e) {
            console.error(e.code);
            let msg = "ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ã€‚";
            if(e.code === 'auth/wrong-password') msg = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚";
            if(e.code === 'auth/user-not-found') msg = "ç™»éŒ²ã•ã‚Œã¦ã„ãªã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™ã€‚";
            if(e.code === 'auth/invalid-email') msg = "ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚";
            alert(msg);
        }
    };
    window.logoutOwner = () => { signOut(auth); alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†"); showIndex(); };

    // ã‚¯ãƒ©ã‚¦ãƒ‰ç›£è¦–
    onSnapshot(collection(db, "tables"), (snapshot) => {
        if(window.isEditing) return;
        const tablesList = ['C-a', 'C-b', 'C-c', '01', '02', '03', '04', '05', '06', '07', 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ', 'ç„¡äºº'];
        const cloudIds = snapshot.docs.map(d => d.id);
        tablesList.forEach(tId => {
            if(!cloudIds.includes(tId)) {
                localStorage.removeItem('history_'+tId); localStorage.removeItem('guests_'+tId); localStorage.removeItem('checkin_'+tId);
            }
        });
        snapshot.forEach((doc) => {
            const tId = doc.id; const data = doc.data();
            localStorage.setItem('history_'+tId, JSON.stringify(data.history || []));
            localStorage.setItem('guests_'+tId, data.guests || 1);
            localStorage.setItem('checkin_'+tId, data.checkin || "--:--");
        });
        renderIndex(); updateFooter();
    });

    window.cloudSync = async (tableId) => {
        await setDoc(doc(db, "tables", tableId), {
            history: JSON.parse(localStorage.getItem('history_' + tableId) || '[]'),
            guests: localStorage.getItem('guests_' + tableId) || 1,
            checkin: localStorage.getItem('checkin_' + tableId) || "--:--",
            updatedAt: new Date()
        });
    };
    window.saveSaleToCloud = async (tableId) => {
        const hist = JSON.parse(localStorage.getItem('history_' + tableId) || '[]');
        const guests = parseInt(localStorage.getItem('guests_' + tableId)) || 1;
        const checkin = localStorage.getItem('checkin_' + tableId) || "--:--";
        let subtotal = 0, tax = 0;
        hist.forEach(i => { subtotal += i.price * i.qty; tax += Math.floor(i.price * i.qty * i.rate); });
        await addDoc(collection(db, "sales"), {
            tableId: tableId, guests: guests, checkin: checkin,
            checkout: new Date().getHours().toString().padStart(2, '0') + ":" + new Date().getMinutes().toString().padStart(2, '0'),
            items: hist, subtotal: subtotal, tax: tax, total: subtotal + tax, timestamp: Timestamp.now()
        });
        await deleteDoc(doc(db, "tables", tableId));
    };
    window.getSalesData = async (mode) => {
        const now = new Date(); let start;
        if (mode === 'day') start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        else start = new Date(now.getFullYear(), now.getMonth(), 1);
        const q = query(collection(db, "sales"), where("timestamp", ">=", start), orderBy("timestamp", "desc"));
        const snap = await getDocs(q);
        let res = []; snap.forEach(d => res.push(d.data())); return res;
    };
    window.cloudDelete = async (tableId) => { await deleteDoc(doc(db, "tables", tableId)); };
</script>

<!-- UIã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div id="view-index" class="view active">
    <header>
        <div class="admin-btn" id="admin-btn-label" onclick="checkAdminAuth()">å£²ä¸Šç®¡ç†</div>
        <span>ä¸‰èˆ¹ å¸­é¸æŠ</span>
        <div class="reload-btn" onclick="location.reload()">â†»</div>
    </header>
    <div class="grid-tables" id="table-grid"></div>
</div>

<div id="view-login" class="view">
    <header><div class="header-left"><span class="back-btn" onclick="showIndex()">ï¼œ</span><span>ã‚ªãƒ¼ãƒŠãƒ¼èªè¨¼</span></div></header>
    <div class="login-container">
        <input type="email" id="login-email" class="login-input" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        <input type="password" id="login-pass" class="login-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button class="btn-large" style="background:var(--primary); color:white;" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
</div>

<div id="view-admin" class="view">
    <header>
        <div class="header-left"><span class="back-btn" onclick="showIndex()">ï¼œ</span><span>æœ¬æ—¥å£²ä¸Š</span></div>
        <div style="font-size:12px; color:var(--danger);" onclick="logoutOwner()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</div>
    </header>
    <div style="padding:15px; background:var(--dark); color:#fff; display:flex; justify-content:space-around; text-align:center;">
        <div>ä»¶æ•°<br><span id="sum-count" style="font-size:18px;">0</span></div>
        <div>å®¢æ•°<br><span id="sum-guests" style="font-size:18px;">0</span></div>
        <div>åˆè¨ˆ<br>Â¥<span id="sum-total" style="font-size:18px;">0</span></div>
    </div>
    <div class="report-btns">
        <button class="btn-report" onclick="printReport('day')">æ—¥è¨ˆã‚’å°åˆ·</button>
        <button class="btn-report" onclick="printReport('month')" style="background:var(--accent);">æœˆè¨ˆã‚’å°åˆ·</button>
    </div>
    <div class="list-container" id="sales-list" style="background:#f4f4f4;"></div>
</div>

<div id="view-guest" class="view"><header><span class="back-btn" onclick="showIndex()">ï¼œ</span>å®¢æ•°å…¥åŠ›</header><div class="guest-input-container"><h2 id="guest-table-name"></h2><div class="guest-num-display"><span id="guest-count-val">1</span> å</div><div class="keypad" id="guest-keypad"></div></div></div>

<div id="view-menu" class="view">
    <header><span class="back-btn" onclick="showIndex()">Ã—</span><span id="display-table-id"></span>ç•ªå¸­ (<span id="display-guest-count"></span>å)<span style="margin-left:auto; font-size:11px; color:#666;">å…¥åº—: <span id="display-checkin-time"></span></span></header>
    <div class="menu-container"><div class="sidebar" id="side-cats"></div><div class="item-grid" id="display-items"></div></div>
    <footer>
        <div class="footer-history" onclick="showOrderHistory()"><span>æ³¨æ–‡æ¸ˆåˆè¨ˆ</span><span id="display-current-total">Â¥0</span></div>
        <div class="footer-cart" onclick="showCart()"><div>ğŸ›’ <span id="cart-count">0</span>ç‚¹</div><div>æ³¨æ–‡ã‚’ç¢ºèª ï¼</div></div>
    </footer>
</div>

<div id="view-cart" class="view"><header><span class="back-btn" onclick="exitEditing()">ï¼œ</span>ã‚«ãƒ¼ãƒˆç¢ºèª</header><div class="list-container" id="cart-items-list"></div><div style="background:#fff; border-top:1px solid #eee; padding-bottom:10px;"><button class="btn-large" style="background:var(--info); color:white;" onclick="testSend()">é€ä¿¡(åŒæœŸã®ã¿)</button><button class="btn-large" style="background:var(--primary);color:white;" onclick="sendToKitchen()">æœ¬ç•ªé€ä¿¡(å°åˆ·)</button></div></div>

<div id="view-history" class="view">
    <header><span class="back-btn" onclick="exitEditing()">ï¼œ</span>å±¥æ­´ãƒ»æ•°é‡ä¿®æ­£</header>
    <div class="list-container" id="history-items-list"></div>
    <div class="summary-area" id="history-summary"></div>
    <div style="background:#fff; border-top:1px solid #ddd; padding-bottom:10px;">
        <button class="btn-large" style="background:var(--accent); color:white;" onclick="confirmHistoryChange()">æ•°é‡å¤‰æ›´ã‚’ä¿å­˜(åŒæœŸ)</button>
        <button class="btn-large" style="background:var(--secondary); color:white;" onclick="showCheckout()">ãŠä¼šè¨ˆç¢ºå®šã¸é€²ã‚€</button>
    </div>
</div>

<div id="view-checkout" class="view">
    <header><span class="back-btn" onclick="showOrderHistory()">ï¼œ</span>ä¼šè¨ˆç¢ºå®š</header>
    <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;"><div style="padding:30px 20px; background:#fff; border-radius:15px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.1); width:85%;"><div id="checkout-final-total" style="font-size:40px; font-weight:bold; color:var(--primary);">Â¥0</div><div id="checkout-final-info" style="color:#666; font-size:12px;"></div></div></div>
    <button class="btn-large" style="background:var(--info); color:white;" onclick="testPay()">ã€ãƒ†ã‚¹ãƒˆã€‘ä¼šè¨ˆå®Œäº†</button><button class="btn-large" style="background:var(--accent);color:white;" onclick="openReceiptChoice()">æœ¬ç•ªä¼šè¨ˆ</button>
</div>

<div id="overlay-receipt" class="overlay"><div class="modal"><div id="receipt-preview-area" style="display:none;"><div class="modal-title">å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div><div id="sample-receipt-content" class="receipt-sample"></div></div><div class="modal-title" id="receipt-modal-main-title">ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å°åˆ·ã—ã¾ã™ã‹ï¼Ÿ</div><button class="btn-large" style="background:var(--primary); color:white;" onclick="pay(true)">å°åˆ·ã—ã¦å®Œäº†</button><button class="btn-large" style="background:var(--gray); color:white;" onclick="pay(false)">å°åˆ·ã›ãšã«å®Œäº†</button><div style="margin-top:15px; color:var(--info); font-size:14px; cursor:pointer;" onclick="closeReceiptChoice()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div></div></div>

<div id="view-success" class="view" style="text-align:center; justify-content:center;"><h2>é€ä¿¡å®Œäº†</h2><button class="btn-large" style="background:var(--primary);color:white;" onclick="showMenu()">æˆ»ã‚‹</button></div>

<script>
// --- å•†å“ãƒ‡ãƒ¼ã‚¿ (198å“å®Œå…¨ç¶²ç¾…) ---
const rawData = [
    ["ãŠé€šã—","ãŠé€šã—",300],["ã‚‚ã¤ä¸²","ç¾å”„ç„¼é³¥",150],["é³¥ç²¾è‚‰","ç¾å”„ç„¼é³¥",170],["æ‰‹ç¾½ç„¼ãï¼ˆ2æœ¬ï¼‰","ç„¼ãç‰©",400],["å›½ç”£è±šã®ãƒ­ãƒ¼ã‚¹ç¶²ç„¼ãã‚¹ãƒ†ãƒ¼ã‚­","ç„¼ãç‰©",600],["ãƒãƒ¼ãƒ•è±šã®ç¶²ç„¼ãã‚¹ãƒ†ãƒ¼ã‚­ï¼ˆ1æšï¼‰","ç„¼ãç‰©",700],["ãƒãƒ¼ãƒ•è±šã®ç‚™ã‚Šãƒãƒ£ãƒ¼ã‚·ãƒ¥ãƒ¼","ç„¼ãç‰©",600],["è‡ªå®¶è£½ã¤ãã­ã®ã‚³ãƒ­ã‚³ãƒ­ç„¼ãï¼ˆ4ç‰ï¼‰","ç„¼ãç‰©",400],["ã•ã•ã¿ä¸²ç„¼ãï¼ˆæ•°é‡é™å®š 1ä¸²ï¼‰","ç„¼ãç‰©",250],["é´¨è‚‰ã®ç¶²ç„¼ã","ç„¼ãç‰©",600],["ãƒ”ãƒªè¾›ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸ï¼ˆ2æœ¬ï¼‰","ç„¼ãç‰©",400],["ãƒ©ãƒ ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸ï¼ˆ2æœ¬ï¼‰","ç„¼ãç‰©",500],["ã†ãšã‚‰ã®ç‰å­ï¼ˆ1ä¸²ï¼‰","ç„¼ãç‰©",150],["è‚‰åšã—ã„ãŸã‘ï¼ˆ2å€‹ï¼‰","ç„¼ãç‰©",300],["ãƒ—ãƒãƒˆãƒãƒˆï¼ˆ1ä¸²ï¼‰","ç„¼ãç‰©",150],["ã‚ºãƒƒã‚­ãƒªï¼ˆ1ä¸²ï¼‰","ç„¼ãç‰©",150],["é•·ãªã™ä¸²ç„¼ãï¼ˆ1ä¸²ï¼‰","ç„¼ãç‰©",300],["è»Ÿç™½ã­ãï¼ˆ1ä¸²ï¼‰","ç„¼ãç‰©",300],["ã—ã—ã¨ã†ï¼ˆ2ä¸²ï¼‰","ç„¼ãç‰©",300],["ã«ã‚“ã«ãã‚«ãƒƒãƒ—ç„¼ã","ç„¼ãç‰©",500],["ç„¼ãã˜ã‚ƒãŒãƒã‚¿ãƒ¼","ç„¼ãç‰©",500],["ã„ã‚‚ã‚‚ã¡ãƒã‚¿ãƒ¼","ç„¼ãç‰©",400],["ã•ã•ã¿ä¸²ï¼ˆå¡©ã“ã†ã˜ï¼‰","ç„¼ãç‰©",300],["å›½ç”£è±šãƒ­ãƒ¼ã‚¹ï¼ˆå¡©ï¼‰","ç„¼ãç‰©",750],["é³¥ã‚‚ã¤ç…®è¾¼ã¿","ä¸€å“æ–™ç†",400],["ç‰¹è£½ä¸€å£ã‚¶ãƒ³ã‚®","ä¸€å“æ–™ç†",550],["æ‰‹ç¾½ã‚¶ãƒ³ã‚®(3æœ¬)","ä¸€å“æ–™ç†",550],["è‹¥é¶ã®çš®ç«œç”°æšã’","ä¸€å“æ–™ç†",550],["ã‚µã‚µãƒŸã‚«ãƒ„(2æš)","ä¸€å“æ–™ç†",600],["å›½ç”£è±šã®ãƒ­ãƒ¼ã‚¹ã‚«ãƒ„","ä¸€å“æ–™ç†",700],["ã‚³ãƒ¼ãƒ³ãƒã‚¿ãƒ¼ãƒ»ãƒãƒ¼ã‚ºã‚«ãƒƒãƒ—","ä¸€å“æ–™ç†",500],["ç”Ÿãƒãƒ ã®è»Ÿç™½ã­ãåŒ…ã¿","ä¸€å“æ–™ç†",650],["å¡©ã‚­ãƒ£ãƒ™ãƒ„","ä¸€å“æ–™ç†",350],["æ¼¬ç‰©","ä¸€å“æ–™ç†",350],["æè±†","ä¸€å“æ–™ç†",350],["å†·å¥´","ä¸€å“æ–™ç†",400],["å±±ã‚ã•ã³å†·å¥´","ä¸€å“æ–™ç†",400],["ãªã‚ã“ãŠã‚ã—","ä¸€å“æ–™ç†",400],["ã‚«ãƒ‹ã¿ãã¨ã†ãµ","ä¸€å“æ–™ç†",400],["ãƒãƒ£ãƒ³ã‚¸ãƒ£","ä¸€å“æ–™ç†",400],["ã‚¤ã‚«ã®å¡©è¾›","ä¸€å“æ–™ç†",400],["ãŸã“ã‚ã•ã³","ä¸€å“æ–™ç†",400],["ã»ãŸã¦ã‚ã•ã³","ä¸€å“æ–™ç†",400],["æ•°ã®å­å…¥ã‚Šæ¾å‰æ¼¬ã‘","ä¸€å“æ–™ç†",400],["ã‚¯ã‚¸ãƒ©ã®ãƒ™ãƒ¼ã‚³ãƒ³ ã­ãæ­£æ²¹ã‚ãˆ","ä¸€å“æ–™ç†",700],["è‡ªå®¶è£½ãƒ‘ãƒ³ãƒã‚§ãƒƒã‚¿ã¨èŠ‹ç†±æ¹¯é¢¨å‘‚","ã‚ªãƒªã‚¸ãƒŠãƒ«",700],["è‡ªå®¶è£½ãƒ‘ãƒ³ãƒã‚§ãƒƒã‚¿ã¨ã‚³ãƒ¼ãƒ³ç†±æ¹¯é¢¨å‘‚","ã‚ªãƒªã‚¸ãƒŠãƒ«",700],["ãƒãƒ£ãƒ³ã‚¸ãƒ£ã¨ã‚¯ãƒªãƒ¼ãƒ ãƒãƒ¼ã‚ºã‚¿ãƒ‘ã‚¹","ã‚ªãƒªã‚¸ãƒŠãƒ«",700],["ãƒãƒ¼ãƒ–è±šãƒãƒ£ãƒ¼ã‚·ãƒ¥ãƒ¼ã‚¢ãƒ’ãƒ¼ã‚¸ãƒ§","ã‚ªãƒªã‚¸ãƒŠãƒ«",700],["ç ‚è‚ãƒãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ ã‚¢ãƒ’ãƒ¼ã‚¸ãƒ§","ã‚ªãƒªã‚¸ãƒŠãƒ«",700],["ã‚¿ã‚³ãƒãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ ã‚¢ãƒ’ãƒ¼ã‚¸ãƒ§","ã‚ªãƒªã‚¸ãƒŠãƒ«",700],["ãƒ”ãƒªè¾›ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸ã‚¢ãƒ’ãƒ¼ã‚¸ãƒ§","ã‚ªãƒªã‚¸ãƒŠãƒ«",700],["ãƒãƒ³ã‚º","ã‚ªãƒªã‚¸ãƒŠãƒ«",100],["ã¾ãã‚åˆºã—(æ•°é‡é™å®š)","åˆºèº«",700],["ã¨ã‚ã—ã‚ã•ã°","åˆºèº«",600],["ãŸã“é ­åˆºã—","åˆºèº«",600],["é¦¬åˆºã—(èµ¤èº«)","åˆºèº«",800],["é¦¬è‚‰ãƒ¦ãƒƒã‚±","åˆºèº«",850],["ã‚¨ã‚¤ãƒ’ãƒ¬","å¹²ç‰©",400],["ã“ã¾ã„ä¸€å¤œå¹²ã—","å¹²ç‰©",600],["ã—ã—ã‚ƒã‚‚","å¹²ç‰©",500],["é®­ã¨ã°","å¹²ç‰©",500],["ã™ã‚‹ã‚ã„ã‹","å¹²ç‰©",450],["ãŸã‚‰ã“ç„¼ã","å¹²ç‰©",450],["é³¥ã‚‚ã¤é‹(ä¸€äººå‰)","é‹ç‰©",1400],["è¾›é³¥ã‚‚ã¤é‹(ä¸€äººå‰)","é‹ç‰©",1500],["é´¨é‹(ä¸€äººå‰)","é‹ç‰©",1300],["æ¹¯ã©ã†ãµ(ä¸€äººå‰)","é‹ç‰©",800],["å˜å“é‡èœ","é‹ç‰©",500],["å˜å“ã‚‚ã¤é¡","é‹ç‰©",800],["é›‘ç‚Šã‚»ãƒƒãƒˆ","é‹ç‰©",350],["å˜å“ãã°","é‹ç‰©",300],["å†·ã—ãƒˆãƒãƒˆ","ã‚µãƒ©ãƒ€",400],["ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚µãƒ©ãƒ€","ã‚µãƒ©ãƒ€",600],["ãƒ„ãƒŠã‚µãƒ©ãƒ€","ã‚µãƒ©ãƒ€",700],["ç”Ÿãƒãƒ ã‚µãƒ©ãƒ€","ã‚µãƒ©ãƒ€",800],["ã‚‚ãšãé…¢","é…¢ã®ç‰©",350],["ãƒ”ã‚¯ãƒ«ã‚¹ã®ç››ã‚Šåˆã‚ã›","é…¢ã®ç‰©",550],["ã‚Šã‚ã—","ã”é£¯ç‰©",400],["ã‚„ãã¨ã‚Šä¸¼ã¶ã‚Š","ã”é£¯ç‰©",650],["ã‚‚ã¤ç…®è¾¼ã¿ä¸¼ã¶ã‚Š","ã”é£¯ç‰©",650],["ç‚™ã‚Šãƒãƒ£ãƒ¼ã‚·ãƒ¥ãƒ¼ä¸¼ã¶ã‚Š","ã”é£¯ç‰©",700],["ä¸‰èˆ¹ç‰¹è£½ã‚ªãƒ ãƒ©ã‚¤ã‚¹","ã”é£¯ç‰©",700],["å±±ã‚ã•ã³ä¸¼ã¶ã‚Š","ã”é£¯ç‰©",400],["ãƒ©ã‚¤ã‚¹å°","ã”é£¯ç‰©",200],["ãƒ©ã‚¤ã‚¹å¤§","ã”é£¯ç‰©",300],["é³¥ãŒã‚‰ãã°","éººé¡",450],["ç‰¹è£½ãƒ©ãƒ¼ãƒ¡ãƒ³(æ­£æ²¹)","éººé¡",750],["ç‰¹è£½ãƒãƒ£ãƒ¼ã‚·ãƒ¥ãƒ¼ãƒ¡ãƒ³","éººé¡",900],["ãƒã‚¿ãƒ¼ã‚³ãƒ¼ãƒ³ãƒ©ãƒ¼ãƒ¡ãƒ³","éººé¡",900],["ã‚‚ã¤ãã°æ¸©","éººé¡",600],["ã‚‚ã¤ã›ã„ã‚å†·","éººé¡",600],["é³¥ã›ã„ã‚å†·","éººé¡",600],["ã‹ã—ã‚ãã°æ¸©","éººé¡",600],["å†·ã‚€ã(å¤æœŸ)","éººé¡",500],["ã‚¹ãƒ¼ãƒ—","éººé¡",300],["ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ‰ãƒ©ã‚¤ ã€ˆå°ã€‰","ãƒ“ãƒ¼ãƒ«",500],["ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ‰ãƒ©ã‚¤ ã€ˆä¸­ã€‰","ãƒ“ãƒ¼ãƒ«",600],["ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ‰ãƒ©ã‚¤ ã€ˆå¤§ã€‰","ãƒ“ãƒ¼ãƒ«",700],["ã‚¢ã‚µãƒ’ ãƒãƒ«ã‚¨ãƒ• ã€ˆä¸­ç“¶ã€‰","ãƒ“ãƒ¼ãƒ«",700],["ãƒ©ã‚¬ãƒ¼ ã€ˆä¸­ç“¶ã€‰","ãƒ“ãƒ¼ãƒ«",700],["ãƒ›ãƒƒãƒ”ãƒ¼ ã‚»ãƒƒãƒˆ","ãƒ“ãƒ¼ãƒ«",600],["ãƒ›ãƒƒãƒ”ãƒ¼ç„¼é…ã®ã¿","ãƒ“ãƒ¼ãƒ«",300],["ã‚¢ã‚µãƒ’ãƒ‰ãƒ©ã‚¤ã‚¼ãƒ­","ãƒ“ãƒ¼ãƒ«",500],["ã‚½ãƒ©ãƒã‚¨ãƒ¼ã‚¹","ãƒ“ãƒ¼ãƒ«",800],["ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚µãƒ¯ãƒ¼","ã‚µãƒ¯ãƒ¼",500],["ãƒ¬ãƒ¢ãƒ³ã‚µãƒ¯ãƒ¼","ã‚µãƒ¯ãƒ¼",500],["ãƒ©ã‚¤ãƒ ã‚µãƒ¯ãƒ¼","ã‚µãƒ¯ãƒ¼",500],["ã‚«ã‚·ã‚¹ã‚µãƒ¯ãƒ¼","ã‚µãƒ¯ãƒ¼",500],["æ¢…ã‚µãƒ¯ãƒ¼","ã‚µãƒ¯ãƒ¼",500],["ã‚°ãƒ¬ãƒ¼ãƒ—ãƒ•ãƒ«ãƒ¼ãƒ„ã‚µãƒ¯ãƒ¼","ã‚µãƒ¯ãƒ¼",500],["ã¶ã©ã†ã‚µãƒ¯ãƒ¼","ã‚µãƒ¯ãƒ¼",500],["é’ã‚Šã‚“ã”ã‚µãƒ¯ãƒ¼","ã‚µãƒ¯ãƒ¼",500],["ã‚«ãƒ«ãƒ”ã‚¹ã‚µãƒ¯ãƒ¼","ã‚µãƒ¯ãƒ¼",500],["ã‚·ãƒ¼ã‚¯ã‚¡ãƒ¼ã‚µãƒ¼ã‚µãƒ¯ãƒ¼","ã‚µãƒ¯ãƒ¼",500],["ã‚¦ãƒ¼ãƒ­ãƒ³ãƒã‚¤","ã‚µãƒ¯ãƒ¼",500],["ç·‘èŒ¶ãƒã‚¤","ã‚µãƒ¯ãƒ¼",500],["ã‚³ãƒ¼ãƒ’ãƒ¼é…ãƒã‚¤","ã‚µãƒ¯ãƒ¼",500],["ç”Ÿãƒ¬ãƒ¢ãƒ³ã‚µãƒ¯ãƒ¼","ã‚µãƒ¯ãƒ¼",600],["ç”Ÿã‚°ãƒ¬ãƒ¼ãƒ—ã‚µãƒ¯ãƒ¼","ã‚µãƒ¯ãƒ¼",600],["èµ¤ãƒ¯ã‚¤ãƒ³","ãƒ¯ã‚¤ãƒ³",500],["ç™½ãƒ¯ã‚¤ãƒ³","ãƒ¯ã‚¤ãƒ³",500],["ç„¼é…(ãƒ­ãƒƒã‚¯/æ°´å‰²)","ç„¼é…",500],["ã‚å…­","ç„¼é…",700],["å±±ã­ã“","ç„¼é…",700],["å±±ã›ã¿","ç„¼é…",700],["å±±çŒ¿","ç„¼é…",700],["ä¸­ã€…","ç„¼é…",700],["é»’éœ§å³¶","ç„¼é…",700],["æµ·","ç„¼é…",700],["ãã˜ã‚‰","ç„¼é…",700],["ã‚ˆã‚ã—ãåƒè¬","ç„¼é…",700],["ãƒ‹ãƒƒã‚«éº¦ç„¼é…","ç„¼é…",700],["é‡‘é»’","ç„¼é…",700],["ã‚«ã‚·ã‚¹ã‚½ãƒ¼ãƒ€","ã‚«ã‚¯ãƒ†ãƒ«",550],["ã‚«ã‚·ã‚¹ã‚¦ãƒ¼ãƒ­ãƒ³","ã‚«ã‚¯ãƒ†ãƒ«",550],["ã‚«ã‚·ã‚¹ã‚ªãƒ¬ãƒ³ã‚¸","ã‚«ã‚¯ãƒ†ãƒ«",550],["ã‚«ã‚·ã‚¹ã‚°ãƒ¬ãƒ¼ãƒ—","ã‚«ã‚¯ãƒ†ãƒ«",550],["ã‚«ãƒ³ãƒ‘ãƒªã‚ªãƒ¬ãƒ³ã‚¸","ã‚«ã‚¯ãƒ†ãƒ«",550],["ã‚«ãƒ³ãƒ‘ãƒªã‚½ãƒ¼ãƒ€","ã‚«ã‚¯ãƒ†ãƒ«",550],["ã‚«ãƒ³ãƒ‘ãƒªãƒˆãƒ‹ãƒƒã‚¯","ã‚«ã‚¯ãƒ†ãƒ«",550],["ã‚¸ãƒ³ãƒˆãƒ‹ãƒƒã‚¯","ã‚«ã‚¯ãƒ†ãƒ«",550],["ã‚¸ãƒ³ãƒ©ã‚¤ãƒ ","ã‚«ã‚¯ãƒ†ãƒ«",550],["ãƒ©ãƒ ã‚³ãƒ¼ã‚¯","ã‚«ã‚¯ãƒ†ãƒ«",550],["ãƒ¯ã‚¤ãƒ³ã‚¯ãƒ¼ãƒ©ãƒ¼","ã‚«ã‚¯ãƒ†ãƒ«",550],["ã‚¯ãƒ¼ãƒ‹ãƒ£ãƒ³","ã‚«ã‚¯ãƒ†ãƒ«",550],["ãƒ•ã‚¡ã‚¸ãƒ¼ãƒãƒ¼ãƒ–ãƒ«","ã‚«ã‚¯ãƒ†ãƒ«",550],["ã‚·ãƒ£ãƒ³ãƒ‡ã‚£ã‚¬ãƒ•","ã‚«ã‚¯ãƒ†ãƒ«",550],["ãƒ¬ãƒƒãƒ‰ã‚¢ã‚¤","ã‚«ã‚¯ãƒ†ãƒ«",550],["ãƒ–ãƒ©ãƒƒãƒ‡ã‚£ãƒ¡ã‚¢ãƒª","ã‚«ã‚¯ãƒ†ãƒ«",550],["ã‚¹ã‚¯ãƒªãƒ¥ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ","ã‚«ã‚¯ãƒ†ãƒ«",550],["ãƒ–ãƒ«ãƒ‰ãƒƒã‚¯","ã‚«ã‚¯ãƒ†ãƒ«",550],["ãƒ¢ã‚¹ã‚³ãƒŸãƒ¥ãƒ¼ãƒ«","ã‚«ã‚¯ãƒ†ãƒ«",550],["ã‚¦ãƒ¼ãƒ­ãƒ³èŒ¶","ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯",350],["ã»ã†ã˜èŒ¶","ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯",350],["ã‚³ãƒ¼ãƒ©","ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯",350],["ã‚ªãƒ¬ãƒ³ã‚¸ã‚¸ãƒ¥ãƒ¼ã‚¹","ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯",350],["ã‚°ãƒ¬ãƒ¼ãƒ—ãƒ•ãƒ«ãƒ¼ãƒ„","ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯",350],["ã‚«ãƒ«ãƒ”ã‚¹","ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯",350],["ã‚«ãƒ«ãƒ”ã‚¹ã‚½ãƒ¼ãƒ€","ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯",350],["ãƒˆãƒãƒˆã‚¸ãƒ¥ãƒ¼ã‚¹","ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯",350],["ã‚¢ã‚¤ã‚¹ã‚³ãƒ¼ãƒ’ãƒ¼","ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯",350],["ç·‘èŒ¶","ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯",350],["ã‚¸ãƒ³ã‚¸ãƒ£ãƒ¼ã‚¨ãƒ¼ãƒ«","ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯",350],["ã‚¢ã‚¤ã‚¹ï¼ˆãƒãƒ‹ãƒ©ï¼‰","ãƒ‡ã‚¶ãƒ¼ãƒˆ",350],["ã‚³ãƒ¼ãƒ©ãƒ•ãƒ­ãƒ¼ãƒˆ","ãƒ‡ã‚¶ãƒ¼ãƒˆ",600],["ã‚³ãƒ¼ãƒ’ãƒ¼ãƒ•ãƒ­ãƒ¼ãƒˆ","ãƒ‡ã‚¶ãƒ¼ãƒˆ",600],["äºŒä¸–å¤","æ—¥æœ¬é…’",850],["ç¹æ¡","æ—¥æœ¬é…’",900],["ç¦å¸","æ—¥æœ¬é…’",850],["ã¾ã‚‹ç”°","æ—¥æœ¬é…’",900],["ç”·å±±","æ—¥æœ¬é…’",900],["çºç¥­","æ—¥æœ¬é…’",900],["åä¸€å·","æ—¥æœ¬é…’",900],["ä¹…ä¿ç”°","æ—¥æœ¬é…’",850],["ä¸€ãƒè”µ","æ—¥æœ¬é…’",800],["ã°ãã‚Œã‚“","æ—¥æœ¬é…’",800],["ãã©ãä¸Šæ‰‹","æ—¥æœ¬é…’",900],["åŒ—ã®å‹","æ—¥æœ¬é…’",800],["è¶Šå¾Œã§å€™","æ—¥æœ¬é…’",900],["æç™½","æ—¥æœ¬é…’",850],["å¸¸å±±","æ—¥æœ¬é…’",900],["é–‹é‹","æ—¥æœ¬é…’",900],["å¤§å’Œã—ãšã","æ—¥æœ¬é…’",900],["è¶Šä¹ƒå¯’æ¢…","æ—¥æœ¬é…’",800],["å…«æµ·å±±","æ—¥æœ¬é…’",800],["ã‚‚ã¤ä¸² ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ","ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ",150],["ç²¾è‚‰ ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ","ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ",170],["ã‚‚ã¤ç…®è¾¼ã¿ ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ","ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ",300],["é£²ã¿æ”¾é¡Œç”·æ€§90åˆ†","é£²ã¿æ”¾é¡Œ",2280],["é£²ã¿æ”¾é¡Œå¥³æ€§90åˆ†","é£²ã¿æ”¾é¡Œ",1980],["é£²ã¿æ”¾é¡Œå»¶é•·","é£²ã¿æ”¾é¡Œ",800],["ã‚‚ã¤ä¸²10æœ¬","ç„¡äºº",1000],["é³¥ç²¾è‚‰10æœ¬","ç„¡äºº",1000],["MIX10æœ¬","ç„¡äºº",1000],["å¼å½“A","ç„¡äºº",1000],["å¼å½“B","ç„¡äºº",1000]
];

const menuData = []; rawData.forEach(r => { let c = menuData.find(x => x.cat === r[1]); if(!c) { c = {cat: r[1], items: []}; menuData.push(c); } c.items.push({n: r[0], p: r[2]}); });
const tablesList = ['C-a', 'C-b', 'C-c', '01', '02', '03', '04', '05', '06', '07', 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ', 'ç„¡äºº'];
let currentTable = "", currentCart = [], tempGuestCount = "1";
const PRINTER_URL = 'http://192.168.1.XX/StarWebPRNT/SendMessage';
const isTestMode = true;

function hideAll() { document.querySelectorAll('.view').forEach(v => v.style.display = 'none'); }
function renderIndex() { const grid = document.getElementById('table-grid'); if(!grid) return; grid.innerHTML = tablesList.map(t => { const hist = JSON.parse(localStorage.getItem('history_'+t) || '[]'); const total = hist.reduce((s, i) => s + Math.floor(i.price*i.qty*(1+i.rate)), 0); return `<div class="table-btn ${total>0?'occupied':''}" onclick="onTableClick('${t}')"><b>${t}</b><span class="price-badge">${total>0?'Â¥'+total.toLocaleString():'ç©ºå¸­'}</span></div>`; }).join(''); }
function showIndex() { window.isEditing = false; hideAll(); document.getElementById('view-index').style.display = 'flex'; renderIndex(); }
function onTableClick(tId) { currentTable = tId; if(localStorage.getItem('history_' + tId)) showMenu(); else showGuestInput(); }

function checkAdminAuth() { if(window.currentUser) showAdmin(); else { hideAll(); document.getElementById('view-login').style.display = 'flex'; } }
function handleLogin() { const e = document.getElementById('login-email').value; const p = document.getElementById('login-pass').value; window.loginOwner(e, p); }

async function showAdmin() {
    hideAll(); document.getElementById('view-admin').style.display = 'flex';
    document.getElementById('sales-list').innerHTML = '<p style="text-align:center; padding:50px;">ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­...</p>';
    const sales = await window.getSalesData('day'); let total = 0, guests = 0;
    document.getElementById('sales-list').innerHTML = sales.map(s => {
        total += s.total; guests += s.guests;
        return `<div class="sale-card"><div class="sale-header"><span>${s.checkout} (${s.tableId}ç•ª)</span><span>Â¥${s.total.toLocaleString()}</span></div><div>å®¢: ${s.guests}å / å…¥åº—: ${s.checkin}</div><div style="color:#888; font-size:10px;">${s.items.map(i => i.name+'x'+i.qty).join(', ')}</div></div>`;
    }).join('') || '<p style="text-align:center; padding:50px;">ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
    document.getElementById('sum-total').innerText = total.toLocaleString();
    document.getElementById('sum-guests').innerText = guests;
    document.getElementById('sum-count').innerText = sales.length;
}

async function printReport(mode) {
    const sales = await window.getSalesData(mode); if(sales.length === 0) return alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
    let total = 0, guests = 0, sub = 0, tx = 0; sales.forEach(s => { total += s.total; guests += s.guests; sub += s.subtotal; tx += s.tax; });
    const b = new StarWebPrintBuilder(); let r = b.createInitializationElement();
    r += b.createAlignmentElement({position: 'center'});
    r += b.createTextElement({data: `ç¾å”„ç„¼é³¥ä¸‰èˆ¹ æ±æœ­å¹Œåº—\n`, width:2, height:1});
    r += b.createTextElement({data: `${mode==='day'?'ã€æ—¥è¨ˆå ±å‘Šã€‘':'ã€æœˆè¨ˆå ±å‘Šã€‘'}\n`, width:2, height:2});
    r += b.createAlignmentElement({position: 'left'});
    r += b.createTextElement({data: `--------------------------------\nä»¶æ•°: ${sales.length} ä»¶ / å®¢æ•°: ${guests} å\n--------------------------------\nç¨åˆ¥: Â¥${sub.toLocaleString()}\næ¶ˆè²»ç¨: Â¥${tx.toLocaleString()}\nç¨è¾¼åˆè¨ˆ:\n`, width:1, height:1});
    r += b.createTextElement({data: `      Â¥${total.toLocaleString()}\n`, width:2, height:2});
    r += b.createCutPaperElement({type: 'partial'});
    const trader = new StarWebPrintTrader({url: PRINTER_URL}); trader.sendMessage({request: r});
    alert("å°åˆ·ã—ã¾ã—ãŸã€‚");
}

function showGuestInput() {
    hideAll(); tempGuestCount = "1"; document.getElementById('guest-table-name').innerText = currentTable + "ç•ªå¸­";
    document.getElementById('guest-count-val').innerText = tempGuestCount; document.getElementById('view-guest').style.display = 'flex';
    const k = document.getElementById('guest-keypad');
    k.innerHTML = [1,2,3,4,5,6,7,8,9,'C',0,'æ±ºå®š'].map(num => {
        let s = num === 'æ±ºå®š' ? 'background:var(--accent); color:#fff;' : '';
        let f = num === 'æ±ºå®š' ? 'confirmGuestCount()' : (num === 'C' ? 'clearGuestNum()' : `inputGuestNum(${num})`);
        return `<button class="key-btn" style="${s}" onclick="${f}">${num}</button>`;
    }).join('');
}
function inputGuestNum(n) { if(tempGuestCount === "0") tempGuestCount = n.toString(); else if(tempGuestCount.length < 2) tempGuestCount += n.toString(); document.getElementById('guest-count-val').innerText = tempGuestCount; }
function clearGuestNum() { tempGuestCount = "0"; document.getElementById('guest-count-val').innerText = tempGuestCount; }
async function confirmGuestCount() {
    let count = parseInt(tempGuestCount); if(count < 1) return alert("å®¢æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    localStorage.setItem('guests_' + currentTable, count);
    const now = new Date(); localStorage.setItem('checkin_' + currentTable, now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0'));
    if(window.cloudSync) await window.cloudSync(currentTable); showMenu();
}
function showMenu() {
    window.isEditing = false; currentCart = JSON.parse(localStorage.getItem('cart_'+currentTable) || '[]');
    hideAll(); document.getElementById('view-menu').style.display = 'flex';
    document.getElementById('display-table-id').innerText = currentTable;
    document.getElementById('display-guest-count').innerText = localStorage.getItem('guests_' + currentTable) || "1";
    document.getElementById('display-checkin-time').innerText = localStorage.getItem('checkin_' + currentTable) || "--:--";
    renderSidebar(); renderItems(menuData[0]); updateFooter();
}
function renderSidebar() { const side = document.getElementById('side-cats'); side.innerHTML = menuData.map((d, idx) => `<div class="cat" onclick="changeCat(this, ${idx})">${d.cat}</div>`).join(''); side.children[0].classList.add('active'); }
function changeCat(el, idx) { document.querySelectorAll('.cat').forEach(c => c.classList.remove('active')); el.classList.add('active'); renderItems(menuData[idx]); }
function renderItems(category) {
    const container = document.getElementById('display-items'); const rate = (category.cat === "ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ" || category.cat === "ç„¡äºº") ? 0.08 : 0.10;
    container.innerHTML = category.items.map((item, idx) => {
        const taxInc = Math.floor(item.p * (1 + rate));
        return `<div class="item-card"><div class="item-info"><span class="item-name">${item.n}</span><span class="item-price">Â¥${item.p.toLocaleString()} <small style="font-size:10px; color:#999;">(ç¨è¾¼Â¥${taxInc.toLocaleString()})</small></span></div>
        <div class="qty-ctrl"><div class="btn-circle" onclick="changeQty('q${idx}', -1)">-</div><span id="q${idx}" style="font-weight:bold; min-width:18px; text-align:center;">1</span><div class="btn-circle" onclick="changeQty('q${idx}', 1)">+</div>
        <button class="btn-add" onclick="addToCart('${item.n}', ${item.p}, 'q${idx}', ${rate})">è¿½åŠ </button></div></div>`;
    }).join('');
    container.scrollTop = 0;
}
function changeQty(id, d) { const el = document.getElementById(id); let v = parseInt(el.innerText) + d; if(v >= 1) el.innerText = v; }
function addToCart(name, price, qId, rate) {
    const qty = parseInt(document.getElementById(qId).innerText); const exist = currentCart.find(i => i.name === name);
    if(exist) exist.qty += qty; else currentCart.push({name, price, qty, rate});
    localStorage.setItem('cart_'+currentTable, JSON.stringify(currentCart)); updateFooter(); document.getElementById(qId).innerText = 1;
}

function changeCartQty(idx, delta) { currentCart[idx].qty += delta; if(currentCart[idx].qty < 1) currentCart[idx].qty = 1; localStorage.setItem('cart_'+currentTable, JSON.stringify(currentCart)); renderCartUI(); updateFooter(); }
function removeFromCart(idx) { currentCart.splice(idx, 1); localStorage.setItem('cart_'+currentTable, JSON.stringify(currentCart)); renderCartUI(); updateFooter(); }
function renderCartUI() { document.getElementById('cart-items-list').innerHTML = currentCart.map((i, idx) => `<div class="list-row"><div style="flex:1;"><b>${i.name}</b><br><small>Â¥${i.price.toLocaleString()} x ${i.qty}</small></div><div style="display:flex; align-items:center; gap:8px;"><div class="btn-circle" onclick="changeCartQty(${idx}, -1)">-</div><span style="font-weight:bold; min-width:24px; text-align:center;">${i.qty}</span><div class="btn-circle" onclick="changeCartQty(${idx}, 1)">+</div><button class="btn-del" onclick="removeFromCart(${idx})">å‰Šé™¤</button></div></div>`).join('') || '<p style="text-align:center;padding:50px;color:#999;">ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™</p>'; }
function showCart() { window.isEditing = true; hideAll(); document.getElementById('view-cart').style.display = 'flex'; renderCartUI(); }

function changeHistoryQty(idx, delta) {
    const hist = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]');
    hist[idx].qty += delta;
    if(hist[idx].qty <= 0) { if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return; hist.splice(idx, 1); }
    localStorage.setItem('history_'+currentTable, JSON.stringify(hist));
    renderHistoryUI();
}
function renderHistoryUI() {
    const hist = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]');
    let sub = 0, tax = 0;
    document.getElementById('history-items-list').innerHTML = hist.map((i, idx) => {
        const lp = i.price * i.qty; const lt = Math.floor(lp * i.rate); sub += lp; tax += lt;
        return `<div class="list-row"><div><b>${i.name}</b><br><small>ç¨è¾¼Â¥${(lp+lt).toLocaleString()} (ç¨åˆ¥Â¥${lp.toLocaleString()})</small></div>
            <div style="display:flex; align-items:center; gap:10px;"><div class="btn-circle" onclick="changeHistoryQty(${idx}, -1)">-</div>
                <span style="font-weight:bold; min-width:25px; text-align:center;">${i.qty}</span><div class="btn-circle" onclick="changeHistoryQty(${idx}, 1)">+</div>
            </div></div>`;
    }).join('') || '<p style="text-align:center;padding:50px;">å±¥æ­´ãªã—</p>';
    document.getElementById('history-summary').innerHTML = `<div style="color:#666; font-size:13px;">å…¥åº—: ${localStorage.getItem('checkin_'+currentTable)} / å®¢æ•°: ${localStorage.getItem('guests_'+currentTable)}å</div>
        <div>ç¨åˆ¥åˆè¨ˆ: Â¥${sub.toLocaleString()} / æ¶ˆè²»ç¨: Â¥${tax.toLocaleString()}<br><span style="font-size:24px; color:var(--primary); font-weight:bold;">ç¨è¾¼åˆè¨ˆ: Â¥${(sub + tax).toLocaleString()}</span></div>`;
}
async function confirmHistoryChange() { if(window.cloudSync) await window.cloudSync(currentTable); alert("åŒæœŸå®Œäº†"); }
function exitEditing() { window.isEditing = false; showMenu(); }
function showOrderHistory() { window.isEditing = true; hideAll(); document.getElementById('view-history').style.display = 'flex'; renderHistoryUI(); }

function showCheckout() {
    const hist = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]');
    const total = hist.reduce((s, i) => s + Math.floor(i.price*i.qty*(1+i.rate)), 0);
    document.getElementById('checkout-final-total').innerText = "Â¥" + total.toLocaleString();
    document.getElementById('checkout-final-info').innerText = `å…¥åº— ${localStorage.getItem('checkin_'+currentTable)} / å®¢æ•° ${localStorage.getItem('guests_'+currentTable)}å`;
    hideAll(); document.getElementById('view-checkout').style.display = 'flex';
}
function updateFooter() { document.getElementById('cart-count').innerText = currentCart.reduce((s, i) => s + i.qty, 0); const hist = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]'); const total = hist.reduce((s, i) => s + Math.floor(i.price*i.qty*(1+i.rate)), 0); document.getElementById('display-current-total').innerText = "ç¨è¾¼åˆè¨ˆ: Â¥" + total.toLocaleString(); }

function openReceiptChoice() { if (isTestMode) { document.getElementById('receipt-preview-area').style.display = 'block'; renderReceiptSample(); } document.getElementById('overlay-receipt').style.display = 'flex'; }
function renderReceiptSample() {
    const hist = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]'); const guests = localStorage.getItem('guests_'+currentTable) || 1; const checkin = localStorage.getItem('checkin_'+currentTable) || "--:--"; let sub = 0, tx = 0;
    let html = `<div class="text-center text-bold">ç¾å”„ç„¼é³¥ä¸‰èˆ¹ æ±æœ­å¹Œåº—</div><div class="text-center">æœ­å¹Œå¸‚ç™½çŸ³åŒºæ±æœ­å¹Œ2æ¡3ä¸ç›®9-2</div><div class="receipt-hr"></div><div>æ—¥æ™‚: ${new Date().toLocaleString()}</div><div>å¸­: ${currentTable} å®¢: ${guests}å å…¥åº—: ${checkin}</div><div class="receipt-hr"></div>`;
    hist.forEach(i => { const line = i.price*i.qty; sub += line; tx += Math.floor(line * i.rate); html += `<div>${i.name}</div><div style="display:flex; justify-content:space-between;"><span>&nbsp;${i.qty}ç‚¹ x Â¥${i.price.toLocaleString()}</span><span>Â¥${line.toLocaleString()}</span></div>`; });
    html += `<div class="receipt-hr"></div><div class="text-right">ç¨åˆ¥è¨ˆ: Â¥${sub.toLocaleString()} / æ¶ˆè²»ç¨: Â¥${tx.toLocaleString()}</div><div class="text-right text-bold" style="font-size:14px;">ç¨è¾¼åˆè¨ˆ: Â¥${(sub+tx).toLocaleString()}</div>`;
    document.getElementById('sample-receipt-content').innerHTML = html;
}
function closeReceiptChoice() { document.getElementById('overlay-receipt').style.display = 'none'; }

async function testSend() {
    if(currentCart.length === 0) return alert("ç©ºã§ã™");
    const hist = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]');
    localStorage.setItem('history_'+currentTable, JSON.stringify(hist.concat(currentCart))); localStorage.removeItem('cart_'+currentTable); currentCart = [];
    if(window.cloudSync) await window.cloudSync(currentTable); hideAll(); document.getElementById('view-success').style.display = 'flex'; updateFooter();
}
async function testPay() { if(window.saveSaleToCloud) await window.saveSaleToCloud(currentTable); showIndex(); }

async function sendToKitchen() {
    if(currentCart.length === 0) return;
    const builder = new StarWebPrintBuilder(); let request = builder.createInitializationElement();
    const guestNum = localStorage.getItem('guests_'+currentTable); const checkin = localStorage.getItem('checkin_'+currentTable);
    request += builder.createAlignmentElement({position: 'center'}); request += builder.createTextElement({data: `--- æ³¨æ–‡: ${currentTable}ç•ª --- \n`, width: 2, height: 2}); request += builder.createTextElement({data: `å…¥åº—: ${checkin} / å®¢æ•°: ${guestNum}å\n\n`}); request += builder.createAlignmentElement({position: 'left'});
    currentCart.forEach(i => { request += builder.createTextElement({data: `${(i.name).padEnd(10)} x ${i.qty}\n`, width: 2, height: 2}); });
    request += builder.createCutPaperElement({type: 'partial'});
    const trader = new StarWebPrintTrader({url: PRINTER_URL});
    trader.onReceive = async () => {
        const hist = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]');
        localStorage.setItem('history_'+currentTable, JSON.stringify(hist.concat(currentCart))); localStorage.removeItem('cart_'+currentTable); currentCart = [];
        if(window.cloudSync) await window.cloudSync(currentTable); hideAll(); document.getElementById('view-success').style.display = 'flex'; updateFooter();
    };
    trader.sendMessage({request: request});
}

async function pay(doPrint) {
    closeReceiptChoice(); const hist = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]'); const guests = localStorage.getItem('guests_'+currentTable); const checkin = localStorage.getItem('checkin_'+currentTable);
    const builder = new StarWebPrintBuilder(); let request = builder.createInitializationElement(); request += builder.createPeripheralElement({channel: 1, pulse: 200});
    if(doPrint) {
        let sub = 0, tx = 0; request += builder.createAlignmentElement({position: 'center'}); request += builder.createTextElement({data: `ç¾å”„ç„¼é³¥ä¸‰èˆ¹ æ±æœ­å¹Œåº—\n`, width: 2, height: 2}); request += builder.createTextElement({data: `æœ­å¹Œå¸‚ç™½çŸ³åŒºæ±æœ­å¹Œ2æ¡3ä¸ç›®9-2\n\n`}); request += builder.createAlignmentElement({position: 'left'});
        request += builder.createTextElement({data: `æ—¥æ™‚: ${new Date().toLocaleString()}\nå¸­: ${currentTable} å®¢: ${guests}å å…¥åº—: ${checkin}\n--------------------------------\n`});
        hist.forEach(i => { const line = i.price*i.qty; sub += line; tx += Math.floor(line*i.rate); request += builder.createTextElement({data: `${i.name}\n  ${i.qty}ç‚¹ x Â¥${i.price.toLocaleString()}    Â¥${line.toLocaleString()}\n`}); });
        request += builder.createTextElement({data: `--------------------------------\n`}); request += builder.createAlignmentElement({position: 'right'}); request += builder.createTextElement({data: `ç¨åˆ¥è¨ˆ: Â¥${sub.toLocaleString()} / æ¶ˆè²»ç¨: Â¥${tx.toLocaleString()}\nå£²ä¸Šåˆè¨ˆ: Â¥${(sub + tx).toLocaleString()}\n`, width: 2, height: 2});
        request += builder.createAlignmentElement({position: 'center'}); request += builder.createTextElement({data: `\n[ç™»éŒ²ç•ªå·] T4430001061003\næ ªå¼ä¼šç¤¾Stag Beetle Corporation\n\n`}); request += builder.createCutPaperElement({type: 'partial'});
    }
    const trader = new StarWebPrintTrader({url: PRINTER_URL});
    trader.onReceive = async () => { if(window.saveSaleToCloud) await window.saveSaleToCloud(currentTable); showIndex(); };
    trader.sendMessage({request: request});
}

// èµ·å‹•æ™‚ã«å®Ÿè¡Œ
renderIndex();
</script>
</body>
</html>
