<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ä¸‰èˆ¹ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ POS</title>
<link rel="apple-touch-icon" href="apple-touch-icon.png">
    <script src="StarWebPrintBuilder.js"></script>
<script src="StarWebPrintTrader.js"></script>
<style>
:root { --primary: #f39c12; --secondary: #fbb03b; --bg: #f8f8f8; --text: #333; --accent: #2ecc71; --gray: #999; --danger: #e74c3c; --info: #3498db; --dark: #444; }
* { touch-action: manipulation; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
body { font-family: sans-serif; margin: 0; background: var(--bg); color: var(--text); -webkit-user-select: none; overflow: hidden; height: 100vh; height: 100dvh; }
header { background: #fff; padding: 0 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; font-weight: bold; height: 55px; flex-shrink: 0; }
.header-left { display: flex; align-items: center; gap: 10px; }
.back-btn { text-decoration: none; color: var(--text); font-size: 26px; cursor: pointer; padding: 10px 5px; }
.reload-btn { font-size: 28px; cursor: pointer; padding: 10px; color: var(--primary); font-weight: bold; }
.admin-btn { font-size: 13px; cursor: pointer; padding: 8px 15px; border: 1px solid var(--primary); border-radius: 25px; color: var(--primary); background: #fff; white-space: nowrap; }
.view { display: none; height: 100vh; height: 100dvh; width: 100vw; flex-direction: column; position: absolute; top: 0; left: 0; background: var(--bg); }
.view.active { display: flex; }
.grid-tables { display: grid; grid-template-columns: repeat(3, 1fr); grid-auto-rows: min-content; gap: 10px; padding: 15px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
.table-btn { background: #fff; border: 2px solid var(--accent); padding: 15px 5px; text-align: center; border-radius: 12px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.05); min-height: 95px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
.table-btn.occupied { background: #e8f5e9; border-color: #27ae60; }
.price-badge { display: block; font-size: 11px; color: #e67e22; margin-top: 5px; font-weight: bold; }
.login-container { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 25px; background: #fff; }
.login-title { font-size: 24px; font-weight: bold; margin-bottom: 40px; color: var(--dark); }
.login-input { width: 100%; max-width: 450px; padding: 25px; margin-bottom: 25px; border: 3px solid #ddd; border-radius: 18px; font-size: 28px; background: #fafafa; -webkit-appearance: none; }
.guest-input-container { text-align: center; padding: 20px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; justify-content: center; }
.guest-num-display { font-size: 60px; font-weight: bold; margin-bottom: 20px; color: var(--primary); background: #eee; border-radius: 15px; padding: 15px; width: 100%; max-width: 400px; margin-left: auto; margin-right: auto; }
.keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; max-width: 450px; margin: 0 auto; }
.key-btn { background: #fff; border: 1px solid #ddd; padding: 25px 0; font-size: 32px; font-weight: bold; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; }
.menu-container { display: flex; flex: 1; overflow: hidden; }
.sidebar { width: 105px; background: #f0f0f0; overflow-y: auto; border-right: 1px solid #ddd; flex-shrink: 0; box-sizing: border-box; padding-bottom: 150px !important; }
.cat { padding: 20px 8px; font-size: 13px; text-align: center; border-bottom: 1px solid #ddd; cursor: pointer; color: #555; line-height: 1.4; }
.cat.active { background: #fff; color: var(--primary); font-weight: bold; border-left: 6px solid var(--primary); }
.item-grid { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; align-content: start; background: #fff; padding-bottom: 150px !important; }
.item-card { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 12px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 2px 8px rgba(0,0,0,0.06); min-height: 170px; }
.item-name { font-weight: bold; font-size: 14px; height: 2.8em; overflow: hidden; line-height: 1.4; margin-bottom: 5px; }
.item-price { color: #e67e22; font-weight: bold; font-size: 15px; margin-bottom: 8px; }
.qty-ctrl { display: flex; align-items: center; justify-content: space-between; border-top: 1px solid #f0f0f0; padding-top: 10px; }
.btn-circle { width: 38px; height: 38px; border-radius: 50%; border: 1px solid #ccc; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; }
.btn-add { background: var(--primary); color: #fff; border: none; padding: 12px 0; border-radius: 25px; font-size: 15px; font-weight: bold; flex: 1; margin-left: 10px; box-shadow: 0 3px 6px rgba(243,156,18,0.3); }
footer { width: 100%; display: flex; flex-direction: column; z-index: 100; box-shadow: 0 -3px 10px rgba(0,0,0,0.1); flex-shrink: 0; }
.footer-history { background: var(--dark); color: #fff; padding: 10px 15px; display: flex; justify-content: space-between; font-size: 14px; cursor: pointer; }
.footer-cart { background: var(--secondary); color: #fff; padding: 18px 15px; display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; cursor: pointer; }
.list-container { flex: 1; overflow-y: auto; background: #fff; -webkit-overflow-scrolling: touch; padding-bottom: 100px; }
.list-row { display: flex; justify-content: space-between; padding: 18px; border-bottom: 1px solid #eee; align-items: center; }
.summary-area { padding: 15px 25px; text-align: right; background: #fff; border-top: 2px solid #eee; flex-shrink: 0; line-height: 1.6; font-size: 15px; }
.btn-large { width: 90%; display: block; margin: 10px auto; padding: 20px; border: none; border-radius: 40px; font-size: 20px; font-weight: bold; cursor: pointer; text-align: center; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

.admin-nav { display: flex; background: #fff; border-bottom: 1px solid #ddd; flex-shrink: 0; }
.admin-nav-btn { flex: 1; padding: 15px; text-align: center; font-size: 14px; font-weight: bold; color: #888; cursor: pointer; border-bottom: 3px solid transparent; }
.admin-nav-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
.sale-card { background: #fff; margin: 12px; padding: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative; border-left: 10px solid var(--info); }
.sale-time-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
.sale-time { font-size: 18px; font-weight: bold; color: var(--dark); }
.sale-table-badge { background: #eee; padding: 4px 10px; border-radius: 8px; font-size: 14px; font-weight: bold; }
.sale-detail-info { font-size: 14px; color: #666; margin-bottom: 10px; }
.sale-total-line { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
.sale-price-big { font-size: 24px; font-weight: bold; color: var(--primary); }
.btn-del-sale { background: var(--danger); color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; }
.report-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 15px; background: #fff; border-bottom: 1px solid #ddd; flex-shrink: 0; }
.btn-report { background: var(--info); color: #fff; border: none; padding: 22px 0; border-radius: 12px; font-weight: bold; font-size: 17px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; }
.overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; justify-content: center; align-items: center; padding: 20px 0; }
.modal { background: #fff; width: 90%; max-width: 340px; border-radius: 20px; padding: 20px; text-align: center; position: relative; max-height: 90dvh; overflow-y: auto; }
.receipt-sample { background: #fff; padding: 15px; color: #000; font-family: monospace; text-align: left; font-size: 11px; border: 1px dashed #ccc; width: 100%; }
.receipt-hr { border-top: 1px dashed #000; margin: 5px 0; }
</style>
</head>
<body>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, addDoc, query, orderBy, getDocs, where, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const firebaseConfig = {
apiKey: "AIzaSyDscuD0S3D66lcamtG4T26WLfZH8rjOy28",
authDomain: "mifune-ap2.firebaseapp.com",
projectId: "mifune-ap2",
storageBucket: "mifune-ap2.firebasestorage.app",
messagingSenderId: "25505732783",
appId: "1:25505732783:web:47278f159ad7a26f279c5a",
measurementId: "G-7F8BM4SBGR"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

window.currentUser = null;
window.isEditing = false;

onAuthStateChanged(auth, (user) => {
window.currentUser = user;
const btnLabel = document.getElementById('admin-btn-label');
if(user) {
btnLabel.innerText = "å£²ä¸Šç®¡ç†(åº—ä¸»)";
btnLabel.style.background = "#e8f5e9";
if(document.getElementById('view-login').style.display !== 'none') showAdmin('day');
} else {
btnLabel.innerText = "å£²ä¸Šç®¡ç†";
btnLabel.style.background = "#fff";
}
});

window.loginOwner = async (email, pass) => {
try {
await signInWithEmailAndPassword(auth, email, pass);
alert("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ");
showAdmin('day');
} catch(e) { alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã”ç¢ºèªãã ã•ã„"); }
};

window.logoutOwner = () => { signOut(auth); alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†"); showIndex(); };

onSnapshot(collection(db, "tables"), (snapshot) => {
if(window.isEditing) return;
const tablesList = ['C-a', 'C-b', 'C-c', '01', '02', '03', '04', '05', '06', '07', 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ', 'ç„¡äºº'];
const cloudIds = snapshot.docs.map(d => d.id);
tablesList.forEach(tId => {
if(!cloudIds.includes(tId)) {
localStorage.removeItem('history_'+tId); localStorage.removeItem('guests_'+tId); localStorage.removeItem('checkin_'+tId);
}
});
snapshot.forEach((doc) => {
const tId = doc.id; const data = doc.data();
localStorage.setItem('history_'+tId, JSON.stringify(data.history || []));
localStorage.setItem('guests_'+tId, data.guests || 0);
localStorage.setItem('checkin_'+tId, data.checkin || "--:--");
});
renderIndex(); updateFooter();
});

window.cloudSync = async (tableId) => {
await setDoc(doc(db, "tables", tableId), {
history: JSON.parse(localStorage.getItem('history_' + tableId) || '[]'),
guests: parseInt(localStorage.getItem('guests_' + tableId)) || 0,
checkin: localStorage.getItem('checkin_' + tableId) || "--:--",
updatedAt: Timestamp.now()
});
};

window.saveSaleToCloud = async (tableId) => {
const hist = JSON.parse(localStorage.getItem('history_' + tableId) || '[]');
if(hist.length === 0) return;
const guests = parseInt(localStorage.getItem('guests_' + tableId)) || 0;
const checkin = localStorage.getItem('checkin_' + tableId) || "--:--";
let subtotal = 0, tax = 0;
hist.forEach(i => { subtotal += i.price * i.qty; tax += Math.floor(i.price * i.qty * i.rate); });

try {
    await addDoc(collection(db, "sales"), {
        tableId: tableId, guests: guests, checkin: checkin,
        checkout: new Date().getHours().toString().padStart(2, '0') + ":" + new Date().getMinutes().toString().padStart(2, '0'),
        items: hist, subtotal: subtotal, tax: tax, total: subtotal + tax, timestamp: Timestamp.now()
    });
} catch (e) { console.error("Sales data could not be saved:", e); }

await deleteDoc(doc(db, "tables", tableId));
};

window.getSalesData = async (mode) => {
const now = new Date();
const { getDocs, collection, getFirestore, query } = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js");
const snap = await getDocs(collection(db, "sales"));
let res = [];
snap.forEach(d => {
    let data = d.data(); data.id = d.id;
    const date = data.timestamp.toDate();
    if (mode === 'day' && date.toDateString() === now.toDateString()) res.push(data);
    else if (mode === 'month' && date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear()) res.push(data);
    else if (mode === 'dow') res.push(data);
    else if (mode === 'dates') res.push(data);
});
return res.sort((a,b) => b.timestamp - a.timestamp);
};

window.deleteSaleDoc = async (id) => { if(confirm("æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { await deleteDoc(doc(db, "sales", id)); await new Promise(r => setTimeout(r, 500)); window.showAdmin('day'); } };
window.deleteDaySales = async (label) => {
    const entry = Object.values(window._dayDeleteMap || {}).find(x => x.label === label);
    if (!entry) return alert("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    if (confirm(`${label} ã®${entry.ids.length}ä»¶ã‚’ã¾ã¨ã‚ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        await Promise.all(entry.ids.map(id => deleteDoc(doc(db, "sales", id))));
        await new Promise(r => setTimeout(r, 500));
        window.showAdmin('dates');
    }
};
window.cloudDelete = async (tableId) => { await deleteDoc(doc(db, "tables", tableId)); };
</script>

<div id="view-index" class="view active"><header><div class="admin-btn" id="admin-btn-label" onclick="checkAdminAuth()">å£²ä¸Šç®¡ç†</div><span>ä¸‰èˆ¹ å¸­é¸æŠ</span><div class="reload-btn" onclick="location.reload()">â†»</div></header><div class="grid-tables" id="table-grid"></div></div>

<div id="view-login" class="view">
<header><div class="header-left"><span class="back-btn" onclick="showIndex()">ï¼œ</span><span>èªè¨¼</span></div></header>
<div class="login-container"><div style="font-weight:bold; margin-bottom:20px;">ã‚ªãƒ¼ãƒŠãƒ¼ãƒ­ã‚°ã‚¤ãƒ³</div><input type="email" id="login-email" class="login-input" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"><input type="password" id="login-pass" class="login-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"><button class="btn-large" style="background:var(--primary); color:white; margin-top:20px;" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦è¡¨ç¤º</button></div>
</div>

<div id="view-admin" class="view">
<header><div class="header-left"><span class="back-btn" onclick="showIndex()">ï¼œ</span><span>å£²ä¸Šç®¡ç†</span></div><div style="font-size:12px; color:var(--danger);" onclick="logoutOwner()">çµ‚äº†</div></header>
<div class="admin-nav"><div id="nav-day" class="admin-nav-btn active" onclick="showAdmin('day')">æœ¬æ—¥</div><div id="nav-dates" class="admin-nav-btn" onclick="showAdmin('dates')">æ—¥åˆ¥</div><div id="nav-dow" class="admin-nav-btn" onclick="showAdmin('dow')">æ›œæ—¥åˆ¥</div><div id="nav-month" class="admin-nav-btn" onclick="showAdmin('month')">æœˆåˆ¥</div></div>
<div id="admin-summary-area" style="padding:15px; background:var(--dark); color:#fff; display:flex; justify-content:space-around; text-align:center; font-size:13px;"><div>ä»¶æ•°<br><span id="sum-count" style="font-size:20px; font-weight:bold;">0</span></div><div>å®¢æ•°<br><span id="sum-guests" style="font-size:20px; font-weight:bold;">0</span></div><div>åˆè¨ˆ<br>Â¥<span id="sum-total" style="font-size:20px; font-weight:bold;">0</span></div></div>
<div class="report-btns"><button class="btn-report" onclick="printReport('day')">æ—¥è¨ˆå°åˆ·</button><button class="btn-report" onclick="printReport('month')" style="background:var(--accent);">æœˆè¨ˆå°åˆ·</button></div>
<div class="list-container" id="sales-list" style="background:#f4f4f4; padding:5px 0;"></div>
</div>

<div id="view-guest" class="view"><header><span class="back-btn" onclick="showIndex()">ï¼œ</span>å®¢æ•°å…¥åŠ›</header><div class="guest-input-container"><h2 id="guest-table-name"></h2><div class="guest-num-display"><span id="guest-count-val">0</span> å</div><div class="keypad" id="guest-keypad"></div></div></div>
<div id="view-menu" class="view">
<header><span class="back-btn" onclick="showIndex()">Ã—</span><span id="display-table-id"></span>ç•ªå¸­ (<span id="display-guest-count"></span>å)<span style="margin-left:auto; font-size:11px; color:#666;">å…¥åº—: <span id="display-checkin-time"></span></span></header>
<div class="menu-container"><div class="sidebar" id="side-cats"></div><div class="item-grid" id="display-items"></div></div>
<footer><div class="footer-history" onclick="showOrderHistory()"><span>æ³¨æ–‡æ¸ˆåˆè¨ˆ</span><span id="display-current-total">Â¥0</span></div><div class="footer-cart" onclick="showCart()"><div>ğŸ›’ <span id="cart-count">0</span>ç‚¹</div><div>æ³¨æ–‡ã‚’ç¢ºèª ï¼</div></div></footer>
</div>
<div id="view-cart" class="view"><header><span class="back-btn" onclick="exitEditing()">ï¼œ</span>ã‚«ãƒ¼ãƒˆç¢ºèª</header><div class="list-container" id="cart-items-list"></div><div style="background:#fff; border-top:1px solid #eee; padding-bottom:10px;"><button class="btn-large" style="background:var(--info); color:white;" onclick="testSend()">é€ä¿¡(åŒæœŸã®ã¿)</button><button class="btn-large" style="background:var(--primary);color:white;" onclick="sendToKitchen()">æœ¬ç•ªé€ä¿¡</button></div></div>
<div id="view-history" class="view"><header><span class="back-btn" onclick="exitEditing()">ï¼œ</span>ä¿®æ­£</header><div class="list-container" id="history-items-list"></div><div class="summary-area" id="history-summary"></div><div style="background:#fff; border-top:1px solid #ddd; padding-bottom:10px;"><button class="btn-large" style="background:var(--accent); color:white;" onclick="confirmHistoryChange()">ä¿å­˜ã—ã¦åŒæœŸ</button><button class="btn-large" style="background:var(--secondary); color:white;" onclick="showCheckout()">ãŠä¼šè¨ˆç¢ºå®šã¸</button></div></div>
<div id="view-checkout" class="view"><header><span class="back-btn" onclick="showOrderHistory()">ï¼œ</span>ä¼šè¨ˆç¢ºå®š</header><div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;"><div style="padding:30px 20px; background:#fff; border-radius:15px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.1); width:85%;"><div id="checkout-final-total" style="font-size:40px; font-weight:bold; color:var(--primary);">Â¥0</div><div id="checkout-final-info" style="color:#666; font-size:12px;"></div></div></div><button class="btn-large" style="background:var(--info); color:white;" onclick="testPay()">ã€ãƒ†ã‚¹ãƒˆã€‘ä¼šè¨ˆå®Œäº†</button><button class="btn-large" style="background:var(--accent);color:white;" onclick="openReceiptChoice()">æœ¬ç•ªä¼šè¨ˆ</button><button class="btn-large" style="background:#8e44ad; color:white;" onclick="openRyoshuusho()">ğŸ“„ é ˜åæ›¸ç™ºè¡Œ</button></div>
<div id="overlay-receipt" class="overlay"><div class="modal"><div id="receipt-preview-area" style="display:none;"><div class="modal-title">å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div><div id="sample-receipt-content" class="receipt-sample"></div></div><div class="modal-title" id="receipt-modal-main-title">å°åˆ·ã—ã¾ã™ã‹ï¼Ÿ</div><button class="btn-large" style="background:var(--primary); color:white;" onclick="pay(true)">å°åˆ·ã—ã¦å®Œäº†</button><button class="btn-large" style="background:var(--gray); color:white;" onclick="pay(false)">å°åˆ·ã›ãšã«å®Œäº†</button><div style="margin-top:15px; color:var(--info); font-size:12px; cursor:pointer;" onclick="closeReceiptChoice()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div></div></div>
<div id="view-success" class="view" style="text-align:center; justify-content:center;"><h2>é€ä¿¡å®Œäº†</h2><button class="btn-large" style="background:var(--primary);color:white;" onclick="showMenu()">æˆ»ã‚‹</button></div>

<!-- â–¼â–¼â–¼ é ˜åæ›¸æ©Ÿèƒ½è¿½åŠ  â–¼â–¼â–¼ -->
<!-- é ˜åæ›¸ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="overlay-ryoshuusho" class="overlay">
  <div class="modal">
    <div style="font-weight:bold; font-size:18px; margin-bottom:15px;">ğŸ“„ é ˜åæ›¸ç™ºè¡Œ</div>
    <div style="text-align:left; margin-bottom:10px; font-size:13px; color:#666;">å®›åï¼ˆç©ºç™½ã§ã€Œä¸Šæ§˜ã€ï¼‰</div>
    <input type="text" id="ryoshuusho-atena" placeholder="ä¸Šæ§˜" style="width:100%; padding:12px 15px; border:2px solid #ddd; border-radius:12px; font-size:16px; margin-bottom:12px; box-sizing:border-box; -webkit-appearance:none;">
    <div style="text-align:left; margin-bottom:10px; font-size:13px; color:#666;">ä½†ã—æ›¸ã</div>
    <input type="text" id="ryoshuusho-tadashi" placeholder="ãŠé£Ÿäº‹ä»£ã¨ã—ã¦" style="width:100%; padding:12px 15px; border:2px solid #ddd; border-radius:12px; font-size:16px; margin-bottom:20px; box-sizing:border-box; -webkit-appearance:none;">
    <div id="ryoshuusho-preview" class="receipt-sample" style="margin-bottom:15px; font-size:12px;"></div>
    <button class="btn-large" style="background:var(--primary); color:white; margin-bottom:8px;" onclick="printRyoshuusho()">å°åˆ·ã™ã‚‹</button>
    <button class="btn-large" style="background:var(--gray); color:white;" onclick="closeRyoshuusho()">é–‰ã˜ã‚‹</button>
  </div>
</div>
<!-- â–²â–²â–² é ˜åæ›¸æ©Ÿèƒ½è¿½åŠ  â–²â–²â–² -->

<script>
// --- å•†å“ãƒ‡ãƒ¼ã‚¿ (ã”æç¤ºãƒªã‚¹ãƒˆå®Œå…¨åæ˜ ) ---
const rawData = [
    ["ãŠé€šã—", "ãŠé€šã—", 300],
    ["ã‚‚ã¤ä¸²", "ç¾å”„ç„¼é³¥", 150],
    ["é³¥ç²¾è‚‰", "ç¾å”„ç„¼é³¥", 170],
    ["é£²ã¿æ”¾é¡Œç”·æ€§90åˆ†", "é£²ã¿æ”¾é¡Œ", 2280],
    ["é£²ã¿æ”¾é¡Œå¥³æ€§90åˆ†", "é£²ã¿æ”¾é¡Œ", 1980],
    ["é£²ã¿æ”¾é¡Œå»¶é•·", "é£²ã¿æ”¾é¡Œ", 800],
    ["æ‰‹ç¾½ç„¼ãï¼ˆ2æœ¬ï¼‰", "ç„¼ãç‰©", 400],
    ["å›½ç”£è±šã®ãƒ­ãƒ¼ã‚¹ç¶²ç„¼ãã‚¹ãƒ†ãƒ¼ã‚­", "ç„¼ãç‰©", 600],
    ["ãƒãƒ¼ãƒ•è±šã®ç¶²ç„¼ãã‚¹ãƒ†ãƒ¼ã‚­ï¼ˆ1æšï¼‰", "ç„¼ãç‰©", 700],
    ["ãƒãƒ¼ãƒ•è±šã®ç‚™ã‚Šãƒãƒ£ãƒ¼ã‚·ãƒ¥ãƒ¼", "ç„¼ãç‰©", 600],
    ["è‡ªå®¶è£½ã¤ãã­ã®ã‚³ãƒ­ã‚³ãƒ­ç„¼ãï¼ˆ4ç‰ï¼‰", "ç„¼ãç‰©", 400],
    ["ã•ã•ã¿ä¸²ç„¼ãï¼ˆæ•°é‡é™å®š 1ä¸²ï¼‰", "ç„¼ãç‰©", 250],
    ["é´¨è‚‰ã®ç¶²ç„¼ã", "ç„¼ãç‰©", 600],
    ["ãƒ”ãƒªè¾›ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸ï¼ˆ2æœ¬ï¼‰", "ç„¼ãç‰©", 400],
    ["ãƒ©ãƒ ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸ï¼ˆ2æœ¬ï¼‰", "ç„¼ãç‰©", 500],
    ["ã†ãšã‚‰ã®ç‰å­ï¼ˆ1ä¸²ï¼‰", "ç„¼ãç‰©", 150],
    ["è‚‰åšã—ã„ãŸã‘ï¼ˆ2å€‹ï¼‰", "ç„¼ãç‰©", 300],
    ["ãƒ—ãƒãƒˆãƒãƒˆï¼ˆ1ä¸²ï¼‰", "ç„¼ãç‰©", 150],
    ["ã‚ºãƒƒã‚­ãƒ¼ãƒ‹ï¼ˆ1ä¸²ï¼‰", "ç„¼ãç‰©", 150],
    ["é•·ãªã™ä¸²ç„¼ãï¼ˆ1ä¸²ï¼‰", "ç„¼ãç‰©", 300],
    ["è»Ÿç™½ã­ãï¼ˆ1ä¸²ï¼‰", "ç„¼ãç‰©", 300],
    ["ã—ã—ã¨ã†ï¼ˆ2ä¸²ï¼‰", "ç„¼ãç‰©", 300],
    ["ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«ã«ã‚“ã«ãã‚«ãƒƒãƒ—ç„¼ã", "ç„¼ãç‰©", 500],
    ["ç„¼ãã˜ã‚ƒãŒãƒã‚¿ãƒ¼ï¼ˆ2å€‹ï¼‰", "ç„¼ãç‰©", 500],
    ["ç„¼ãã˜ã‚ƒãŒãƒã‚¿ãƒ¼ï¼ˆå¡©è¾›ä»˜ãï¼‰ï¼ˆ2å€‹ï¼‰", "ç„¼ãç‰©", 600],
    ["ã„ã‚‚ã‚‚ã¡ãƒã‚¿ãƒ¼ï¼ˆ4å€‹ï¼‰", "ç„¼ãç‰©", 400],
    ["ã•ã•ã¿ä¸²ï¼ˆè‡ªå®¶è£½å¡©ã“ã†ã˜æ¼¬ã‘ï¼‰", "ç„¼ãç‰©", 300],
    ["ãƒ­ãƒ¼ã‚¹ç¶²ç„¼ãã‚¹ãƒ†ãƒ¼ã‚­ï¼ˆè‡ªå®¶è£½å¡©ã“ã†ã˜æ¼¬ã‘ï¼‰", "ç„¼ãç‰©", 750],
    ["é³¥ã‚‚ã¤ç…®è¾¼ã¿", "ä¸€å“æ–™ç†", 400],
    ["ç‰¹è£½ä¸€å£ã‚¶ãƒ³ã‚®", "ä¸€å“æ–™ç†", 550],
    ["æ‰‹ç¾½ã‚¶ãƒ³ã‚®(3æœ¬)", "ä¸€å“æ–™ç†", 550],
    ["è‹¥é¶ã®çš®ç«œç”°æšã’(ãŠã‚ã—ãƒãƒ³é…¢ä»˜ã)", "ä¸€å“æ–™ç†", 550],
    ["ã‚µã‚µãƒŸã‚«ãƒ„(2æš)", "ä¸€å“æ–™ç†", 600],
    ["å›½ç”£è±šã®ãƒ­ãƒ¼ã‚¹ã‚«ãƒ„", "ä¸€å“æ–™ç†", 700],
    ["ã‚³ãƒ¼ãƒ³ãƒã‚¿ãƒ¼ãƒ»ãƒãƒ¼ã‚ºã‚«ãƒƒãƒ—", "ä¸€å“æ–™ç†", 500],
    ["ç”Ÿãƒãƒ ã®è»Ÿç™½ã­ãåŒ…ã¿(å²©å¡©ä»˜ã)", "ä¸€å“æ–™ç†", 650],
    ["å¡©ã‚­ãƒ£ãƒ™ã‚­ãƒ¥", "ä¸€å“æ–™ç†", 350],
    ["æ¼¬ç‰©", "ä¸€å“æ–™ç†", 350],
    ["æè±†", "ä¸€å“æ–™ç†", 350],
    ["å†·å¥´", "ä¸€å“æ–™ç†", 400],
    ["å±±ã‚ã•ã³å†·å¥´", "ä¸€å“æ–™ç†", 400],
    ["ãªã‚ã“ãŠã‚ã—", "ä¸€å“æ–™ç†", 400],
    ["ã‚«ãƒ‹ã¿ãã¨ã†ãµ", "ä¸€å“æ–™ç†", 400],
    ["ãƒãƒ£ãƒ³ã‚¸ãƒ£", "ä¸€å“æ–™ç†", 400],
    ["ã‚¤ã‚«ã®å¡©è¾›", "ä¸€å“æ–™ç†", 400],
    ["ãŸã“ã‚ã•ã³", "ä¸€å“æ–™ç†", 400],
    ["ã»ãŸã¦ã‚ã•ã³", "ä¸€å“æ–™ç†", 400],
    ["æ•°ã®å­å…¥ã‚Šæ¾å‰æ¼¬ã‘", "ä¸€å“æ–™ç†", 400],
    ["ã‚¯ã‚¸ãƒ©ã®ãƒ™ãƒ¼ã‚³ãƒ³ ã­ãæ­£æ²¹ã‚ãˆ", "ä¸€å“æ–™ç†", 700],
    ["è‡ªå®¶è£½ãƒ‘ãƒ³ãƒã‚§ãƒƒã‚¿ã¨ãƒ¡ãƒ¼ã‚¯ã‚¤ãƒ³ã®ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«ãƒ»ãƒãƒ¼ã‚ºç†±æ¹¯é¢¨å‘‚", "ã‚ªãƒªã‚¸ãƒŠãƒ«", 700],
    ["è‡ªå®¶è£½ãƒ‘ãƒ³ãƒã‚§ãƒƒã‚¿ã¨ã‚³ãƒ¼ãƒ³ã®ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«ãƒ»ãƒãƒ¼ã‚ºç†±æ¹¯é¢¨å‘‚", "ã‚ªãƒªã‚¸ãƒŠãƒ«", 700],
    ["ãƒãƒ£ãƒ³ã‚¸ãƒ£ã¨ã‚¯ãƒªãƒ¼ãƒ ãƒãƒ¼ã‚ºã®ã‚¿ãƒ‘ã‚¹(ãŠã¤ã¾ã¿æ–™ç†)", "ã‚ªãƒªã‚¸ãƒŠãƒ«", 700],
    ["ãƒãƒ¼ãƒ–è±šãƒãƒ£ãƒ¼ã‚·ãƒ¥ãƒ¼ã¨ãƒãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ ã®ã‚¢ãƒ’ãƒ¼ã‚¸ãƒ§", "ã‚ªãƒªã‚¸ãƒŠãƒ«", 700],
    ["ç ‚è‚ã¨ãƒãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ ã®ã‚¢ãƒ’ãƒ¼ã‚¸ãƒ§", "ã‚ªãƒªã‚¸ãƒŠãƒ«", 700],
    ["ã‚¿ã‚³ã¨ãƒãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ ã®ã‚¢ãƒ’ãƒ¼ã‚¸ãƒ§", "ã‚ªãƒªã‚¸ãƒŠãƒ«", 700],
    ["ãƒ”ãƒªè¾›ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸ã¨ãƒãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ ã®ã‚¢ãƒ’ãƒ¼ã‚¸ãƒ§", "ã‚ªãƒªã‚¸ãƒŠãƒ«", 700],
    ["ãƒãƒ³ã‚º", "ã‚ªãƒªã‚¸ãƒŠãƒ«", 100],
    ["ã¾ãã‚åˆºã—(æ•°é‡é™å®š)", "åˆºèº«", 700],
    ["ã¨ã‚ã—ã‚ã•ã°", "åˆºèº«", 600],
    ["ãŸã“é ­åˆºã—", "åˆºèº«", 600],
    ["é¦¬åˆºã—(èµ¤èº«)", "åˆºèº«", 800],
    ["é¦¬è‚‰ãƒ¦ãƒƒã‚±", "åˆºèº«", 850],
    ["ã‚¨ã‚¤ãƒ’ãƒ¬", "å¹²ç‰©", 400],
    ["ã“ã¾ã„ä¸€å¤œå¹²ã—", "å¹²ç‰©", 600],
    ["ã—ã—ã‚ƒã‚‚", "å¹²ç‰©", 500],
    ["é®­ã¨ã°", "å¹²ç‰©", 500],
    ["ã™ã‚‹ã‚ã„ã‹", "å¹²ç‰©", 450],
    ["ãŸã‚‰ã“ç„¼ã", "å¹²ç‰©", 450],
    ["é³¥ã‚‚ã¤é‹(ä¸€äººå‰)", "é‹ç‰©", 1400],
    ["è¾›é³¥ã‚‚ã¤é‹(ä¸€äººå‰)", "é‹ç‰©", 1500],
    ["é´¨é‹(ä¸€äººå‰)", "é‹ç‰©", 1300],
    ["æ¹¯ã©ã†ãµ(ä¸€äººå‰)", "é‹ç‰©", 800],
    ["ã€è¿½åŠ ã€‘å˜å“é‡èœ", "é‹ç‰©", 500],
    ["ã€è¿½åŠ ã€‘å˜å“ã‚‚ã¤é¡", "é‹ç‰©", 800],
    ["ã€è¿½åŠ ã€‘é›‘ç‚Šã‚»ãƒƒãƒˆ", "é‹ç‰©", 350],
    ["ã€è¿½åŠ ã€‘å˜å“ãã°", "é‹ç‰©", 300],
    ["å†·ã—ãƒˆãƒãƒˆ", "ã‚µãƒ©ãƒ€", 400],
    ["ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚µãƒ©ãƒ€", "ã‚µãƒ©ãƒ€", 600],
    ["ãƒ„ãƒŠã‚µãƒ©ãƒ€", "ã‚µãƒ©ãƒ€", 700],
    ["ç”Ÿãƒãƒ ã‚µãƒ©ãƒ€", "ã‚µãƒ©ãƒ€", 800],
    ["ã‚‚ãšãé…¢", "é…¢ã®ç‰©", 350],
    ["ãƒ”ã‚¯ãƒ«ã‚¹ã®ç››ã‚Šåˆã‚ã›", "é…¢ã®ç‰©", 550],
    ["ç¾å”„åç‰©ã¨ã‚Šã‚ã—", "ã”é£¯ç‰©", 400],
    ["ã‚„ãã¨ã‚Šä¸¼ã¶ã‚Š", "ã”é£¯ç‰©", 650],
    ["ã‚‚ã¤ç…®è¾¼ã¿ä¸¼ã¶ã‚Š", "ã”é£¯ç‰©", 650],
    ["ç‚™ã‚Šãƒãƒ£ãƒ¼ã‚·ãƒ¥ãƒ¼ä¸¼ã¶ã‚Š", "ã”é£¯ç‰©", 700],
    ["ä¸‰èˆ¹ç‰¹è£½ã‚ªãƒ ãƒ©ã‚¤ã‚¹", "ã”é£¯ç‰©", 700],
    ["å±±ã‚ã•ã³ä¸¼ã¶ã‚Š", "ã”é£¯ç‰©", 400],
    ["ãƒ©ã‚¤ã‚¹(å°)", "ã”é£¯ç‰©", 200],
    ["ãƒ©ã‚¤ã‚¹(å¤§)", "ã”é£¯ç‰©", 300],
    ["ä¸‰èˆ¹åç‰©é³¥ãŒã‚‰ãã°", "éººé¡", 450],
    ["ä¸‰èˆ¹ç‰¹è£½ãƒ©ãƒ¼ãƒ¡ãƒ³(æ­£æ²¹å‘³ã®ã¿)", "éººé¡", 750],
    ["ä¸‰èˆ¹ç‰¹è£½ãƒãƒ£ãƒ¼ã‚·ãƒ¥ãƒ¼ãƒ¡ãƒ³", "éººé¡", 900],
    ["ãƒã‚¿ãƒ¼ã‚³ãƒ¼ãƒ³ãƒ©ãƒ¼ãƒ¡ãƒ³", "éººé¡", 900],
    ["ã‚‚ã¤ãã°(æ¸©)", "éººé¡", 600],
    ["ã‚‚ã¤ã›ã„ã‚ãã°(å†·)", "éººé¡", 600],
    ["é³¥ã›ã„ã‚ãã°(å†·)", "éººé¡", 600],
    ["ã‹ã—ã‚ãã°(æ¸©)", "éººé¡", 600],
    ["å†·ã‚€ã(å¤æœŸ)", "éººé¡", 500],
    ["ã‚¹ãƒ¼ãƒ—(ç‰å­)", "ã‚¹ãƒ¼ãƒ—", 300],
    ["ã‚¹ãƒ¼ãƒ—(ã‚ã‹ã‚)", "ã‚¹ãƒ¼ãƒ—", 300],
    ["ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ‰ãƒ©ã‚¤ ã€ˆå°ã€‰", "ãƒ“ãƒ¼ãƒ«", 500],
    ["ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ‰ãƒ©ã‚¤ ã€ˆä¸­ã€‰", "ãƒ“ãƒ¼ãƒ«", 600],
    ["ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ‰ãƒ©ã‚¤ ã€ˆå¤§ã€‰", "ãƒ“ãƒ¼ãƒ«", 700],
    ["ã‚¢ã‚µãƒ’ ãƒãƒ«ã‚¨ãƒ• ã€ˆä¸­ç“¶ã€‰", "ãƒ“ãƒ¼ãƒ«", 700],
    ["ãƒ©ã‚¬ãƒ¼ ã€ˆä¸­ç“¶ã€‰", "ãƒ“ãƒ¼ãƒ«", 700],
    ["ãƒ›ãƒƒãƒ”ãƒ¼ ã‚»ãƒƒãƒˆã€ˆç™½ãƒ»é»’ã€‰", "ãƒ“ãƒ¼ãƒ«", 600],
    ["ãƒ›ãƒƒãƒ”ãƒ¼ã®ç„¼é…ã®ã¿", "ãƒ“ãƒ¼ãƒ«", 300],
    ["ã‚¢ã‚µãƒ’ãƒ‰ãƒ©ã‚¤ã‚¼ãƒ­ ã€ˆä¸­ç“¶ã€‰", "ãƒ“ãƒ¼ãƒ«", 500],
    ["ã‚½ãƒ©ãƒã‚¨ãƒ¼ã‚¹", "ãƒ“ãƒ¼ãƒ«", 800],
    ["ãƒã‚¤ãƒœãƒ¼ãƒ«", "ãƒã‚¤ãƒœãƒ¼ãƒ«", 500],
    ["ã‚³ãƒ¼ãƒ©ãƒã‚¤ãƒœãƒ¼ãƒ«", "ãƒã‚¤ãƒœãƒ¼ãƒ«", 550],
    ["ã‚¸ãƒ³ã‚¸ãƒ£ãƒ¼ãƒã‚¤ãƒœãƒ¼ãƒ«", "ãƒã‚¤ãƒœãƒ¼ãƒ«", 550],
    ["æ¢…é…’ãƒ­ãƒƒã‚¯", "æ¢…é…’", 500],
    ["æ¢…é…’ã‚½ãƒ¼ãƒ€", "æ¢…é…’", 500],
    ["ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500],
    ["ãƒ¬ãƒ¢ãƒ³ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500],
    ["ãƒ©ã‚¤ãƒ ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500],
    ["ã‚«ã‚·ã‚¹ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500],
    ["æ¢…ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500],
    ["ã‚°ãƒ¬ãƒ¼ãƒ—ãƒ•ãƒ«ãƒ¼ãƒ„ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500],
    ["ã¶ã©ã†ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500],
    ["é’ã‚Šã‚“ã”ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500],
    ["ã‚«ãƒ«ãƒ”ã‚¹ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500],
    ["ã‚·ãƒ¼ã‚¯ã‚¡ãƒ¼ã‚µãƒ¼ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 500],
    ["ã‚¦ãƒ¼ãƒ­ãƒ³ãƒã‚¤", "ã‚µãƒ¯ãƒ¼", 500],
    ["ç·‘èŒ¶ãƒã‚¤", "ã‚µãƒ¯ãƒ¼", 500],
    ["ã‚³ãƒ¼ãƒ’ãƒ¼é…ãƒã‚¤", "ã‚µãƒ¯ãƒ¼", 500],
    ["ç”Ÿæ¾ã‚Šãƒ¬ãƒ¢ãƒ³ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 600],
    ["ç”Ÿæ¾ã‚Šã‚°ãƒ¬ãƒ¼ãƒ—ãƒ•ãƒ«ãƒ¼ãƒ„ã‚µãƒ¯ãƒ¼", "ã‚µãƒ¯ãƒ¼", 600],
    ["ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³ï¼ˆèµ¤ï¼‰", "ãƒ¯ã‚¤ãƒ³", 500],
    ["ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³ï¼ˆç™½ï¼‰", "ãƒ¯ã‚¤ãƒ³", 500],
    ["ç„¼é…ç”²é¡ï¼ˆãƒ­ãƒƒã‚¯ãƒ»æ°´å‰²ã‚Šï¼‰", "ç„¼é…", 500],
    ["ã‚å…­ï¼ˆãã‚ãï¼‰ ã€ˆå®®å´ãƒ»èŠ‹ã€‰", "ç„¼é…", 700],
    ["å±±ã­ã“ ã€ˆå®®å´ãƒ»èŠ‹ã€‰", "ç„¼é…", 700],
    ["å±±ã›ã¿ ã€ˆå®®å´ãƒ»ç±³ã€‰", "ç„¼é…", 700],
    ["å±±çŒ¿ ã€ˆå®®å´ãƒ»éº¦ã€‰", "ç„¼é…", 700],
    ["ä¸­ã€… ã€ˆå®®å´ãƒ»éº¦ã€‰", "ç„¼é…", 700],
    ["é»’éœ§å³¶ ã€ˆå®®å´ãƒ»èŠ‹ã€‰", "ç„¼é…", 700],
    ["æµ· ã€ˆé¹¿å…å³¶ãƒ»èŠ‹ã€‰", "ç„¼é…", 700],
    ["ãã˜ã‚‰ ã€ˆé¹¿å…å³¶ãƒ»èŠ‹ã€‰", "ç„¼é…", 700],
    ["ã‚ˆã‚ã—ãåƒè¬ã‚ã‚‹ã¹ã— ã€ˆæ–°æ½Ÿãƒ»ç±³ã€‰", "ç„¼é…", 700],
    ["ãƒ‹ãƒƒã‚«ãƒ»ã‚¶ãƒ»éº¦ç„¼é… ã€ˆç¦å²¡ãƒ»éº¦ã€‰", "ç„¼é…", 700],
    ["é‡‘é»’ ã€ˆç¦å²¡ãƒ»èŠ‹ã€‰", "ç„¼é…", 700],
    ["ã‚«ã‚·ã‚¹ã‚½ãƒ¼ãƒ€", "ã‚«ã‚¯ãƒ†ãƒ«", 550],
    ["ã‚«ã‚·ã‚¹ã‚¦ãƒ¼ãƒ­ãƒ³", "ã‚«ã‚¯ãƒ†ãƒ«", 550],
    ["ã‚«ã‚·ã‚¹ã‚ªãƒ¬ãƒ³ã‚¸", "ã‚«ã‚¯ãƒ†ãƒ«", 550],
    ["ã‚«ã‚·ã‚¹ã‚°ãƒ¬ãƒ¼ãƒ—ãƒ•ãƒ«ãƒ¼ãƒ„", "ã‚«ã‚¯ãƒ†ãƒ«", 550],
    ["ã‚«ãƒ³ãƒ‘ãƒªã‚ªãƒ¬ãƒ³ã‚¸", "ã‚«ã‚¯ãƒ†ãƒ«", 550],
    ["ã‚«ãƒ³ãƒ‘ãƒªã‚½ãƒ¼ãƒ€", "ã‚«ã‚¯ãƒ†ãƒ«", 550],
    ["ã‚«ãƒ³ãƒ‘ãƒªãƒˆãƒ‹ãƒƒã‚¯", "ã‚«ã‚¯ãƒ†ãƒ«", 550],
    ["ã‚¸ãƒ³ãƒˆãƒ‹ãƒƒã‚¯", "ã‚«ã‚¯ãƒ†ãƒ«", 550],
    ["ã‚¸ãƒ³ãƒ©ã‚¤ãƒ ", "ã‚«ã‚¯ãƒ†ãƒ«", 550],
    ["ãƒ©ãƒ ã‚³ãƒ¼ã‚¯", "ã‚«ã‚¯ãƒ†ãƒ«", 550],
    ["ãƒ¯ã‚¤ãƒ³ã‚¯ãƒ¼ãƒ©ãƒ¼", "ã‚«ã‚¯ãƒ†ãƒ«", 550],
    ["ã‚¯ãƒ¼ãƒ‹ãƒ£ãƒ³", "ã‚«ã‚¯ãƒ†ãƒ«", 550],
    ["ãƒ•ã‚¡ã‚¸ãƒ¼ãƒãƒ¼ãƒ–ãƒ«", "ã‚«ã‚¯ãƒ†ãƒ«", 550],
    ["ã‚·ãƒ£ãƒ³ãƒ‡ã‚£ã‚¬ãƒ•", "ã‚«ã‚¯ãƒ†ãƒ«", 550],
    ["ãƒ¬ãƒƒãƒ‰ã‚¢ã‚¤", "ã‚«ã‚¯ãƒ†ãƒ«", 550],
    ["ãƒ–ãƒ©ãƒƒãƒ‡ã‚£ãƒ¡ã‚¢ãƒªãƒ¼", "ã‚«ã‚¯ãƒ†ãƒ«", 550],
    ["ã‚¹ã‚¯ãƒªãƒ¥ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒãƒ¼", "ã‚«ã‚¯ãƒ†ãƒ«", 550],
    ["ãƒ–ãƒ«ãƒ‰ãƒƒã‚¯", "ã‚«ã‚¯ãƒ†ãƒ«", 550],
    ["ãƒ¢ã‚¹ã‚³ãƒŸãƒ¥ãƒ¼ãƒ«", "ã‚«ã‚¯ãƒ†ãƒ«", 550],
    ["ã‚¦ãƒ¼ãƒ­ãƒ³èŒ¶", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350],
    ["ã»ã†ã˜èŒ¶", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350],
    ["ã‚³ãƒ¼ãƒ©", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350],
    ["ã‚ªãƒ¬ãƒ³ã‚¸ã‚¸ãƒ¥ãƒ¼ã‚¹", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350],
    ["ã‚°ãƒ¬ãƒ¼ãƒ—ãƒ•ãƒ«ãƒ¼ãƒ„ã‚¸ãƒ¥ãƒ¼ã‚¹", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350],
    ["ã‚«ãƒ«ãƒ”ã‚¹", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350],
    ["ã‚«ãƒ«ãƒ”ã‚¹ã‚½ãƒ¼ãƒ€", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350],
    ["ãƒˆãƒãƒˆã‚¸ãƒ¥ãƒ¼ã‚¹", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350],
    ["ã‚¢ã‚¤ã‚¹ã‚³ãƒ¼ãƒ’ãƒ¼", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350],
    ["ç·‘èŒ¶", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350],
    ["ã‚¸ãƒ³ã‚¸ãƒ£ãƒ¼ã‚¨ãƒ¼ãƒ«", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯", 350],
    ["ã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ ï¼ˆãƒãƒ‹ãƒ©ï¼‰", "ãƒ‡ã‚¶ãƒ¼ãƒˆ", 350],
    ["ã‚³ãƒ¼ãƒ©ãƒ•ãƒ­ãƒ¼ãƒˆ", "ãƒ‡ã‚¶ãƒ¼ãƒˆ", 600],
    ["ã‚³ãƒ¼ãƒ’ãƒ¼ãƒ•ãƒ­ãƒ¼ãƒˆ", "ãƒ‡ã‚¶ãƒ¼ãƒˆ", 600],
    ["æ²¢ã®é¶´ 1åˆ", "æ—¥æœ¬é…’", 400],
    ["æ²¢ã®é¶´ 2åˆ", "æ—¥æœ¬é…’", 600],
    ["äºŒä¸–å¤ï¼ˆç‰¹åˆ¥ç´”ç±³æ–°é…’ã—ã¼ã‚Šï¼‰", "æ—¥æœ¬é…’", 850],
    ["ç¹æ¡ï¼ˆç‰¹åˆ¥ç´”ç±³ç”Ÿã€…ï¼‰", "æ—¥æœ¬é…’", 900],
    ["ç¦å¸ï¼ˆç´”ç±³é…’ï¼‰", "æ—¥æœ¬é…’", 850],
    ["ã¾ã‚‹ç”°ï¼ˆç‰¹åˆ¥ç´”ç±³ï¼‰", "æ—¥æœ¬é…’", 900],
    ["ç”·å±±ï¼ˆç´”ç±³ç”Ÿé…’ï¼‰", "æ—¥æœ¬é…’", 900],
    ["çºç¥­ï¼ˆç´”ç±³å¤§åŸé†¸ï¼‰", "æ—¥æœ¬é…’", 900],
    ["åä¸€å·ï¼ˆåŸé†¸ã—ã¼ã‚ŠãŸã¦ï¼‰", "æ—¥æœ¬é…’", 900],
    ["ä¹…ä¿ç”°ï¼ˆæ¸…é…’ï¼‰", "æ—¥æœ¬é…’", 850],
    ["ä¸€ãƒè”µï¼ˆæœ¬é†¸é€ è¾›å£ï¼‰", "æ—¥æœ¬é…’", 800],
    ["ã°ãã‚Œã‚“ï¼ˆåŸé†¸è¶…è¾›å£ï¼‰", "æ—¥æœ¬é…’", 800],
    ["ãã©ãä¸Šæ‰‹ï¼ˆç´”ç±³åŸé†¸è¾›å£ï¼‰", "æ—¥æœ¬é…’", 900],
    ["åŒ—ã®å‹ï¼ˆæ¸…é…’ï¼‰", "æ—¥æœ¬é…’", 800],
    ["è¶Šå¾Œã§å€™ï¼ˆã—ã¼ã‚ŠãŸã¦ç”ŸåŸé…’ï¼‰", "æ—¥æœ¬é…’", 900],
    ["æç™½ï¼ˆç‰¹åˆ¥ç´”ç±³é…’ï¼‰", "æ—¥æœ¬é…’", 850],
    ["å¸¸å±±ï¼ˆã¨ã³ã£ãã‚Šè¾›å£ï¼‰", "æ—¥æœ¬é…’", 900],
    ["é–‹é‹ï¼ˆç„¡æ¿¾éç´”ç±³é…’ï¼‰", "æ—¥æœ¬é…’", 900],
    ["å¤§å’Œã—ãšãï¼ˆç´”ç±³åŸé†¸ï¼‰", "æ—¥æœ¬é…’", 900],
    ["è¶Šä¹ƒå¯’æ¢…ï¼ˆæ¸…é…’ï¼‰", "æ—¥æœ¬é…’", 800],
    ["å…«æµ·å±±ï¼ˆæ¸…é…’ï¼‰", "æ—¥æœ¬é…’", 800],
    ["ã‚‚ã¤ä¸² ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ", "ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ", 150],
    ["ç²¾è‚‰ ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ", "ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ", 170],
    ["ã‚‚ã¤ç…®è¾¼ã¿ ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ", "ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ", 300],
    ["ã‚‚ã¤ä¸²10æœ¬", "ç„¡äºº", 1000],
    ["é³¥ç²¾è‚‰10æœ¬", "ç„¡äºº", 1000],
    ["ã‚‚ã¤ã€ç²¾è‚‰ MIX 10æœ¬", "ç„¡äºº", 1000],
    ["å¼å½“A", "ç„¡äºº", 1000],
    ["å¼å½“B", "ç„¡äºº", 1000]
];

// --- ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ†é¡ãƒ­ã‚¸ãƒƒã‚¯ (æ§‹é€ ç¶­æŒ) ---
const menuData = []; const allCat = { cat: "å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼", items: [] }; rawData.forEach(r => { allCat.items.push({n: r[0], p: r[2], c: r[1]}); let c = menuData.find(x => x.cat === r[1]); if(!c) { c = {cat: r[1], items: []}; menuData.push(c); } c.items.push({n: r[0], p: r[2]}); }); menuData.unshift(allCat);

// â–¼â–¼â–¼ äººæ°—ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ©Ÿèƒ½è¿½åŠ  â–¼â–¼â–¼
async function buildPopularCategory() {
    const tablesAll = ['C-a', 'C-b', 'C-c', '01', '02', '03', '04', '05', '06', '07', 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ', 'ç„¡äºº'];
    const countMap = {};
    // ç¾åœ¨å–¶æ¥­ä¸­ãƒ†ãƒ¼ãƒ–ãƒ«ã®localStorageã‹ã‚‰é›†è¨ˆ
    tablesAll.forEach(tId => {
        const hist = JSON.parse(localStorage.getItem('history_' + tId) || '[]');
        hist.forEach(i => { countMap[i.name] = (countMap[i.name] || 0) + i.qty; });
    });
    // window.getSalesData('dow') ã§å…¨salesã‚’å–å¾—ï¼ˆæ—¢å­˜ã®dbæ¥ç¶šã‚’å†åˆ©ç”¨ï¼‰
    try {
        const allSales = await window.getSalesData('dow');
        allSales.forEach(s => {
            (s.items || []).forEach(i => { countMap[i.name] = (countMap[i.name] || 0) + i.qty; });
        });
    } catch(e) { console.warn("salesé›†è¨ˆã‚¨ãƒ©ãƒ¼:", e); }

    const sorted = Object.entries(countMap).sort((a, b) => b[1] - a[1]).slice(0, 15);
    if (sorted.length === 0) return;
    const popularItems = sorted.map(([name, cnt]) => {
        const found = allCat.items.find(x => x.n === name);
        return found ? { n: found.n, p: found.p, _cnt: cnt } : null;
    }).filter(Boolean);
    const existIdx = menuData.findIndex(x => x.cat === 'ğŸ”¥ äººæ°—TOP15');
    const newCat = { cat: 'ğŸ”¥ äººæ°—TOP15', items: popularItems };
    if (existIdx >= 0) menuData[existIdx] = newCat; else menuData.splice(1, 0, newCat);
    renderSidebar();
    renderItems(menuData[0]);
}
// â–²â–²â–² äººæ°—ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ©Ÿèƒ½è¿½åŠ  â–²â–²â–²
const tablesL = ['C-a', 'C-b', 'C-c', '01', '02', '03', '04', '05', '06', '07', 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ', 'ç„¡äºº'];
let currentTable = "", currentCart = [], tempGuestCount = "0";
const PRINTER_URL = 'http://192.168.1.XX/StarWebPRNT/SendMessage';
const isTestMode = true;

function hideAll() { document.querySelectorAll('.view').forEach(v => v.style.display = 'none'); }
function renderIndex() { const g = document.getElementById('table-grid'); if(!g) return; g.innerHTML = tablesL.map(t => { const h = JSON.parse(localStorage.getItem('history_'+t) || '[]'); const total = h.reduce((s, i) => s + Math.floor(i.price*i.qty*(1+i.rate)), 0); return `<div class="table-btn ${total>0?'occupied':''}" onclick="onTableClick('${t}')"><b>${t}</b><span class="price-badge">${total>0?'Â¥'+total.toLocaleString():'ç©ºå¸­'}</span></div>`; }).join(''); }
function showIndex() { window.isEditing = false; hideAll(); document.getElementById('view-index').style.display = 'flex'; renderIndex(); }
function checkAdminAuth() { if(window.currentUser) showAdmin('day'); else { hideAll(); document.getElementById('view-login').style.display = 'flex'; } }
function handleLogin() { window.loginOwner(document.getElementById('login-email').value, document.getElementById('login-pass').value); }
function onTableClick(tId) { currentTable = tId; if(localStorage.getItem('history_' + tId)) showMenu(); else showGuestInput(); }

async function showAdmin(mode) {
    window.showAdmin = showAdmin;
    hideAll(); document.getElementById('view-admin').style.display = 'flex';
    document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));
    const navId = mode==='month'?'month':mode==='dow'?'dow':mode==='dates'?'dates':'day';
    const navEl = document.getElementById('nav-' + navId);
    if(navEl) navEl.classList.add('active');
    const list = document.getElementById('sales-list'); list.innerHTML = '<p style="text-align:center; padding:50px;">é›†è¨ˆä¸­...</p>';
    try {
        const sales = await window.getSalesData(mode);
        let total = 0, guests = 0;
        if (mode === 'day') {
            list.innerHTML = sales.map(s => {
                total += s.total; guests += s.guests;
                return `<div class="sale-card"><div class="sale-time-row"><span class="sale-time">${s.checkout}</span><span class="sale-table-badge">${s.tableId}ç•ª</span></div><div class="sale-detail-info">å®¢: ${s.guests}å / å…¥åº—: ${s.checkin}</div><div class="sale-total-line"><span class="sale-price-big">Â¥${s.total.toLocaleString()}</span><button class="btn-del-sale" onclick="deleteSaleDoc('${s.id}')">å‰Šé™¤</button></div></div>`;
            }).join('') || '<p style="text-align:center; padding:50px;">æœ¬æ—¥ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
        } else if (mode === 'dates') {
            // æ—¥åˆ¥ã‚°ãƒ«ãƒ¼ãƒ—é›†è¨ˆ
            const dayMap = {};
            sales.forEach(s => {
                const d = s.timestamp.toDate();
                const key = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
                const dow = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];
                if(!dayMap[key]) dayMap[key] = { label: `${key}ï¼ˆ${dow}ï¼‰`, t: 0, c: 0, g: 0, ts: d.getTime(), ids: [] };
                dayMap[key].t += s.total; dayMap[key].c++; dayMap[key].g += s.guests; dayMap[key].ids.push(s.id);
                total += s.total; guests += s.guests;
            });
            window._dayDeleteMap = dayMap;
            const sorted = Object.values(dayMap).sort((a,b) => b.ts - a.ts);
            list.innerHTML = sorted.map((s, i) => `<div class="sale-card"><div class="sale-time-row"><span class="sale-time" style="font-size:15px;">${s.label}</span></div><div class="sale-detail-info">ä»¶æ•°: ${s.c} / å®¢æ•°: ${s.g}å</div><div class="sale-total-line"><span class="sale-price-big">Â¥${s.t.toLocaleString()}</span><button class="btn-del-sale" onclick="deleteDaySales('${s.label}')">å‰Šé™¤</button></div></div>`).join('') || '<p style="text-align:center; padding:50px;">ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
        } else if (mode === 'dow') {
            const labels = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
            let stats = [0,1,2,3,4,5,6].map(i=>({l:labels[i], t:0, c:0, g:0}));
            sales.forEach(s => { const dow = s.timestamp.toDate().getDay(); stats[dow].t += s.total; stats[dow].c++; stats[dow].g += s.guests; total += s.total; guests += s.guests; });
            list.innerHTML = stats.map(s => `<div class="sale-card"><div class="sale-time-row"><span class="sale-time">${s.l}æ›œæ—¥</span></div><div class="sale-detail-info">ä»¶æ•°: ${s.c} / å®¢æ•°: ${s.g}</div><div class="sale-total-line"><span class="sale-price-big">Â¥${s.t.toLocaleString()}</span></div></div>`).join('');
        } else if (mode === 'month') {
            let mStats = Array(12).fill(0).map((_,i)=>({l:(i+1)+'æœˆ', t:0, c:0, g:0}));
            sales.forEach(s => { const m = s.timestamp.toDate().getMonth(); mStats[m].t += s.total; mStats[m].c++; mStats[m].g += s.guests; total += s.total; guests += s.guests; });
            list.innerHTML = mStats.filter(s=>s.c>0).reverse().map(s => `<div class="sale-card"><div class="sale-time-row"><span class="sale-time">${s.l}</span></div><div class="sale-detail-info">ä»¶æ•°: ${s.c} / å®¢æ•°: ${s.g}</div><div class="sale-total-line"><span class="sale-price-big">Â¥${s.t.toLocaleString()}</span></div></div>`).join('');
        }
        document.getElementById('sum-total').innerText = total.toLocaleString();
        document.getElementById('sum-guests').innerText = guests;
        document.getElementById('sum-count').innerText = sales.length;
    } catch(e) { list.innerHTML = `<p style="color:red; padding:20px;">ã‚¨ãƒ©ãƒ¼: ${e.message}</p>`; }
}

async function printReport(mode) {
    const sales = await window.getSalesData(mode); if(sales.length === 0) return alert("ãƒ‡ãƒ¼ã‚¿ãªã—");
    let total = 0, guests = 0; sales.forEach(s => total += s.total);
    const b = new StarWebPrintBuilder(); let r = b.createInitializationElement();
    r += b.createAlignmentElement({position: 'center'}); r += b.createTextElement({data: `ç¾å”„ç„¼é³¥ä¸‰èˆ¹ æ±æœ­å¹Œåº—\nã€${mode==='day'?'æ—¥è¨ˆ':'æœˆè¨ˆ'}ã€‘\n`, width:2, height:2});
    r += b.createAlignmentElement({position: 'left'}); r += b.createTextElement({data: `--------------------------------\nå£²ä¸Š: Â¥${total.toLocaleString()}\nå®¢æ•°: ${guests}å\nä»¶æ•°: ${sales.length}ä»¶\n--------------------------------\n`});
    r += b.createCutPaperElement({type: 'partial'});
    const t = new StarWebPrintTrader({url: PRINTER_URL}); t.sendMessage({request: r}); alert("å°åˆ·ã—ã¾ã—ãŸ");
}

function showGuestInput() { hideAll(); tempGuestCount = "0"; document.getElementById('guest-table-name').innerText = currentTable + "ç•ªå¸­"; document.getElementById('guest-count-val').innerText = tempGuestCount; document.getElementById('view-guest').style.display = 'flex'; const k = document.getElementById('guest-keypad'); k.innerHTML = [1,2,3,4,5,6,7,8,9,'C',0,'æ±ºå®š'].map(num => { let s = num === 'æ±ºå®š' ? 'background:var(--accent); color:#fff;' : ''; let f = num === 'æ±ºå®š' ? 'confirmGuestCount()' : (num === 'C' ? 'clearGuestNum()' : `inputGuestNum(${num})`); return `<button class="key-btn" style="${s}" onclick="${f}">${num}</button>`; }).join(''); }
function inputGuestNum(n) { if(tempGuestCount === "0") tempGuestCount = n.toString(); else if(tempGuestCount.length < 2) tempGuestCount += n.toString(); document.getElementById('guest-count-val').innerText = tempGuestCount; }
function clearGuestNum() { tempGuestCount = "0"; document.getElementById('guest-count-val').innerText = tempGuestCount; }
async function confirmGuestCount() { let c = parseInt(tempGuestCount); if(c < 1) return alert("äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); localStorage.setItem('guests_' + currentTable, c); const now = new Date(); localStorage.setItem('checkin_' + currentTable, now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0')); if(window.cloudSync) await window.cloudSync(currentTable); showMenu(); }
function showMenu() { window.isEditing = false; currentCart = JSON.parse(localStorage.getItem('cart_'+currentTable) || '[]'); hideAll(); document.getElementById('view-menu').style.display = 'flex'; document.getElementById('display-table-id').innerText = currentTable; document.getElementById('display-guest-count').innerText = localStorage.getItem('guests_' + currentTable) || "0"; document.getElementById('display-checkin-time').innerText = localStorage.getItem('checkin_' + currentTable) || "--:--"; renderSidebar(); renderItems(menuData[0]); updateFooter(); buildPopularCategory(); }
function renderSidebar() { const side = document.getElementById('side-cats'); side.innerHTML = menuData.map((d, idx) => `<div class="cat" onclick="changeCat(this, ${idx})">${d.cat}</div>`).join(''); side.children[0].classList.add('active'); }
function changeCat(el, idx) { document.querySelectorAll('.cat').forEach(c => c.classList.remove('active')); el.classList.add('active'); renderItems(menuData[idx]); }
function renderItems(category) { const container = document.getElementById('display-items'); container.innerHTML = category.items.map((item, idx) => { const rate = (category.cat === "ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ" || category.cat === "ç„¡äºº" || item.c === "ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ" || item.c === "ç„¡äºº") ? 0.08 : 0.10; const taxInc = Math.floor(item.p * (1 + rate)); return `<div class="item-card"><div class="item-info"><span class="item-name">${item.n}</span><span class="item-price">Â¥${item.p.toLocaleString()} <small style="font-size:10px; color:#999;">(ç¨è¾¼Â¥${taxInc.toLocaleString()})</small></span></div><div class="qty-ctrl"><div class="btn-circle" onclick="changeQty('q${idx}', -1)">-</div><span id="q${idx}" style="font-weight:bold; min-width:18px; text-align:center;">1</span><div class="btn-circle" onclick="changeQty('q${idx}', 1)">+</div><button class="btn-add" onclick="addToCart('${item.n}', ${item.p}, 'q${idx}', ${rate})">è¿½åŠ </button></div></div>`; }).join(''); }
function changeQty(id, d) { const el = document.getElementById(id); let v = parseInt(el.innerText) + d; if(v >= 1) el.innerText = v; }
function addToCart(name, price, qId, rate) { const qty = parseInt(document.getElementById(qId).innerText); const exist = currentCart.find(i => i.name === name); if(exist) exist.qty += qty; else currentCart.push({name, price, qty, rate}); localStorage.setItem('cart_'+currentTable, JSON.stringify(currentCart)); updateFooter(); document.getElementById(qId).innerText = 1; }
function changeCartQty(idx, delta) { currentCart[idx].qty += delta; if(currentCart[idx].qty < 1) currentCart[idx].qty = 1; localStorage.setItem('cart_'+currentTable, JSON.stringify(currentCart)); renderCartUI(); updateFooter(); }
function removeFromCart(idx) { currentCart.splice(idx, 1); localStorage.setItem('cart_'+currentTable, JSON.stringify(currentCart)); renderCartUI(); updateFooter(); }
function renderCartUI() { document.getElementById('cart-items-list').innerHTML = currentCart.map((i, idx) => `<div class="list-row"><div style="flex:1;"><b>${i.name}</b><br><small>Â¥${i.price.toLocaleString()} x ${i.qty}</small></div><div style="display:flex; align-items:center; gap:8px;"><div class="btn-circle" onclick="changeCartQty(${idx}, -1)">-</div><span style="font-weight:bold;">${i.qty}</span><div class="btn-circle" onclick="changeCartQty(${idx}, 1)">+</div><button class="btn-del" onclick="removeFromCart(${idx})" style="color:red; background:none; border:none;">å‰Šé™¤</button></div></div>`).join('') || '<p style="text-align:center;padding:50px;color:#999;">ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™</p>'; }
function showCart() { window.isEditing = true; hideAll(); document.getElementById('view-cart').style.display = 'flex'; renderCartUI(); }
function changeHistoryQty(idx, delta) { const hist = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]'); hist[idx].qty += delta; if(hist[idx].qty <= 0) { if(!confirm("å‰Šé™¤ï¼Ÿ")) return; hist.splice(idx, 1); } localStorage.setItem('history_'+currentTable, JSON.stringify(hist)); renderHistoryUI(); }
function renderHistoryUI() { const hist = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]'); let sub = 0, tax = 0; document.getElementById('history-items-list').innerHTML = hist.map((i, idx) => { const lp = i.price * i.qty; const lt = Math.floor(lp * i.rate); sub += lp; tax += lt; return `<div class="list-row"><div><b>${i.name}</b><br><small>ç¨è¾¼Â¥${(lp+lt).toLocaleString()}</small></div><div style="display:flex; align-items:center; gap:10px;"><div class="btn-circle" onclick="changeHistoryQty(${idx}, -1)">-</div><span style="font-weight:bold;">${i.qty}</span><div class="btn-circle" onclick="changeHistoryQty(${idx}, 1)">+</div></div></div>`; }).join('') || 'ãªã—'; document.getElementById('history-summary').innerHTML = `<div style="color:#666; font-size:13px;">å…¥åº—: ${localStorage.getItem('checkin_'+currentTable)} / å®¢: ${localStorage.getItem('guests_'+currentTable)}å</div><div>ç¨è¾¼è¨ˆ: <b style="font-size:24px; color:var(--primary);">Â¥${(sub + tax).toLocaleString()}</b></div>`; }
async function confirmHistoryChange() { if(window.cloudSync) await window.cloudSync(currentTable); alert("åŒæœŸå®Œäº†"); }
function exitEditing() { window.isEditing = false; showMenu(); }
function showOrderHistory() { window.isEditing = true; hideAll(); document.getElementById('view-history').style.display = 'flex'; renderHistoryUI(); }
function showCheckout() { const hist = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]'); const total = hist.reduce((s, i) => s + Math.floor(i.price*i.qty*(1+i.rate)), 0); document.getElementById('checkout-final-total').innerText = "Â¥" + total.toLocaleString(); document.getElementById('checkout-final-info').innerText = `å…¥åº— ${localStorage.getItem('checkin_'+currentTable)} / å®¢ ${localStorage.getItem('guests_'+currentTable)}å`; hideAll(); document.getElementById('view-checkout').style.display = 'flex'; }
function updateFooter() { document.getElementById('cart-count').innerText = currentCart.reduce((s, i) => s + i.qty, 0); const hist = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]'); const total = hist.reduce((s, i) => s + Math.floor(i.price*i.qty*(1+i.rate)), 0); document.getElementById('display-current-total').innerText = "ç¨è¾¼åˆè¨ˆ: Â¥" + total.toLocaleString(); }
function openReceiptChoice() { if (isTestMode) { document.getElementById('receipt-preview-area').style.display = 'block'; renderReceiptSample(); } document.getElementById('overlay-receipt').style.display = 'flex'; }
function renderReceiptSample() {
const h = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]'); const g = localStorage.getItem('guests_'+currentTable) || 0; const c = localStorage.getItem('checkin_'+currentTable) || "--:--"; let sub = 0, tx = 0;
let t = `<div class="text-center text-bold">ç¾å”„ç„¼é³¥ä¸‰èˆ¹ æ±æœ­å¹Œåº—</div><div class="text-center">æœ­å¹Œå¸‚ç™½çŸ³åŒºæ±æœ­å¹Œ2æ¡3ä¸ç›®9-2</div><div class="receipt-hr"></div><div>æ—¥æ™‚: ${new Date().toLocaleString()}</div><div>å¸­: ${currentTable} å®¢: ${g}å å…¥åº—: ${c}</div><div class="receipt-hr"></div>`;
h.forEach(i => { const l = i.price*i.qty; sub += l; tx += Math.floor(l * i.rate); t += `<div>${i.name}</div><div style="display:flex; justify-content:space-between;"><span>&nbsp;${i.qty}ç‚¹ x Â¥${i.price.toLocaleString()}</span><span>Â¥${l.toLocaleString()}</span></div>`; });
t += `<div class="receipt-hr"></div><div class="text-right text-bold">ç¨è¾¼åˆè¨ˆ: Â¥${(sub+tx).toLocaleString()}</div><div class="receipt-hr"></div><div class="text-center">[ç™»éŒ²ç•ªå·] T4430001061003</div>`;
document.getElementById('sample-receipt-content').innerHTML = t;
}
function closeReceiptChoice() { document.getElementById('overlay-receipt').style.display = 'none'; }
async function testSend() { if(currentCart.length === 0) return alert("ç©ºã§ã™"); const hist = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]'); localStorage.setItem('history_'+currentTable, JSON.stringify(hist.concat(currentCart))); localStorage.removeItem('cart_'+currentTable); currentCart = []; if(window.cloudSync) await window.cloudSync(currentTable); hideAll(); document.getElementById('view-success').style.display = 'flex'; updateFooter(); }
async function testPay() { if(window.saveSaleToCloud) await window.saveSaleToCloud(currentTable); showIndex(); }

async function sendToKitchen() {
if(currentCart.length === 0) return;
const b = new StarWebPrintBuilder(); let r = ""; const c = localStorage.getItem('checkin_'+currentTable) || "--:--";
currentCart.forEach(item => {
r += b.createInitializationElement(); r += b.createAlignmentElement({position: 'left'});
const itemLine = `[${currentTable}] ${item.name} ${item.qty}\n`;
r += b.createTextElement({ data: itemLine, width: 2, height: 2 });
r += b.createTextElement({data: `--------------------------\n`});
r += b.createTextElement({data: `${new Date().toLocaleTimeString()} (å…¥åº—:${c})\n`});
r += b.createCutPaperElement({type: 'partial'});
});
const t = new StarWebPrintTrader({url: PRINTER_URL});
t.onReceive = async () => {
const hist = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]');
localStorage.setItem('history_'+currentTable, JSON.stringify(hist.concat(currentCart)));
localStorage.removeItem('cart_'+currentTable); currentCart = [];
if(window.cloudSync) await window.cloudSync(currentTable);
hideAll(); document.getElementById('view-success').style.display = 'flex'; updateFooter();
};
t.sendMessage({request: r});
}

async function pay(doPrint) {
closeReceiptChoice(); const hist = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]'); const g = localStorage.getItem('guests_'+currentTable); const c = localStorage.getItem('checkin_'+currentTable);
const b = new StarWebPrintBuilder(); let r = b.createInitializationElement(); r += b.createPeripheralElement({channel: 1, pulse: 200});
if(doPrint) {
let sub = 0, tx = 0; r += b.createAlignmentElement({position: 'center'}); r += b.createTextElement({data: `ç¾å”„ç„¼é³¥ä¸‰èˆ¹ æ±æœ­å¹Œåº—\n`, width: 2, height: 2}); r += b.createTextElement({data: `æœ­å¹Œå¸‚ç™½çŸ³åŒºæ±æœ­å¹Œ2æ¡3ä¸ç›®9-2\n\n`}); r += b.createAlignmentElement({position: 'left'});
r += b.createTextElement({data: `æ—¥æ™‚: ${new Date().toLocaleString()}\nå¸­: ${currentTable} å®¢: ${g}å å…¥åº—: ${c}\n--------------------------------\n`});
hist.forEach(i => { const l = i.price*i.qty; sub += l; tx += Math.floor(l * i.rate); r += b.createTextElement({data: `${i.name}\n  ${i.qty}ç‚¹ x Â¥${i.price}    Â¥${l}\n`}); });
r += b.createTextElement({data: `--------------------------------\n`}); r += b.createAlignmentElement({position: 'right'}); r += b.createTextElement({data: `ç¨è¾¼åˆè¨ˆ: Â¥${(sub + tx).toLocaleString()}\n`, width: 2, height: 2});
r += b.createAlignmentElement({position: 'center'}); r += b.createTextElement({data: `\n[ç™»éŒ²ç•ªå·] T4430001061003\næ ªå¼ä¼šç¤¾Stag Beetle Corporation\n\n`}); r += b.createCutPaperElement({type: 'partial'});
}
const t = new StarWebPrintTrader({url: PRINTER_URL}); t.onReceive = async () => { if(window.saveSaleToCloud) await window.saveSaleToCloud(currentTable); showIndex(); }; t.sendMessage({request: r});
}

// â–¼â–¼â–¼ é ˜åæ›¸æ©Ÿèƒ½è¿½åŠ  â–¼â–¼â–¼

function openRyoshuusho() {
    document.getElementById('ryoshuusho-atena').value = '';
    document.getElementById('ryoshuusho-tadashi').value = 'ãŠé£Ÿäº‹ä»£ã¨ã—ã¦';
    updateRyoshuushoPreview();
    document.getElementById('overlay-ryoshuusho').style.display = 'flex';
}

function closeRyoshuusho() {
    document.getElementById('overlay-ryoshuusho').style.display = 'none';
}

function getRyoshuushoTotal() {
    const hist = JSON.parse(localStorage.getItem('history_'+currentTable) || '[]');
    let sub = 0, tax = 0;
    hist.forEach(i => { sub += i.price * i.qty; tax += Math.floor(i.price * i.qty * i.rate); });
    return { sub, tax, total: sub + tax };
}

function updateRyoshuushoPreview() {
    const atena = document.getElementById('ryoshuusho-atena').value || 'ä¸Šæ§˜';
    const tadashi = document.getElementById('ryoshuusho-tadashi').value || 'ãŠé£Ÿäº‹ä»£ã¨ã—ã¦';
    const { sub, tax, total } = getRyoshuushoTotal();
    const now = new Date();
    const dateStr = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥`;

    document.getElementById('ryoshuusho-preview').innerHTML =
        `<div style="text-align:center; font-weight:bold; font-size:14px; margin-bottom:6px;">é ˜ã€€åã€€æ›¸</div>` +
        `<div style="border-bottom:1px solid #000; padding-bottom:4px; margin-bottom:6px; font-size:13px;">${atena} å¾¡ä¸­</div>` +
        `<div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:8px;"><span>é‡‘é¡</span><span style="font-weight:bold; font-size:16px;">Â¥${total.toLocaleString()}âˆ’</span></div>` +
        `<div style="font-size:11px; color:#555; margin-bottom:4px;">ä½†ã—ã€€${tadashi}</div>` +
        `<div style="font-size:11px; color:#555; margin-bottom:8px;">ä¸Šè¨˜æ­£ã«é ˜åã„ãŸã—ã¾ã—ãŸ</div>` +
        `<div style="font-size:11px; color:#555; margin-bottom:6px;">${dateStr}</div>` +
        `<div style="border-top:1px dashed #999; padding-top:6px; font-size:10px; color:#888;">ï¼ˆå†…è¨³ï¼‰ç¨æŠœ: Â¥${sub.toLocaleString()} / æ¶ˆè²»ç¨: Â¥${tax.toLocaleString()}</div>` +
        `<div style="font-size:11px; text-align:right; margin-top:6px;">ç¾å”„ç„¼é³¥ä¸‰èˆ¹ æ±æœ­å¹Œåº—<br>ç™»éŒ²ç•ªå· T4430001061003</div>`;
}

function printRyoshuusho() {
    const atena = document.getElementById('ryoshuusho-atena').value || 'ä¸Šæ§˜';
    const tadashi = document.getElementById('ryoshuusho-tadashi').value || 'ãŠé£Ÿäº‹ä»£ã¨ã—ã¦';
    const { sub, tax, total } = getRyoshuushoTotal();
    const now = new Date();
    const dateStr = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥`;

    const b = new StarWebPrintBuilder(); let r = b.createInitializationElement();
    r += b.createAlignmentElement({position: 'center'});
    r += b.createTextElement({data: `é ˜ã€€åã€€æ›¸\n`, width: 2, height: 2});
    r += b.createAlignmentElement({position: 'left'});
    r += b.createTextElement({data: `--------------------------------\n`});
    r += b.createTextElement({data: `${atena} å¾¡ä¸­\n\n`});
    r += b.createTextElement({data: `é‡‘é¡:`, width: 1, height: 1});
    r += b.createAlignmentElement({position: 'right'});
    r += b.createTextElement({data: `Â¥${total.toLocaleString()}-\n`, width: 2, height: 2});
    r += b.createAlignmentElement({position: 'left'});
    r += b.createTextElement({data: `\nä½†ã—ã€€${tadashi}\n`});
    r += b.createTextElement({data: `ä¸Šè¨˜æ­£ã«é ˜åã„ãŸã—ã¾ã—ãŸ\n`});
    r += b.createTextElement({data: `${dateStr}\n`});
    r += b.createTextElement({data: `--------------------------------\n`});
    r += b.createTextElement({data: `ï¼ˆå†…è¨³ï¼‰\nç¨æŠœåˆè¨ˆ: Â¥${sub.toLocaleString()}\næ¶ˆè²»ç¨:   Â¥${tax.toLocaleString()}\n`});
    r += b.createTextElement({data: `--------------------------------\n`});
    r += b.createAlignmentElement({position: 'center'});
    r += b.createTextElement({data: `ç¾å”„ç„¼é³¥ä¸‰èˆ¹ æ±æœ­å¹Œåº—\næœ­å¹Œå¸‚ç™½çŸ³åŒºæ±æœ­å¹Œ2æ¡3ä¸ç›®9-2\nç™»éŒ²ç•ªå· T4430001061003\n\n`});
    r += b.createCutPaperElement({type: 'partial'});

    const t = new StarWebPrintTrader({url: PRINTER_URL});
    t.onReceive = () => { closeRyoshuusho(); alert("é ˜åæ›¸ã‚’å°åˆ·ã—ã¾ã—ãŸ"); };
    t.onError = () => { alert("ãƒ—ãƒªãƒ³ã‚¿ãƒ¼æ¥ç¶šã‚¨ãƒ©ãƒ¼"); };
    t.sendMessage({request: r});
}

// å®›åãƒ»ä½†ã—æ›¸ãå¤‰æ›´æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('ryoshuusho-atena').addEventListener('input', updateRyoshuushoPreview);
    document.getElementById('ryoshuusho-tadashi').addEventListener('input', updateRyoshuushoPreview);
});

// â–²â–²â–² é ˜åæ›¸æ©Ÿèƒ½è¿½åŠ  â–²â–²â–²

window.onload = () => { renderIndex(); };
</script>
</body>
</html>
